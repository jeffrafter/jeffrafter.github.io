---
title: Next
date: '2019-04-23T00:01:00'
published: false
slug: next
layout: post
tags: ['javascript', 'typescript', 'node']
category: Web
---

"Look at all the things I'm not doing" [^dhh]

[^dhh]:

  David Heinemeier Hansson said this in his famous Rails demo in 2005. Rails is easy.
  It's one of those things that is easy if you write thousands of lines of code; remember dozens
  of incantations and work from a series of templates andf generators that do all of the work for
  you-- then have someone else deploy and maintain it. Just like Next.js

Our plan is to build a website using [Next.js](https://nextjs.org/learn/basics/getting-started). Out
of the box, Next.js is built on top of Express. It supports server side rendering, hot module
reloading, React and more.

We'll add TypeScript, Styled Components, Sessions, Authentication with GitHub, some basic security
and a whole lot more.

# Getting started

```bash
mkdir template
cd template
npm init -y
```

Now you have a `package.json`. Let's simplify it a bit:

```json
{
  "private": true,
  "scripts": {
    "dev": "next",
    "build": "next build",
    "start": "next start"
  }
}
```

Now let's add the basic packages:

```bash
npm install --save next react react-dom
```

This is the basic setup for our application, but we want to actually setup folders and defaults for Typescript.

```bash
mkdir client
mkdir server
mkdir server/pages
mkdir test
```

## `.nvmrc`

If you have multiple local projects you might run into a conflict about which Node version should be used. Node Version Manager solves this problem. To control which version of Node should be used in your project, add an `.nvmrc`:

```json
10.13.0
```

## `.gitignore`

```
# =========================
# Next.js-Specific Ignores
# =========================
.next
dist
log

# =========================
# Node.js-Specific Ignores
# =========================

# Build directory
public/

# Gatsby cache
.cache/

# Logs
logs
*.log
npm-debug.log*
yarn-debug.log*
yarn-error.log*

# Runtime data
pids
*.pid
*.seed
*.pid.lock

# Directory for instrumented libs generated by jscoverage/JSCover
lib-cov

# Coverage directory used by tools like istanbul
coverage

# nyc test coverage
.nyc_output

# Grunt intermediate storage (http://gruntjs.com/creating-plugins#storing-task-files)
.grunt

# Bower dependency directory (https://bower.io/)
bower_components

# node-waf configuration
.lock-wscript

# Compiled binary addons (http://nodejs.org/api/addons.html)
build/Release

# Dependency directories
node_modules/
jspm_packages/

# Typescript v1 declaration files
typings/

# Optional npm cache directory
.npm

# Optional eslint cache
.eslintcache

# Optional REPL history
.node_repl_history

# Output of 'npm pack'
*.tgz

# Yarn Integrity file
.yarn-integrity

# dotenv environment variables file
.env

# =========================
# Operating System Files
# =========================

# OSX
# =========================

.DS_Store
.AppleDouble
.LSOverride

# Thumbnails
._*

# Files that might appear on external disk
.Spotlight-V100
.Trashes

# Directories potentially created on remote AFP share
.AppleDB
.AppleDesktop
Network Trash Folder
Temporary Items
.apdisk

# Windows
# =========================

# Windows image file caches
Thumbs.db
ehthumbs.db

# Folder config file
Desktop.ini

# Recycle Bin used on file shares
$RECYCLE.BIN/

# Windows Installer files
*.cab
*.msi
*.msm
*.msp

# Windows shortcuts
*.lnk
```

## nodemon.json

```json
{
  "watch": ["server"],
  "exec": "ts-node --project server/tsconfig.json --files server/server.ts",
  "ext": "js json ts tsx"
}
```

## `.vscode`

**Optional**

If you are using VSCode, it is useful to make sure all of the developers have a consistent experience. To do that you can keep a `.vscode` folder with the default settings:

Create the folder:

```bash
mkdir .vscode
```

And make `settings.json`

```json
{
  "editor.tabSize": 2,
  "editor.insertSpaces": true,
  "editor.renderWhitespace": "boundary",
  "editor.rulers": [100],
  "editor.formatOnSave": true,
  "files.encoding": "utf8",
  "files.trimTrailingWhitespace": true,
  "files.insertFinalNewline": true,
  "prettier.eslintIntegration": true,
  "prettier.requireConfig": false,
  "typescript.tsdk": "node_modules/typescript/lib",
  "search.exclude": {
    "public/**": true,
    "node_modules/**": true
  }
}
```

## `.editorconfig`

You might not be using VSCode. In that case you might want to opt for the more generic `.editorconfig` file (based on the format from https://editorconfig.org):

```
root = true

[*]
indent_style = space
indent_size = 2
charset = utf-8
trim_trailing_whitespace = true
insert_final_newline = true
```

## `.babelrc`

Because we want to use TypeScript, we'll need to run the code through Babel on build to create compatible JavaScript. Create a `.babelrc` file:

```json
{
  "presets": ["next/babel", "@zeit/next-typescript/babel"],
  "plugins": [["styled-components"]],
  "env": {
    "test": {
      "presets": [
        ["next/babel", {"preset-env": {"modules": "commonjs"}}],
        "@zeit/next-typescript/babel"
      ]
    }
  }
}
```

## `.prettierrc`

If you aren't using eslint then you are likely using prettier. It is pretty safe to choose one or the other. If you choose prettier add a `.prettierrc` file:

```json
{
  "tabWidth": 2,
  "singleQuote": true,
  "trailingComma": "all",
  "bracketSpacing": false,
  "jsxBracketSameLine": true,
  "printWidth": 100,
  "semi": false
}
```

## `eslint`

In general, eslint will be more powerful than prettier (though often overkill) -- offering lots of plugins and rules. If you use eslint, add an `eslintrc.json`:

```json
{
  "parser": "@typescript-eslint/parser",
  "plugins": ["prettier"],
  "extends": ["prettier"],
  "rules": {
    "prettier/prettier": [
      "error",
      {
        "singleQuote": true,
        "trailingComma": "all",
        "bracketSpacing": false,
        "jsxBracketSameLine": true,
        "printWidth": 100,
        "semi": false
      }
    ]
  },
  "parserOptions": {
    "ecmaVersion": 7,
    "sourceType": "module",
    "ecmaFeatures": {
      "jsx": true
    }
  }
}
```

Additionally if you'll want to ignore certain files for performance reasons, add a `.eslintignore`.

## `tsconfig.json`

From gatsby:

```json
{
  "compilerOptions": {
    "module": "commonjs",
    "target": "esnext",
    "jsx": "preserve",
    "lib": ["dom", "es2015", "es2017"],
    "strict": true,
    "noEmit": true,
    "isolatedModules": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "removeComments": false,
    "preserveConstEnums": true
  },
  "include": ["./src/**/*"]
}
```

From a next project (server/tsconfig.js:

```js
{
  "compileOnSave": false,
  "compilerOptions": {
    "target": "esnext",
    "module": "commonjs",
    "jsx": "preserve",
    "allowJs": true,
    "moduleResolution": "node",
    "allowSyntheticDefaultImports": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "removeComments": false,
    "preserveConstEnums": true,
    "sourceMap": true,
    "skipLibCheck": true,
    "strict": true,
    "outDir": "../dist",
    "lib": ["dom", "es2015", "es2016", "es2017.object"],
    "typeRoots": ["../node_modules/@types", "../client/shared/typings"]
  }
}
```

## `tslint.json`

```json
{
  "rulesDirectory": ["tslint-plugin-prettier"],
  "extends": ["tslint-config-blvd/react", "tslint-config-prettier"],
  "rules": {
    "prettier": true
  }
}
```

## Configure next with `next.config.js`

From the example ():

```js
const withTypescript = require('@zeit/next-typescript')
module.exports = withTypescript()
```

From gist-playground

```js
const withTypescript = require('@zeit/next-typescript')

module.exports = withTypescript({
  webpack: config => {
    config.devtool = 'source-map'

    for (const plugin of config.plugins) {
      if (plugin.constructor.name === 'UglifyJsPlugin') {
        plugin.options.sourceMap = true
        break
      }
    }

    if (config.optimization && config.optimization.minimizer) {
      for (const plugin of config.optimization.minimizer) {
        if (plugin.constructor.name === 'TerserPlugin') {
          plugin.options.sourceMap = true
          break
        }
      }
    }

    return config
  },
  useFileSystemPublicRoutes: false,
  pageExtensions: ['jsx', 'js', 'ts', 'tsx'],
})
```

## Testing with `jest.config.js`

```js
module.exports = {
  roots: ['<rootDir>/client', '<rootDir>/server'],
  setupTestFrameworkScriptFile: require.resolve('./test/setup.js'),
  testPathIgnorePatterns: ['/node_modules/', '/.next/'],
  testMatch: ['**/__tests__/**/*.test.(js|ts)?(x)'],
  transform: {'^.+\\.(jsx?|tsx?)$': 'babel-jest'},
  moduleFileExtensions: ['ts', 'tsx', 'js', 'jsx', 'json'],
  testURL: 'http://localhost/',
}
```

.env
.env.test
