{"componentChunkName":"component---src-templates-post-tsx","path":"/docker-and-cups-pdf/","result":{"data":{"site":{"siteMetadata":{"title":"Jeff Rafter"}},"markdownRemark":{"id":"216faf0c-7c14-56b9-9bde-71f61a241748","excerpt":"Just use docker, they said. It will be easy, they said. I’ve been trying to get my iPad to print to a PDF for a while now. I’ve used PDFWriter but I wasn’t able to print from an iOS simulator on my localhost. Realized that I could use CUPS-PDF to print to a PDF and then use Avahi to broadcast it as an AirPrint printer and that this might help me workaround the DNS rebinding protection built into CUPS. Spoiler: it didn’t. But this was a fun little project and I learned a lot about Docker, CUPS-PDF and Avahi. Getting started CUPS-PDF is a virtual printer that allows you to print to a PDF. It’s a great way to create PDFs from any application that supports printing. You can use it to create PDFs from web pages, documents, images, etc. It runs in Linux and relies on the CUPS printing system. In our previous article, Printers, Fake Printers, and AirPrint we used the Mac-specific RWTS-PDFWriter as a virtual printer. The setup was simple and it worked well. Unfortunately, RWTS-PDFWriter relies on the underlying system installation of CUPS. Because of this it no longer supports PostScript (as of MacOS Sonoma) and isn’t using the latest version of CUPS based on the OpenPrinting project. Avahi is a zeroconf implementation that allows you to broadcast services on a local network. It’s a great way to discover services on your local network without having to configure DNS or DHCP. It’s used by Apple’s Bonjour protocol to broadcast services like AirPrint. Docker is a containerization platform that allows you to run applications in a consistent environment. It’s a great way to run applications without having to worry about dependencies or conflicts with other applications. On macOS, Docker runs in a hypervisor environment and you can use it to run Linux applications (note, it is not an actual virtual machine). In order to run Docker on macOS, you need to install Docker Desktop. This will install the Docker CLI, Docker Compose and the Docker Engine. You can then use the Docker CLI to run containers, build images and manage your Docker environment. Go to https://www.docker.com/products/docker-desktop/ and download Docker Desktop for Mac.  Setting up the Docker container Docker containers rely on  files. Create a new folder and add a  with the following content: Notice we are expecting a  script. Create a new file called  in the same folder as your  with the following content: This script stops any service that auto-started, starts the CUPS daemon in the background, waits…","html":"<section><figure class=\"fullwidth\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1280px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/4bebf8f1c549ca09cb717d1bb2d3fdb2/de9fe/docker-and-cups-pdf.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 48.4375%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAAB4UlEQVQoz3WST2sTURTF5xu40rV2JVILaZLayUSlGxfqTrBfoHRX3Ev9U5C2qKnSpDOTSSQdKthQMKAo2lUxmygaqBIo2trMTKcJaBf9BD/fm+nkD8HF4d5337wz5957lJTpIqEaAqZDdA5r8uyE0ejGIO/cu926yJWoqEkyYx9V3xexSTrviFr/owB5P0RA6gzcK2qgxmHMOGCs+BetdETqxR9Gsh6JXM/HMlot1KWvAl9EfohmyLfeicKwK0VKlWTXzQY3Zm1uzRaYWd7g6eYOk688kitNUnkPLbeLeq+MemcO9a4tyDxiSzUu5X71K4xlHaYrPkftn+iZBd5Xymy+e8uxt83rHy1GV1wuWwdcnP/I+fsFhh8WBVa5kKkytPiB+JNaR2VAKNu6vX5IufqdB48WmX+cISuIrfUK11Z9xoUSTd9laHmLcy+3OW03OGXvcCb7icSzupi1378UOb+k7jLyfI/4wmdic1tMFapMlhokhDpVd7hacrhp15h5841hu85ZoW5irc5E6TfjeriDaOuKaoSFtJxToYVWbBM32yQNP9i8vA+2LdrS8i5XLOECfY+05fVYyx20TcqMPNYMiCKyfh+6YgQheTSzrgs6Lbv8HxHpyQ/NHqMP5OF3/wBGCxoF7U+4DAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Printer with continuous ink system\"\n        title=\"Printer with continuous ink system\"\n        src=\"/static/4bebf8f1c549ca09cb717d1bb2d3fdb2/21b4d/docker-and-cups-pdf.png\"\n        srcset=\"/static/4bebf8f1c549ca09cb717d1bb2d3fdb2/72799/docker-and-cups-pdf.png 320w,\n/static/4bebf8f1c549ca09cb717d1bb2d3fdb2/6af66/docker-and-cups-pdf.png 640w,\n/static/4bebf8f1c549ca09cb717d1bb2d3fdb2/21b4d/docker-and-cups-pdf.png 1280w,\n/static/4bebf8f1c549ca09cb717d1bb2d3fdb2/29114/docker-and-cups-pdf.png 1920w,\n/static/4bebf8f1c549ca09cb717d1bb2d3fdb2/de9fe/docker-and-cups-pdf.png 2146w\"\n        sizes=\"(max-width: 1280px) 100vw, 1280px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></figure><p>Just use docker, they said. It will be easy, they said.</p><p>I’ve been trying to get my iPad to print to a PDF for a while now. I’ve used PDFWriter but I wasn’t able to print from an iOS simulator on my localhost. Realized that I could use CUPS-PDF to print to a PDF and then use Avahi to broadcast it as an AirPrint printer and that this might help me workaround the DNS rebinding protection built into CUPS.</p><p>Spoiler: it didn’t.</p><p>But this was a fun little project and I learned a lot about Docker, CUPS-PDF and Avahi.</p><h1 id=\"getting-started\" style=\"position:relative;\"><a href=\"#getting-started\" aria-label=\"getting started permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Getting started</h1><p><a href=\"https://www.cups-pdf.de\">CUPS-PDF</a> is a virtual printer that allows you to print to a PDF. It’s a great way to create PDFs from any application that supports printing. You can use it to create PDFs from web pages, documents, images, etc. It runs in Linux and relies on the CUPS printing system.</p><p>In our previous article, <a href=\"./printers\">Printers, Fake Printers, and AirPrint</a> we used the Mac-specific RWTS-PDFWriter as a virtual printer. The setup was simple and it worked well. Unfortunately, RWTS-PDFWriter relies on the underlying system installation of CUPS. Because of this it no longer supports PostScript (as of MacOS Sonoma) and isn’t using the latest version of CUPS based on the <a href=\"https://openprinting.github.io/\">OpenPrinting</a> project.</p><p><a href=\"https://avahi.org\">Avahi</a> is a zeroconf implementation that allows you to broadcast services on a local network. It’s a great way to discover services on your local network without having to configure DNS or DHCP. It’s used by Apple’s Bonjour protocol to broadcast services like AirPrint.</p><p><a href=\"https://www.docker.com\">Docker</a> is a containerization platform that allows you to run applications in a consistent environment. It’s a great way to run applications without having to worry about dependencies or conflicts with other applications. On macOS, Docker runs in a hypervisor environment and you can use it to run Linux applications (note, it is not an actual virtual machine).</p><p>In order to run Docker on macOS, you need to install Docker Desktop. This will install the Docker CLI, Docker Compose and the Docker Engine. You can then use the Docker CLI to run containers, build images and manage your Docker environment.</p><p>Go to <a href=\"https://www.docker.com/products/docker-desktop/\">https://www.docker.com/products/docker-desktop/</a> and download Docker Desktop for Mac.</p></section>\n<section><h2 id=\"setting-up-the-docker-container\" style=\"position:relative;\"><a href=\"#setting-up-the-docker-container\" aria-label=\"setting up the docker container permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Setting up the Docker container</h2><p>Docker containers rely on <code class=\"language-text\">Dockerfile</code> files. Create a new folder and add a <code class=\"language-text\">Dockerfile</code> with the following content:</p><div class=\"gatsby-highlight\" data-language=\"dockerfile\"><pre class=\"language-dockerfile\"><code class=\"language-dockerfile\"><span class=\"token comment\"># Use a base image with necessary dependencies (e.g., Debian)</span>\n<span class=\"token keyword\">FROM</span> debian<span class=\"token punctuation\">:</span>latest\n\n<span class=\"token comment\"># Install required packages (CUPS, CUPS-PDF)</span>\n<span class=\"token keyword\">RUN</span> apt<span class=\"token punctuation\">-</span>get update &amp;&amp; \\\n    apt<span class=\"token punctuation\">-</span>get install <span class=\"token punctuation\">-</span>y \\\n        cups \\\n        printer<span class=\"token punctuation\">-</span>driver<span class=\"token punctuation\">-</span>cups<span class=\"token punctuation\">-</span>pdf \\\n        &amp;&amp; \\\n    apt<span class=\"token punctuation\">-</span>get clean &amp;&amp; \\\n    rm <span class=\"token punctuation\">-</span>rf /var/lib/apt/lists/*\n\n<span class=\"token comment\"># Expose the CUPS port</span>\n<span class=\"token keyword\">EXPOSE</span> 631\n\n<span class=\"token comment\"># Copy printer configuration script</span>\n<span class=\"token keyword\">COPY</span> configure<span class=\"token punctuation\">-</span>printer.sh /usr/local/bin/\n\n<span class=\"token comment\"># Make it executable</span>\n<span class=\"token keyword\">RUN</span> chmod +x /usr/local/bin/configure<span class=\"token punctuation\">-</span>printer.sh\n\n<span class=\"token comment\"># Set entry point</span>\n<span class=\"token keyword\">ENTRYPOINT</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"/usr/local/bin/configure-printer.sh\"</span><span class=\"token punctuation\">]</span></code></pre></div><p>Notice we are expecting a <code class=\"language-text\">configure-printer.sh</code> script. Create a new file called <code class=\"language-text\">configure-printer.sh</code> in the same folder as your <code class=\"language-text\">Dockerfile</code> with the following content:</p><div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token shebang important\">#!/bin/bash</span>\n\n<span class=\"token comment\"># Stop any service that auto-started</span>\n<span class=\"token function\">service</span> cups stop\n\n<span class=\"token comment\"># Start the CUPS daemon in the background</span>\n/usr/sbin/cupsd\n\n<span class=\"token comment\"># Wait for CUPS to start</span>\n<span class=\"token keyword\">until</span> lpstat -H<span class=\"token punctuation\">;</span> <span class=\"token keyword\">do</span>\n  <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"Waiting for CUPS to start...\"</span>\n  <span class=\"token function\">sleep</span> <span class=\"token number\">1</span>\n<span class=\"token keyword\">done</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"CUPS started\"</span>\n\n<span class=\"token comment\"># Share everything</span>\ncupsctl --share-printers --remote-any --remote-admin --user-cancel-any <span class=\"token string\">\"WebInterface=Yes\"</span>\n\n<span class=\"token comment\"># Configure CUPS-PDF</span>\n<span class=\"token function\">mkdir</span> -p /var/spool/cups-pdf/CUPS-PDF\n<span class=\"token function\">chmod</span> <span class=\"token number\">1777</span> /var/spool/cups-pdf/CUPS-PDF\nlpadmin -p CUPS-PDF -E -v cups-pdf:/ -P /usr/share/ppd/cups-pdf/CUPS-PDF_opt.ppd -D <span class=\"token string\">\"CUPS-PDF Printer\"</span> -L <span class=\"token string\">\"PDF Printer\"</span>\n\n<span class=\"token comment\"># Keep container running</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"Printer configured. Container will keep running.\"</span>\n<span class=\"token function\">tail</span> -f /var/log/cups/error_log</code></pre></div><p>This script stops any service that auto-started, starts the CUPS daemon in the background, waits for CUPS to start, shares everything, configures CUPS-PDF and then keeps the container running.</p><p>Now build the Docker image:</p><div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">❯ docker build -t cups-pdf <span class=\"token builtin class-name\">.</span>\n<span class=\"token punctuation\">[</span>+<span class=\"token punctuation\">]</span> Building <span class=\"token number\">0</span>.7s <span class=\"token punctuation\">(</span><span class=\"token number\">9</span>/9<span class=\"token punctuation\">)</span> FINISHED\n <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">[</span>internal<span class=\"token punctuation\">]</span> load build definition from Dockerfile\n <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> transferring dockerfile: 37B\n <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">[</span>internal<span class=\"token punctuation\">]</span> load .dockerignore\n <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> transferring context: 2B\n <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">[</span>internal<span class=\"token punctuation\">]</span> load metadata <span class=\"token keyword\">for</span> docker.io/library/debian:latest\n <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">[</span><span class=\"token number\">1</span>/4<span class=\"token punctuation\">]</span> FROM docker.io/library/debian:latest@sha256:4482958b4461ff7d9fabc24b3a9ab1e9a2c85ece07b2db1840c7cbc01d053e90\n <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">[</span>internal<span class=\"token punctuation\">]</span> load build context\n <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> transferring context: 720B\n <span class=\"token operator\">=</span><span class=\"token operator\">></span> CACHED <span class=\"token punctuation\">[</span><span class=\"token number\">2</span>/4<span class=\"token punctuation\">]</span> RUN <span class=\"token function\">apt-get</span> update <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">apt-get</span> <span class=\"token function\">install</span> -y cups printer-driver-cups-pdf <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">apt-get</span> clean <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">rm</span> -rf /var/lib/apt/lists/*\n <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">[</span><span class=\"token number\">3</span>/4<span class=\"token punctuation\">]</span> COPY configure-printer.sh /usr/local/bin/\n <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">[</span><span class=\"token number\">4</span>/4<span class=\"token punctuation\">]</span> RUN <span class=\"token function\">chmod</span> +x /usr/local/bin/configure-printer.sh\n <span class=\"token operator\">=</span><span class=\"token operator\">></span> exporting to image\n <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> exporting layers\n <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> writing image sha256:100089de8e3c91417db1e27897dda8d21f5ab0499ff20f31bb111e5ae2a014af\n <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> naming to docker.io/library/cups-pdf</code></pre></div><p>The first time you run this command it will take a while to download the base image and install the required packages. Subsequent builds will be faster because Docker will cache the layers.</p><p>Now you can run the Docker container:</p><div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">❯ docker run -it cups-pdf\nStopping Common Unix Printing System: cupsd.\n/run/cups/cups.sock\nCUPS started\nlpadmin: Printer drivers are deprecated and will stop working <span class=\"token keyword\">in</span> a future version of CUPS.\nPrinter configured. Container will keep running.\nE <span class=\"token punctuation\">[</span><span class=\"token number\">18</span>/Feb/2024:15:14:53 +0000<span class=\"token punctuation\">]</span> Unable to <span class=\"token function\">open</span> listen socket <span class=\"token keyword\">for</span> address <span class=\"token punctuation\">[</span>v1.::1<span class=\"token punctuation\">]</span>:631 - Cannot assign requested address.\nE <span class=\"token punctuation\">[</span><span class=\"token number\">18</span>/Feb/2024:15:14:53 +0000<span class=\"token punctuation\">]</span> Unable to communicate with avahi-daemon: Daemon not running</code></pre></div><blockquote>\n<p>Press <code class=\"language-text\">Ctrl+C</code> to stop the container.</p>\n</blockquote><p>This will start the CUPS-PDF container and configure the CUPS-PDF printer. Unfortunately there are a few errors. The first error is a warning about deprecated printer drivers. That error can be safely ignored for now. The second error is about not being able to open a listen socket for the address <code class=\"language-text\">v1.::1</code>. This is because the container is running in a hypervisor environment and the host networking is not available.</p><p>In order to fix this error, you need to run the container in host networking mode. This will allow the container to use the host networking stack and access the host network interfaces. You can do this by adding the <code class=\"language-text\">--network host</code> flag to the <code class=\"language-text\">docker run</code> command:</p><div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">❯ docker run -it --network <span class=\"token function\">host</span> cups-pdf\nStopping Common Unix Printing System: cupsd.\n/run/cups/cups.sock\nCUPS started\nlpadmin: Printer drivers are deprecated and will stop working <span class=\"token keyword\">in</span> a future version of CUPS.\nPrinter configured. Container will keep running.\nE <span class=\"token punctuation\">[</span><span class=\"token number\">18</span>/Feb/2024:15:17:46 +0000<span class=\"token punctuation\">]</span> Unable to communicate with avahi-daemon: Daemon not running</code></pre></div><p>The last error is a warning about Avahi not running. We’ll fix these errors in the next section.</p><p>Unfortunately, we still can’t use this printer because we are not able to access the Docker container’s ports from the host. Although we are exposing port 631 we need to map the container’s port to the host’s port. We can do this by adding the <code class=\"language-text\">-p 631:631</code> flag to the <code class=\"language-text\">docker run</code> command:</p><div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">❯ docker run -it --network <span class=\"token function\">host</span> -p <span class=\"token number\">631</span>:631 cups-pdf\nWARNING: Published ports are discarded when using <span class=\"token function\">host</span> network mode\ndocker: Error response from daemon: Ports are not available: exposing port TCP <span class=\"token number\">0.0</span>.0.0:631 -<span class=\"token operator\">></span> <span class=\"token number\">0.0</span>.0.0:0: listen tcp <span class=\"token number\">0.0</span>.0.0:631: bind: address already <span class=\"token keyword\">in</span> use</code></pre></div><p>We immediately get an error because the host is already using port 631 - our local machine is running the CUPS service. We can fix this by stopping the CUPS service on the host:</p><div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">❯ <span class=\"token function\">sudo</span> launchctl unload /System/Library/LaunchDaemons/org.cups.cupsd.plist</code></pre></div><blockquote>\n<p>You would think that you could just stop the CUPS service using <code class=\"language-text\">sudo launchctl stop org.cups.cupsd</code> but that doesn’t work as it will automatically restart. You need to use <code class=\"language-text\">launchctl unload</code> to stop the service. To restart the service, use <code class=\"language-text\">sudo launchctl load /System/Library/LaunchDaemons/org.cups.cupsd.plist</code>.</p>\n</blockquote><p>Run the container again:</p><div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">❯ docker run -it -p <span class=\"token number\">631</span>:631 cups-pdf\nStopping Common Unix Printing System: cupsd.\n/run/cups/cups.sock\nCUPS started\nlpadmin: Printer drivers are deprecated and will stop working <span class=\"token keyword\">in</span> a future version of CUPS.\nPrinter configured. Container will keep running.\nE <span class=\"token punctuation\">[</span><span class=\"token number\">18</span>/Feb/2024:15:23:11 +0000<span class=\"token punctuation\">]</span> Unable to <span class=\"token function\">open</span> listen socket <span class=\"token keyword\">for</span> address <span class=\"token punctuation\">[</span>v1.::1<span class=\"token punctuation\">]</span>:631 - Cannot assign requested address.\nE <span class=\"token punctuation\">[</span><span class=\"token number\">18</span>/Feb/2024:15:23:11 +0000<span class=\"token punctuation\">]</span> Unable to communicate with avahi-daemon: Daemon not running</code></pre></div><p>At this point, we have access to the CUPS-PDF printer on the host, but it is not being advertised as an AirPrint printer. To do this (in a separate terminal, with the Docker container still running) run the following command:</p><div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">dns-sd -R <span class=\"token string\">\"CUPS-PDF @ AirPrint\"</span> _ipp._tcp,_universal <span class=\"token builtin class-name\">.</span> <span class=\"token number\">631</span> <span class=\"token punctuation\">\\</span>\n        <span class=\"token assign-left variable\">pdl</span><span class=\"token operator\">=</span>application/octet-stream,application/pdf,image/jpeg,image/png,image/pwg-raster,image/urf <span class=\"token punctuation\">\\</span>\n        <span class=\"token assign-left variable\">adminurl</span><span class=\"token operator\">=</span> <span class=\"token punctuation\">\\</span>\n        <span class=\"token assign-left variable\">rp</span><span class=\"token operator\">=</span>printers/cups-pdf <span class=\"token punctuation\">\\</span>\n        <span class=\"token assign-left variable\">TLS</span><span class=\"token operator\">=</span><span class=\"token number\">1.2</span> <span class=\"token punctuation\">\\</span>\n        <span class=\"token assign-left variable\">Color</span><span class=\"token operator\">=</span>T <span class=\"token punctuation\">\\</span>\n        <span class=\"token assign-left variable\">Copies</span><span class=\"token operator\">=</span>T</code></pre></div><p>This will broadcast the CUPS-PDF printer as an AirPrint printer on the local network. You can now print to the CUPS-PDF printer from your iOS device.</p><p>But where do the PDFs go? The PDFs are saved in the <code class=\"language-text\">/var/spool/cups-pdf/ANONYMOUS</code> folder inside the container. You can access the PDFs by running the following command:</p><div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">❯ docker <span class=\"token builtin class-name\">exec</span> -it <span class=\"token operator\">&lt;</span>container-id<span class=\"token operator\">></span> <span class=\"token function\">ls</span> /var/spool/cups-pdf/ANONYMOUS</code></pre></div><blockquote>\n<p>Replace <code class=\"language-text\">&lt;container-id&gt;</code> with the ID of the running container. You can find this by running <code class=\"language-text\">docker ps</code>. You can automate finding the container ID by using <code class=\"language-text\">$(docker ps -a | grep -m 1 cups-pdf | awk &#39;{print $1}&#39;)</code>.</p>\n</blockquote><p>If you want to save the PDFs to the host, you can copy them (see the <code class=\"language-text\">docker cp</code> command) or you can mount a volume to the container.</p><p>First create a folder on the host:</p><div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">mkdir</span> -p ~/Documents/CUPS-PDF</code></pre></div><p>Then run the container with the volume mounted:</p><div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">❯ docker run -it  -p <span class=\"token number\">631</span>:631 -v ~/Documents/CUPS-PDF:/var/spool/cups-pdf/ANONYMOUS cups-pdf\nStopping Common Unix Printing System: cupsd.\n/run/cups/cups.sock\nCUPS started\nlpadmin: Printer drivers are deprecated and will stop working <span class=\"token keyword\">in</span> a future version of CUPS.\nPrinter configured. Container will keep running.\nE <span class=\"token punctuation\">[</span><span class=\"token number\">18</span>/Feb/2024:15:42:50 +0000<span class=\"token punctuation\">]</span> Unable to <span class=\"token function\">open</span> listen socket <span class=\"token keyword\">for</span> address <span class=\"token punctuation\">[</span>v1.::1<span class=\"token punctuation\">]</span>:631 - Cannot assign requested address.\nE <span class=\"token punctuation\">[</span><span class=\"token number\">18</span>/Feb/2024:15:42:50 +0000<span class=\"token punctuation\">]</span> Unable to communicate with avahi-daemon: Daemon not running</code></pre></div><p>When you run this (if you used the <code class=\"language-text\">~/Documents</code> folder like I did) you’ll get a permissions dialog:</p><p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 261px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/0fbf0365f402234d4b5411afee89acd5/edf96/docker-and-cups-pdf-documents.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 81.60919540229885%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAsSAAALEgHS3X78AAADOklEQVQ4y2WUSXMbRRTH/XU4UUXxAahwSJFbgmOt06MZzUgaW7uUyJZsOZIjR5ZiLRXLTqzIC8jxApFwYcq5UFBQ3LhxorhDzhSpHLD7z3sty7HJ4V/d/fr17y09PRPhcAimaUgzaPCoFAyaMElBM0DSIYJh6CTLFLQfUPtj6bpApfIQjx4ty8nJzzFhWcFzYwSShhGQhhmQpmmSeG7IGws/yZvt1/LT5l/yRvFnqYIrmWoUQpOrjVXZbDZw587tMwZK8x1wlCVHNwSEHcNHlTcY/AasfA98UPpXZcpZsw8FV/6UpWJMTd09Z+BlqdeBGjQrjg/zf+OP18Cvf57hk8Yb6E5KBRsDL85I27beAcegq0DulWEG8XHqd7jaEvd+/AcxyjRS3YDhc8O0rEsgt4o57wHHFxK0LppOpRlWBLfFfWipB3DKdVjRBGWok8+1yt4HMoBHarKSpvkh6Ab9nI3ugaG54XNNQvN5lH3sx7fMJV8DchSv14NsNoNGYxX1eg18a/PzBXQ6HTysVFBcXEStXkeD7LzXbrdQKj3A7GwOHo9bhkIXPeRmchTeKJdLWF/vqAN7e3totZrodjextFTGykpV2bvdrrJvbKwTtE0B1zgRyRVeAoUQWKQMKssVVKtVFAoFil5CiQJUCbRGh3Z2tlEsLigtkx8H4QRqtRXyz//vswkI6o0bfi/LBV3zQvg98LjuojifR+fJKJN4PAa32wW/36fk83m5XJ5f7aEphROHnsjBP52GFs1CxLLwz2SgkbxOGi4jTJfkg23biETCsEM2uDIWr0mSn7AC6nZEzrW3sP3iQL4Ynsidw5fof32M/W9OsHs0QK9/gNlmF+VqHTvbPTx99hRHR4cYDgfU5z42N5/Jra2efPy4DnrLBAw5WFjblf39Awy/eyW/Ov4Wh4Njmp9ieHKK/v4h8q3nWKo10P9yF73ecwwGL3H66lRBaS2/IHuz1Rj9HOjbO9Nj92BkFqRIzEFP5hFIFyCSc+A12SGiGYSozGh0BjMkZzqiSnWciLKR5PS0A5dr6u3ErVuf/TJ7P4t0Mn6eSSUkCVdF9tGYTiGVSirx/MpaJpOJ81wuB2L98B/f3O/jZq7BZwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Docker Desktop would like to access your Documents\"\n        title=\"Docker Desktop would like to access your Documents\"\n        src=\"/static/0fbf0365f402234d4b5411afee89acd5/edf96/docker-and-cups-pdf-documents.png\"\n        srcset=\"/static/0fbf0365f402234d4b5411afee89acd5/edf96/docker-and-cups-pdf-documents.png 261w\"\n        sizes=\"(max-width: 261px) 100vw, 261px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p><p>Choose <code class=\"language-text\">Allow</code>. Now when you print to the CUPS-PDF printer, the PDFs will be saved to the <code class=\"language-text\">~/Documents/CUPS-PDF</code> folder on the host.</p><h1 id=\"avahi\" style=\"position:relative;\"><a href=\"#avahi\" aria-label=\"avahi permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Avahi</h1><p>If you are like me, you might be thinking: “This is great, but I don’t want to have to run the <code class=\"language-text\">dns-sd</code> command every time I start the container, maybe I can use Avahi to broadcast the CUPS-PDF printer as an AirPrint printer automatically.”</p><p>Spoiler: you can’t.</p><p>On Mac, the container network is completely separate from the host network even when running in host networking mode. This means that the Avahi daemon running in the container is not able to communicate with the host. Because of this the Avahi daemon within the container cannot use multicast DNS to broadcast services on the local network.</p><p>For more information, see <a href=\"https://github.com/docker/for-mac/issues/3926#issuecomment-1760373163\">Docker host networking</a>.</p><p>But it is still interesting to get Avahi to work in a container. If your host computer was Linux, or if you wanted to multicast broadcast between Docker containers (See Container Networks, <code class=\"language-text\">--network container:&lt;name|id&gt;</code>, in <a href=\"https://docs.docker.com/network/\">https://docs.docker.com/network/</a>), this would allow broadcasting on those networks.</p></section>\n<section><h2 id=\"updating-the-code-classlanguage-textdockerfilecode\" style=\"position:relative;\"><a href=\"#updating-the-code-classlanguage-textdockerfilecode\" aria-label=\"updating the code classlanguage textdockerfilecode permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Updating the <code class=\"language-text\">Dockerfile</code></h2><p>In order to run Avahi we’ll need to update the <code class=\"language-text\">Dockerfile</code> to install Avahi and its dependencies. Change  the <code class=\"language-text\">Dockerfile</code>:</p><div class=\"gatsby-highlight\" data-language=\"dockerfile\"><pre class=\"language-dockerfile\"><code class=\"language-dockerfile\"><span class=\"token comment\"># Use a base image with necessary dependencies (e.g., Debian)</span>\n<span class=\"token keyword\">FROM</span> debian<span class=\"token punctuation\">:</span>latest\n\n<span class=\"token comment\"># Install required packages (CUPS, CUPS-PDF)</span>\n<span class=\"token keyword\">RUN</span> apt<span class=\"token punctuation\">-</span>get update &amp;&amp; \\\n    apt<span class=\"token punctuation\">-</span>get install <span class=\"token punctuation\">-</span>y \\\n        cups \\\n        printer<span class=\"token punctuation\">-</span>driver<span class=\"token punctuation\">-</span>cups<span class=\"token punctuation\">-</span>pdf \\\n        avahi<span class=\"token punctuation\">-</span>daemon avahi<span class=\"token punctuation\">-</span>discover avahi<span class=\"token punctuation\">-</span>utils libnss<span class=\"token punctuation\">-</span>mdns mdns<span class=\"token punctuation\">-</span>scan \\\n        dbus \\\n        &amp;&amp; \\\n    apt<span class=\"token punctuation\">-</span>get clean &amp;&amp; \\\n    rm <span class=\"token punctuation\">-</span>rf /var/lib/apt/lists/*\n\n<span class=\"token comment\"># Expose the CUPS and Avahi ports</span>\n<span class=\"token keyword\">EXPOSE</span> 631 5353/udp\n\n<span class=\"token comment\"># Copy printer configuration script</span>\n<span class=\"token keyword\">COPY</span> configure<span class=\"token punctuation\">-</span>printer.sh /usr/local/bin/\n\n<span class=\"token comment\"># Make it executable</span>\n<span class=\"token keyword\">RUN</span> chmod +x /usr/local/bin/configure<span class=\"token punctuation\">-</span>printer.sh\n\n<span class=\"token comment\"># Set entry point</span>\n<span class=\"token keyword\">ENTRYPOINT</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"/usr/local/bin/configure-printer.sh\"</span><span class=\"token punctuation\">]</span></code></pre></div><p>The <code class=\"language-text\">Dockerfile</code> is very similar to the previous one, but we’ve added the <code class=\"language-text\">avahi-daemon avahi-discover avahi-utils libnss-mdns mdns-scan</code> packages to the <code class=\"language-text\">apt-get install</code> command and we’ve exposed the Avahi port <code class=\"language-text\">5353/udp</code>. We’ve also added the <code class=\"language-text\">dbus</code> package which is required by Avahi.</p><p><code class=\"language-text\">Dbus</code> is a message bus system that allows applications to communicate with each other. It is used by Avahi to communicate with the system bus. It works in most Linux and Unix systems, but it is not available by default on macOS. It is possible to install it on macOS using Homebrew, but it is not necessary for this project.<label for=\"sd-in-the-event-that\" class=\"margin-toggle sidenote-number\"></label><input type=\"checkbox\" id=\"sd-in-the-event-that\" class=\"margin-toggle\" /><span class=\"sidenote\">In the event that your host <em>is</em> Linux, you can connect the container's <code>dbus</code> to the host's when you run the container. To do this, you need to mount the host's <code>dbus</code> to the container's <code>dbus</code> using the <code>-v</code> flag and connecting the local <code>/var/run/dbus/system_bus_socket</code> (found in <code>/opt/homebrew</code> on a Mac) with <code>system_bus_socket</code> in the container. This will allow the container to communicate with the host's <code>dbus</code> and use Avahi to broadcast services on the local network. I attempted to do this on my Mac but couldn't find the magic incantation to get it to work.</span></p></section>\n<section><h2 id=\"updating-the-code-classlanguage-textconfigure-printershcode-script\" style=\"position:relative;\"><a href=\"#updating-the-code-classlanguage-textconfigure-printershcode-script\" aria-label=\"updating the code classlanguage textconfigure printershcode script permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Updating the <code class=\"language-text\">configure-printer.sh</code> script</h2><p>We also need to update the <code class=\"language-text\">configure-printer.sh</code> script to start the Avahi daemon.</p><p>We’ll need to start the <code class=\"language-text\">dbus-daemon</code>, start the <code class=\"language-text\">avahi-daemon</code> and then broadcast the CUPS-PDF printer as an AirPrint printer. We’ll also include some error checking to make sure they all start properly:</p><div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token shebang important\">#!/bin/bash</span>\n\n<span class=\"token comment\"># Stop any service that auto-started</span>\n<span class=\"token function\">service</span> cups stop\n\n<span class=\"token comment\"># Start the dbus daemon</span>\ndbus-daemon --system --print-address\n\n<span class=\"token comment\"># Start Avahi daemon if it's not running</span>\n<span class=\"token keyword\">if</span> <span class=\"token operator\">!</span> pgrep -x <span class=\"token string\">\"avahi-daemon\"</span> <span class=\"token operator\">></span>/dev/null<span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\n    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"Avahi daemon is not running. Starting it...\"</span>\n    avahi-daemon --no-rlimits <span class=\"token operator\">&amp;</span>\n    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"Waiting for Avahi daemon to start...\"</span>\n    <span class=\"token function\">sleep</span> <span class=\"token number\">5</span>\n<span class=\"token keyword\">fi</span>\n\n<span class=\"token comment\"># Check if it really started</span>\n<span class=\"token keyword\">if</span> <span class=\"token operator\">!</span> pgrep -x <span class=\"token string\">\"avahi-daemon\"</span> <span class=\"token operator\">></span>/dev/null<span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\n    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"Avahi daemon failed to start\"</span>\n    <span class=\"token builtin class-name\">exit</span> <span class=\"token number\">1</span>\n<span class=\"token keyword\">fi</span>\n\n<span class=\"token comment\"># Start the CUPS daemon in the background</span>\n/usr/sbin/cupsd\n\n<span class=\"token comment\"># Wait for CUPS to start</span>\n<span class=\"token keyword\">until</span> lpstat -H<span class=\"token punctuation\">;</span> <span class=\"token keyword\">do</span>\n  <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"Waiting for CUPS to start...\"</span>\n  <span class=\"token function\">sleep</span> <span class=\"token number\">1</span>\n<span class=\"token keyword\">done</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"CUPS started\"</span>\n\n<span class=\"token comment\"># Share everything</span>\ncupsctl --share-printers --remote-any --remote-admin --user-cancel-any <span class=\"token string\">\"WebInterface=Yes\"</span>\n\n<span class=\"token comment\"># Configure CUPS-PDF</span>\n<span class=\"token function\">mkdir</span> -p /var/spool/cups-pdf/CUPS-PDF\n<span class=\"token function\">chmod</span> <span class=\"token number\">1777</span> /var/spool/cups-pdf/CUPS-PDF\nlpadmin -p CUPS-PDF -E -v cups-pdf:/ -P /usr/share/ppd/cups-pdf/CUPS-PDF_opt.ppd -D <span class=\"token string\">\"CUPS-PDF Printer\"</span> -L <span class=\"token string\">\"PDF Printer\"</span>\n\n<span class=\"token comment\"># Register the printer service</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"Registering the printer service...\"</span>\navahi-publish-service <span class=\"token string\">\"DOCKER-CUPS-PDF @ AirPrint\"</span> _ipp._tcp <span class=\"token number\">631</span> <span class=\"token punctuation\">\\</span>\n  <span class=\"token assign-left variable\">pdl</span><span class=\"token operator\">=</span>application/octet-stream,application/pdf,image/jpeg,image/png,image/pwg-raster,image/urf <span class=\"token punctuation\">\\</span>\n  <span class=\"token assign-left variable\">adminurl</span><span class=\"token operator\">=</span> <span class=\"token punctuation\">\\</span>\n  <span class=\"token assign-left variable\">rp</span><span class=\"token operator\">=</span>printers/CUPS-PDF <span class=\"token punctuation\">\\</span>\n  <span class=\"token assign-left variable\">TLS</span><span class=\"token operator\">=</span><span class=\"token number\">1.2</span> <span class=\"token punctuation\">\\</span>\n  <span class=\"token assign-left variable\">Color</span><span class=\"token operator\">=</span>T <span class=\"token punctuation\">\\</span>\n  <span class=\"token assign-left variable\">Copies</span><span class=\"token operator\">=</span>T <span class=\"token operator\">&amp;</span>\n\n<span class=\"token comment\"># Keep container running</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"Printer configured. Container will keep running.\"</span>\n<span class=\"token function\">tail</span> -f /var/log/cups/error_log</code></pre></div></section>\n<section><h2 id=\"rebuilding-the-docker-image-and-running-the-container\" style=\"position:relative;\"><a href=\"#rebuilding-the-docker-image-and-running-the-container\" aria-label=\"rebuilding the docker image and running the container permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Rebuilding the Docker image and running the container</h2><p>Rebuild the Docker image:</p><div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">❯ docker build -t cups-pdf <span class=\"token builtin class-name\">.</span></code></pre></div><p>Then run the container:</p><div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">❯ docker run -it -p <span class=\"token number\">631</span>:631 -v ~/Documents/CUPS-PDF:/var/spool/cups-pdf/ANONYMOUS cups-pdf\nStopping Common Unix Printing System: cupsd.\nunix:path<span class=\"token operator\">=</span>/run/dbus/system_bus_socket,guid<span class=\"token operator\">=</span>0ef70bef46dd361330a2c60e65d24c5f\nAvahi daemon is not running. Starting it<span class=\"token punctuation\">..</span>.\nWaiting <span class=\"token keyword\">for</span> Avahi daemon to start<span class=\"token punctuation\">..</span>.\nFound user <span class=\"token string\">'avahi'</span> <span class=\"token punctuation\">(</span><span class=\"token environment constant\">UID</span> <span class=\"token number\">101</span><span class=\"token punctuation\">)</span> and group <span class=\"token string\">'avahi'</span> <span class=\"token punctuation\">(</span>GID <span class=\"token number\">107</span><span class=\"token punctuation\">)</span>.\nSuccessfully dropped root privileges.\navahi-daemon <span class=\"token number\">0.8</span> starting up.\nSuccessfully called chroot<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>.\nSuccessfully dropped remaining capabilities.\nNo <span class=\"token function\">service</span> <span class=\"token function\">file</span> found <span class=\"token keyword\">in</span> /etc/avahi/services.\nJoining mDNS multicast group on interface eth0.IPv4 with address <span class=\"token number\">172.17</span>.0.2.\nNew relevant interface eth0.IPv4 <span class=\"token keyword\">for</span> mDNS.\nJoining mDNS multicast group on interface lo.IPv4 with address <span class=\"token number\">127.0</span>.0.1.\nNew relevant interface lo.IPv4 <span class=\"token keyword\">for</span> mDNS.\nNetwork interface enumeration completed.\nRegistering new address record <span class=\"token keyword\">for</span> <span class=\"token number\">172.17</span>.0.2 on eth0.IPv4.\nRegistering new address record <span class=\"token keyword\">for</span> <span class=\"token number\">127.0</span>.0.1 on lo.IPv4.\nServer startup complete. Host name is c1b0a29d5536.local. Local <span class=\"token function\">service</span> cookie is <span class=\"token number\">719581554</span>.\n/run/cups/cups.sock\nCUPS started\nlpadmin: Printer drivers are deprecated and will stop working <span class=\"token keyword\">in</span> a future version of CUPS.\nRegistering the printer service<span class=\"token punctuation\">..</span>.\nPrinter configured. Container will keep running.\nE <span class=\"token punctuation\">[</span><span class=\"token number\">18</span>/Feb/2024:18:28:52 +0000<span class=\"token punctuation\">]</span> Unable to <span class=\"token function\">open</span> listen socket <span class=\"token keyword\">for</span> address <span class=\"token punctuation\">[</span>v1.::1<span class=\"token punctuation\">]</span>:631 - Cannot assign requested address.\nEstablished under name <span class=\"token string\">'DOCKER-CUPS-PDF @ AirPrint'</span></code></pre></div><p>It works, but again, this will not join your host network and will not broadcast the printer as an AirPrint printer.</p><h1 id=\"cleaning-up\" style=\"position:relative;\"><a href=\"#cleaning-up\" aria-label=\"cleaning up permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Cleaning up</h1><p>If you’ve made it this far you may want to clean up. Stop any running the containers and <code class=\"language-text\">dns-sd</code> commands. Then remove the containers:</p><div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">❯ docker <span class=\"token function\">ps</span> -a\nCONTAINER ID   IMAGE     COMMAND   CREATED   STATUS    PORTS     NAMES\nc1b0a29d5536   cups-pdf  <span class=\"token string\">\"/usr/local/bin/co…\"</span>   <span class=\"token number\">2</span> minutes ago   Up <span class=\"token number\">2</span> minutes\n❯ docker stop c1b0a29d5536\nc1b0a29d5536\n❯ docker <span class=\"token function\">rm</span> c1b0a29d5536\nc1b0a29d5536</code></pre></div><p>You can also remove the Docker image:</p><div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">❯ docker images\nREPOSITORY   TAG       IMAGE ID       CREATED       SIZE\ncups-pdf     latest    100089de8e3c   <span class=\"token number\">2</span> hours ago   <span class=\"token number\">1</span>.03GB\n❯ docker rmi 100089de8e3c\nUntagged: cups-pdf:latest\nDeleted: sha256:100089de8e3c91417db1e27897dda8d21f5ab0499ff20f31bb111e5ae2a014af</code></pre></div><p>Also, if you stopped your local CUPS service, you can restart it:</p><div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">❯ <span class=\"token function\">sudo</span> launchctl load /System/Library/LaunchDaemons/org.cups.cupsd.plist</code></pre></div></section>","frontmatter":{"title":"Docker, CUPS-PDF, Avahi and AirPrint","date":"February 17, 2024","tags":["markdown"],"excerpt":"Just use docker to print to a PDF from your iPad ™️","comments":"https://github.com/jeffrafter/jeffrafter.github.io/issues/65","image":{"childImageSharp":{"resize":{"src":"/static/4bebf8f1c549ca09cb717d1bb2d3fdb2/10e03/docker-and-cups-pdf.png"}}}}}},"pageContext":{"slug":"/docker-and-cups-pdf/","previous":{"fields":{"slug":"/printers/"},"frontmatter":{"tags":["markdown"],"title":"Printers, Fake Printers, and AirPrint"}},"next":null}}}