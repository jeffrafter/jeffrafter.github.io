{"componentChunkName":"component---src-templates-post-tsx","path":"/bluetooth/","result":{"data":{"site":{"siteMetadata":{"title":"Jeff Rafter"}},"markdownRemark":{"id":"e3cb2fc1-0246-55a3-b8e5-485bdf5d2abd","excerpt":"Last week at GitHub we held a day of learning. It was a fantastic opportunity to dig into things I’ve been wanting to learn. I decided to focus on Bluetooth security. Gavin has been working on a new coding based platform that connects his iPad to a small robot using Bluetooth. He wants a better editor (it uses a MakeCode based block editor but has some usability issues); he generally uses Visual Studio Code. I wondered if it would be possible to write our own client and connect to the robot.  Some background Our interest in Bluetooth hacking began a couple of years ago… with a Furby. Hasbro released the Furby Connect in 2012. The Furby Connect is a dancing, singing robotic toy much like its predecessor. Mad hordes of shoppers weren’t tackling one another in the aisles to purchase the Furby Connect as they had done when the original Furby was released. If they had understood its true potential, however, they might have. Furby is probably the most advanced, well designed, impossibly elegant child’s toy that exists. It might be the key to unlocking the emotion of pair-programming. It might seem like the stuff of nightmares: these small talking robots dancing and singing and clamoring for your attention, but as a developer or user experience designer it is an almost perfect medium. About two years ago a few of us built a pair-coding Furby for a GitHub hack week. The Furby watched as you worked in Atom and offered reactions and ideas. We made a short promotional (and unscripted) video: Pair Coding Furby During that project we focused more on designing an empathetic robot partner and utilized existing bluetooth libraries for controlling a Furby. It worked out great, but involved relatively little hacking as someone else had already reverse-engineered the protocol and connection. I wanted to learn how to do that.  Bluetooth Smart For our purposes, we decided to focus on Bluetooth Low Energy (or Bluetooth Smart), a subset of the Bluetooth 4.0 specification. Because it generally uses lower power, it is commonly used for peripherals (especially battery powered devices). Though you can read the full specification there is a much simpler introduction by Adafruit. Quick glossary: Peripheral devices - things like bluetooth headphones, keyboards, speakers, or in our case a robot - advertise a Generic Access Profile or GAP. Central devices - like your phone or iPad, a computer, or some other controller - scan for peripheral devices. Once a central device finds a…","html":"<section><p>Last week at GitHub we held a day of learning. It was a fantastic opportunity to dig into things I’ve been wanting to learn. I decided to focus on Bluetooth security. Gavin has been working on a new coding based platform that connects his iPad to a small robot using Bluetooth. He wants a better editor (it uses a MakeCode based block editor but has some usability issues); he generally uses Visual Studio Code. I wondered if it would be possible to write our own client and connect to the robot.</p></section>\n<section><h2 id=\"some-background\" style=\"position:relative;\"><a href=\"#some-background\" aria-label=\"some background permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Some background</h2><p>Our interest in Bluetooth hacking began a couple of years ago… with a Furby.</p><p>Hasbro released the Furby Connect in 2012. The Furby Connect is a dancing, singing robotic toy much like its predecessor. Mad hordes of shoppers weren’t tackling one another in the aisles to purchase the Furby Connect as they had done when the original Furby was released. If they had understood its true potential, however, they might have.</p><p>Furby is probably the most advanced, well designed, impossibly elegant child’s toy that exists. It might be the key to unlocking the emotion of pair-programming. It might seem like the stuff of nightmares: these small talking robots dancing and singing and clamoring for your attention, but as a developer or user experience designer it is an almost perfect medium.</p><p>About two years ago a few of us built a pair-coding Furby for a GitHub hack week. The Furby watched as you worked in Atom and offered reactions and ideas. We made a short promotional (and unscripted) video:</p><p><a href=\"https://githubber.tv/github/pair-coding-furby\"><img src=\"https://github-talks.s3.amazonaws.com/uploads/97/1389/90b2cb22-b437-4f4f-be6d-2d52aceb630e.embed_cover.jpg\" alt=\"Pair Coding Furby\"></a></p><p>During that project we focused more on designing an empathetic robot partner and utilized existing bluetooth libraries for controlling a Furby. It worked out great, but involved relatively little <em>hacking</em> as someone else had already reverse-engineered the protocol and connection.</p><p>I wanted to learn how to do that.</p></section>\n<section><h2 id=\"bluetooth-smart\" style=\"position:relative;\"><a href=\"#bluetooth-smart\" aria-label=\"bluetooth smart permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Bluetooth Smart</h2><p>For our purposes, we decided to focus on <a href=\"https://en.wikipedia.org/wiki/Bluetooth_Low_Energy\">Bluetooth Low Energy</a> (or Bluetooth Smart), a subset of the Bluetooth 4.0 specification. Because it generally uses lower power, it is commonly used for peripherals (especially battery powered devices). Though you can read the full <a href=\"https://www.bluetooth.com/specifications/bluetooth-core-specification/\">specification</a> there is a much simpler introduction by <a href=\"https://learn.adafruit.com/introduction-to-bluetooth-low-energy/introduction\">Adafruit</a>.</p><p>Quick glossary:</p><p><strong>Peripheral devices</strong> - things like bluetooth headphones, keyboards, speakers, or in our case a robot - advertise a Generic Access Profile or <a href=\"https://learn.adafruit.com/introduction-to-bluetooth-low-energy/gap\">GAP</a>.</p><p><strong>Central devices</strong> - like your phone or iPad, a computer, or some other controller - scan for peripheral devices. Once a central device finds a peripheral it can connect and read its Generic Attribute Profile or <a href=\"https://learn.adafruit.com/introduction-to-bluetooth-low-energy/gatt\">GATT</a> which contains a list of the peripheral’s available services and the characteristics of those services.</p><p>Subscribing to the services and reading from or writing to the characteristics requires an established connection. Often, the peripheral requires a button to be pressed or a pairing code. Sometimes, like in the case of our robot, you can connect to the peripheral without any user intervention. It is important to note that a peripheral can only be connected to <strong>one</strong> central device at a time. For example, your bluetooth headphones can only be connected to one phone at a time.</p></section>\n<section><h2 id=\"bluetooth-security\" style=\"position:relative;\"><a href=\"#bluetooth-security\" aria-label=\"bluetooth security permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Bluetooth security</h2><p>Bluetooth security has, historically, been challenging. Though the specification has introduced more advanced security with each version, the peripheral makers have often implemented them incorrectly, or have avoided implementing them at all. Moreover, given the variety of peripherals (some with no input or display function), the specification must offer corresponding pairing mechanisms often at the expense of strong security.</p><p>If you want to learn more about Bluetooth Security, NIST has published an excellent <a href=\"https://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-121r2.pdf\">Guide to Bluetooth Security</a> (PDF, 67 pages).</p><p>Bluetooth communications rely upon proximity and frequency hopping, making it difficult to eavesdrop on the electromagnetic signal or even jam the signal for a denial of service. Because of this, most attacks involve connecting to the peripheral to establish a man-in-the-middle (MITM).</p><p>Since Bluetooth 4.1, peripherals can implement Secure Simple Pairing which can be broken down into four models:</p><ul>\n<li>Numeric Comparison</li>\n<li>Passkey Entry</li>\n<li>Just Works</li>\n<li>Out of Band</li>\n</ul><p>In the case of Numeric Comparison and Passkey Entry user input and interaction is required to pair a device and peripheral. These are generally more difficult to attack (though some strategies still exist). In the case of Just Works it… Just Works. The peripheral, like our robot, can be connected automatically without any user interaction.</p><p>Although it is possible to establish a connection with no user interaction, the data sent over the connection can be encrypted. The specification offers multiple encryption algorithms based on AES (which is usually built into the hardware of the peripheral). Often, peripherals don’t implement full encryption and rely instead upon the simpler challenge/response interaction to establish a secure session. After the session is established subsequent connections are sent in plain text. Sometimes, like in the case of the Furby, they don’t use any encryption at all.</p><p>Even if the connection is fully encrypted it is possible that the key itself may be discovered based on the <a href=\"https://www.bluetooth.com/security/statement-key-negotiation-of-bluetooth/\">Key Negotiation of Bluetooth</a> vulnerability. In the case of challenge/response based implementations it is often possible to discover predict or maniplulate the challenge as many peripherals have a weak (or non-existent) psuedorandom number generator (PRNG).</p></section>\n<section><h2 id=\"lets-get-hacking\" style=\"position:relative;\"><a href=\"#lets-get-hacking\" aria-label=\"lets get hacking permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Let’s get hacking</h2><p>Because we want to connect to our robot, we’ll limit our scope to simple Bluetooth Low Energy devices that connect automatically (Just Works). Our goal is to be able to send commands to our robot without using the associated iPad application. We know our robot doesn’t require a number or passkey to connect; so we should be able to establish a connection. To start, we’ll need to figure out what we’re dealing with:</p><ul>\n<li>Can we scan for the device’s GATT?</li>\n<li>If we connect to the device is there a challenge/response interaction?</li>\n<li>Are the communications encrypted?</li>\n</ul><p>To find the answers to these questions we’ll use <a href=\"https://gattack.io/\">GATTacker</a>, a Bluetooth discovery tool written in JavaScript and <a href=\"https://github.com/securing/gattacker\">available on GitHub</a> written by <a href=\"https://twitter.com/slawekja\">Slawomir Jasek</a>. At the 2016 Blackhat conference, Slawomir gave an introductory talk:</p><div class=\"gatsby-resp-iframe-wrapper\" style=\"padding-bottom: 56.25%; position: relative; height: 0; overflow: hidden; margin-bottom: 1.0725rem\" > <iframe src=\"https://www.youtube.com/embed/uKqdb4lF0XU\" frameborder=\"0\" allow=\"accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture\" allowfullscreen style=\" position: absolute; top: 0; left: 0; width: 100%; height: 100%; \"></iframe> </div><p>Many things have changed since 2016 when the tool was written (especially for tools written in JavaScript) and this proved to be one of our biggest challenges. Because of this, it is probably best to rely on our <a href=\"https://github.com/jeffrafter/gattacker\">fork</a>.</p><p>We are using an Apple MacBook Pro and it turns out to be fairly difficult to manipulate the system’s internal Bluetooth - especially in recent versions of MacOS. Though it is possible to connect to Bluetooth peripherals we decided to follow the path of least resistance and attempt to connect via Linux using a Raspberry PI.</p><p>By default a normal connection might look this:</p><figure class=\"fullwidth\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1253px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/42258c43a41b01304301ab136916465e/27e9a/bluetooth-normal-connection.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 40.9375%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsSAAALEgHS3X78AAAB1UlEQVQoz32STWgTURSFAy66EwTdFRFE6MZlQURQcGMrbgRFshAXXejGlaBF0KWgVlAoqFD6g4siXTSlaoQi00hNmhlnRvPTRlPqiDTJTDszmVhNTSafb2YoiqgXDue9x+Nwzz031ul0CGqbfz8HHCG8EZDdEPgO7g+BZgenBY54rwv4ArHgq+/7mKaJ53l/CEXw2+3wPaemSI/1oj04RPrqcRZv9qNc6kM+0c/LI0dRphORoOu6pNNpSqUS/6v5V8/5lL0OC4dp3dhB88peNi/sgmPdrHZ3Id29FQlWKhUMw6BYLOLW62w2GhiVdT5XN1i3TCzRvfu1yWLyCWVpnDWvij15hq1rPayc34d5+SB6fDep0SFirVYLx3FCa4VCAdt2sKoVMvkVXqtFlGyGfO49q2sWytRDjJE4HyyXN4/G+HKqh+bATrYudmGdi5GauE0sEKrVapTLZZaXlsJ5/quyiXEyjweRdB15IcNG/B4c6IWT+/nWt4f5kfuR5bqwKUkSsiyzHZIfhBGwQFu4CGc4N8ezqae8SCaYGZxg9uwkH08Pk7szSmJomOT0TCTYFikGCdu2/Zd1+bVGnpitKrrTFRX1rY6iaWj5PFppGTn3Dtt1+AmxQSy5YX0DRQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Robot connected to an iPad using bluetooth\"\n        title=\"Robot connected to an iPad using bluetooth\"\n        src=\"/static/42258c43a41b01304301ab136916465e/27e9a/bluetooth-normal-connection.png\"\n        srcset=\"/static/42258c43a41b01304301ab136916465e/72799/bluetooth-normal-connection.png 320w,\n/static/42258c43a41b01304301ab136916465e/6af66/bluetooth-normal-connection.png 640w,\n/static/42258c43a41b01304301ab136916465e/27e9a/bluetooth-normal-connection.png 1253w\"\n        sizes=\"(max-width: 1253px) 100vw, 1253px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></figure><figcaption class=\"fullwidth\">\nRobot connected to an iPad using bluetooth.\n</figcaption><p>The peripheral occasionally advertises its Generic Access Profile (GAP). A central device (in this case an iPad) scans for advertisements, finds the peripheral and establishes a connection.</p><p>To construct our man-in-the-middle attack we’ll need to have a device (or devices) in between the peripheral and central device:</p><figure class=\"fullwidth\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1280px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/bc0f453c3e75f9d878224da5e87ab105/f18a9/bluetooth-mitm-connection.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 33.125%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsSAAALEgHS3X78AAABcUlEQVQoz32Ryy8DYRTFZynxX/gr7EUsmmBtI9YWHrGzsyIRwoKQEEEiHmnimQiJSFARoaqm1WpCU3RmytSYMW2nnZ+vSj2Ck5zc796bnHu/cyXe4bruNxYKhTd+7X2832LBxbTBcgTzgqImApKqqiQSCf7Ch8DngFIeDe9zueghMlhPpKeJYKOH88kppFgsRigUwrZtMtkcecchl81yFDxhd2cLQ9cxDKM8ICN6eaF5frCBdjGCPVqN0VLJQ10F/r5OpKLQzc01WirFo/4khC36l2fxdLcyPDFE7sVCTz+xf+wjehHENC3SL3nk1XHO9rz4p704tVW4jRLhsS4kWZYJBALlr5Bz2PbOsym201SNlK7RNtJLTVszC0sz5U1P93ZZX5ljY2AFuaGfUHsHvqV5JEVRiMfjJb+KxhrPXK1tcuL3c+jzYVomx9EA98p9yct3T21hj6KoJO+SJNNpbp8tjEwG6ecBXP5BUezLxX/DKyPS/EF5gC2UAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Robot connected to an iPad using bluetooth with two Raspberry PIs in the middle\"\n        title=\"Robot connected to an iPad using bluetooth with two Raspberry PIs in the middle\"\n        src=\"/static/bc0f453c3e75f9d878224da5e87ab105/21b4d/bluetooth-mitm-connection.png\"\n        srcset=\"/static/bc0f453c3e75f9d878224da5e87ab105/72799/bluetooth-mitm-connection.png 320w,\n/static/bc0f453c3e75f9d878224da5e87ab105/6af66/bluetooth-mitm-connection.png 640w,\n/static/bc0f453c3e75f9d878224da5e87ab105/21b4d/bluetooth-mitm-connection.png 1280w,\n/static/bc0f453c3e75f9d878224da5e87ab105/f18a9/bluetooth-mitm-connection.png 1799w\"\n        sizes=\"(max-width: 1280px) 100vw, 1280px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></figure><figcaption class=\"fullwidth\">\nRobot connected to an iPad using bluetooth with two Raspberry PIs in the middle.\n</figcaption><p>In this case we have two devices (two Raspberry Pis). We need to use two devices because we need to simulate both sides of the connection. The first Raspberry Pi attaches to the robot, behaving like a central device. It forwards all of the messages it receives from the robot to the second Raspberry Pi (over a websocket) which behaves like a peripheral (pretending to be the robot). When the iPad scans for robot it finds the Raspberry Pi imposter and connects to it instead. Once connected, the messages from the iPad are sent back to the first Raspberry Pi and on to the robot.<label for=\"sd-you-might-be\" class=\"margin-toggle sidenote-number\"></label><input type=\"checkbox\" id=\"sd-you-might-be\" class=\"margin-toggle\" /><span class=\"sidenote\">You might be wondering why we can't do this all on one device. Because we are maintaining two connections (one to the robot and one to the iPad) we need two Bluetooth antennae. Each Raspberry Pi only has one built in. You could have multiple Bluetooth adapters (maybe via USB), but it makes things more complex and error prone.</span></p><h3 id=\"setting-up-the-raspberry-pis\" style=\"position:relative;\"><a href=\"#setting-up-the-raspberry-pis\" aria-label=\"setting up the raspberry pis permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Setting up the Raspberry Pis</h3><p>When setting up the devices you’ll need to make sure that they have Bluetooth. Raspberry Pi Zero and Raspberry Pi 3 Model B and above all have built-in Bluetooth (and Wifi) making them ideal. If you have an older model it will still work, but will require a Bluetooth adapter and more setup.</p><p>For my devices I’m using <a href=\"https://www.raspberrypi.org/downloads/\">Raspbian</a>. Once you’ve setup the image and connected your Raspberry Pi to your network you can perform the remaining setup over SSH<label for=\"sd-how-do-you-find-the\" class=\"margin-toggle sidenote-number\"></label><input type=\"checkbox\" id=\"sd-how-do-you-find-the\" class=\"margin-toggle\" /><span class=\"sidenote\">How do you find the SSH address of your Raspberry Pi? I used <code>arp -a</code> and was able to quickly find the new device on my network. The default username is <code>pi</code> and the default password is <code>raspberry</code>.</span>:</p><div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">ssh</span> pi@192.168.1.x</code></pre></div><p>We’ll need to setup some requirements. First update:</p><div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">sudo</span> <span class=\"token function\">apt-get</span> update</code></pre></div><p>GATTacker is written in JavaScript and requires Node. Let’s install that next:</p><div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">sudo</span> <span class=\"token function\">apt-get</span> <span class=\"token function\">install</span> -y nodejs</code></pre></div><p>We’ll need a number of dependencies:</p><div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">sudo</span> <span class=\"token function\">apt-get</span> <span class=\"token function\">install</span> libudev-dev gcc g++ <span class=\"token function\">make</span></code></pre></div><h3 id=\"gattacker\" style=\"position:relative;\"><a href=\"#gattacker\" aria-label=\"gattacker permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>GATTacker</h3><p>We’ll use <a href=\"https://github.com/securing/gattacker\">GATTacker</a> on both of our Raspberry Pis to setup our man-in-the-middle. In addition to the <a href=\"https://github.com/securing/gattacker\">README</a>, there is some helpful documentation in the Wiki:</p><ul>\n<li><a href=\"https://github.com/securing/gattacker/wiki/Dump-and-replay\">Dump and replay</a></li>\n<li><a href=\"https://github.com/securing/gattacker/wiki/FAQ\">FAQ</a></li>\n</ul><p>Additionally, there is a very good <a href=\"http://gattack.io/whitepaper.pdf\">whitepaper</a> (PDF).</p><p>As mentioned before, we’ll use a <a href=\"https://github.com/jeffrafter/gattacker\">fork</a> which has some upgraded dependencies and fixes. Clone the repository:</p><div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">git</span> clone https://github.com/jeffrafter/gattacker.git</code></pre></div><p>You should see something like:</p><div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">Cloning into <span class=\"token string\">'gattacker'</span><span class=\"token punctuation\">..</span>.\nremote: Enumerating objects: <span class=\"token number\">250</span>, done.\nremote: Total <span class=\"token number\">250</span> <span class=\"token punctuation\">(</span>delta <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>, reused <span class=\"token number\">0</span> <span class=\"token punctuation\">(</span>delta <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>, pack-reused <span class=\"token number\">250</span>\nReceiving objects: <span class=\"token number\">100</span>% <span class=\"token punctuation\">(</span><span class=\"token number\">250</span>/250<span class=\"token punctuation\">)</span>, <span class=\"token number\">313.58</span> KiB <span class=\"token operator\">|</span> <span class=\"token number\">1.81</span> MiB/s, done.\nResolving deltas: <span class=\"token number\">100</span>% <span class=\"token punctuation\">(</span><span class=\"token number\">87</span>/87<span class=\"token punctuation\">)</span>, done.</code></pre></div><p>Change to the newly created <code class=\"language-text\">gattacker</code> directory:</p><div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token builtin class-name\">cd</span> gattacker</code></pre></div><p>Install the dependencies:</p><div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">npm install</code></pre></div><p>We’ll need to change the configuration open <code class=\"language-text\">config.env</code>:</p><div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">nano</span> config.env</code></pre></div><p>Uncomment <code class=\"language-text\">NOBLE_HCI_DEVICE_ID</code>:</p><div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">NOBLE_HCI_DEVICE_ID=0</code></pre></div><p>By default your Bluetooth adapter will be <code class=\"language-text\">hci0</code>. So the value should be <code class=\"language-text\">0</code> as specified. Save the file and exit (<code class=\"language-text\">Ctrl+X</code>, <code class=\"language-text\">Y</code> for yes, <code class=\"language-text\">Enter</code>).</p><p>If you are using a Bluetooth Adapter it might be different. If you aren’t sure, you can check:</p><div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">rfkill</code></pre></div><p>You should see:</p><div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">ID TYPE      DEVICE      SOFT      HARD\n 0 wlan      phy0   unblocked unblocked\n 1 bluetooth hci0   unblocked unblocked</code></pre></div><p>We can see that the <code class=\"language-text\">bluetooth</code> device is <code class=\"language-text\">hci0</code> so we’re ready.</p><h3 id=\"warning\" style=\"position:relative;\"><a href=\"#warning\" aria-label=\"warning permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Warning</h3><p>Before we get begin scanning and connecting to devices it is important to call out a few (hopefully obvious) things. Our plan is to use the devices exactly as they were designed: they broadcast and advertisement, connect and communicate. You should check that you are not working against terms of service or laws in your jurisdiction.</p><p>Additionally, when scanning you’ll notice there are <em>a lot</em> of peripherals close by (the lower the <code class=\"language-text\">RSSI</code> value the closer it is). You might be tempted to connect to your neighbor’s Forerunner or their Cup-o-noodles (no really, there are Bluetooth Enabled Cup-o-noodles near me). But remember: when you connect to one of these devices their owner cannot connect to them (peripherals can only maintain one connection). This opens up a variety of interesting denial of service (DOS) attack scenarios; many of which are not legal.</p><p>To be safe: stick to your own devices and services.</p><h3 id=\"scanning\" style=\"position:relative;\"><a href=\"#scanning\" aria-label=\"scanning permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scanning</h3><p>We want to begin scanning for advertisements. Before we begin scanning we want to set up the WebSocket server. All GATTacker tools communicate over WebSockets so the server must be running.</p><p>From within the <code class=\"language-text\">gattacker</code> directory, run:</p><div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">sudo</span> <span class=\"token function\">npm</span> run ws-server</code></pre></div><p>You should see:</p><div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">&gt; gattacker@0.2.1-1 ws-server /home/pi/gattacker\n&gt; node ws-server.js\n\nGATTacker ws-server\n(node:2780) [DEP0005] DeprecationWarning: Buffer() is deprecated due to security and usability issues. Please use the Buffer.alloc(), Buffer.allocUnsafe(), or Buffer.from() methods instead.</code></pre></div><p>With the server running, we want to start scanning. To do this, open a second window and a new shell<label for=\"sd-instead-of-opening-a\" class=\"margin-toggle sidenote-number\"></label><input type=\"checkbox\" id=\"sd-instead-of-opening-a\" class=\"margin-toggle\" /><span class=\"sidenote\">Instead of opening a second shell, you could also move the <code>ws-server</code> process to the background (by pressing <code>ctrl+z</code>), or run it via <code>screen</code>. You could also make this the default by outputting the logs to a file and running the command detached using <code>&#x26;</code>.</span>.</p><p>Make sure your Bluetooth peripheral is powered off (and will not automatically connect to any devices nearby). Then, in the new shell (still on the first Raspberry Pi) run the scan command:</p><div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">npm</span> run scan</code></pre></div><p>Turn on your device and you should see it appear in the log:</p><div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">peripheral discovered <span class=\"token punctuation\">(</span>f8e5dd08c726 with address <span class=\"token operator\">&lt;</span>f8:e5:dd:08:c7:26, random<span class=\"token operator\">></span>, connectable true, RSSI -73:\n\tName: Robot\n\tEIR: 0201061bff0303020401080008000000003701540030000000000000000000 <span class=\"token punctuation\">(</span>                 <span class=\"token number\">7</span> T <span class=\"token number\">0</span>         <span class=\"token punctuation\">)</span>\n\tScan response: 1107c1d9850ecade491f86619d87787723af0409437565 <span class=\"token punctuation\">(</span>        I  a  xw<span class=\"token comment\">#   Robot)</span>\n\nadvertisement saved: devices/f8e5dd08c726_Robot.adv.json</code></pre></div><p>Once you see your device (you should be able to recognize the name) you can stop the process. If the name of your device is not obvious (in our example above it is “Robot”) then you need to do some more detective work. By powering on and off the device a few times you can usually spot it.</p><p>Keep track of the name of the device and the where the advertisement was saved - in this case <code class=\"language-text\">devices/f8e5dd08c726_Robot.adv.json</code>.</p><p>Looking at the file, you’ll notice there doesn’t seem to be a lot of information. In fact, the only useful piece of information is the service identifier: <code class=\"language-text\">af237778879d61861f49deca0e85d9c1</code>. This is the actual identifier that our robot wants devices to use when connecting.</p><p>With this information (and the <code class=\"language-text\">f8e5dd08c726</code> identifier for the device) we can discover more services and characteristics. Let’s rescan, but this time we’ll focus only on our robot:</p><div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">npm run scan f8e5dd08c726</code></pre></div><p>You should see:</p><div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">npm run scan f8e5dd08c726\n\n&gt; gattacker@0.2.1-1 scan /home/pi/gattacker\n&gt; node scan.js &quot;f8e5dd08c726&quot;\n\nws-server address: 127.0.0.1\non open\npoweredOn\nStart exploring f8e5dd08c726\nStart to explore f8e5dd08c726\nexplore state: f8e5dd08c726 : startScan\nexplore state: f8e5dd08c726 : discovered\nexplore state: f8e5dd08c726 : start\n(node:1503) [DEP0005] DeprecationWarning: Buffer() is deprecated due to security and usability issues. Please use the Buffer.alloc(), Buffer.allocUnsafe(), or Buffer.from() methods instead.\nalready saved advertisement for f8e5dd08c726 (Robot)\nexplore state: f8e5dd08c726 : finished\nServices file devices/f8e5dd08c726.srv.json saved!</code></pre></div><p>Now we have the complete services and characteristics for our peripheral</p><h4 id=\"troubleshooting\" style=\"position:relative;\"><a href=\"#troubleshooting\" aria-label=\"troubleshooting permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Troubleshooting</h4><p>You might run into a problem reconnecting to the peripheral. In the <code class=\"language-text\">ws-server</code> logs you might see the error:</p><div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">ws -&gt; send: {&quot;type&quot;:&quot;connect&quot;,&quot;peripheralId&quot;:&quot;f8e5dd08c726&quot;}\nExplore: connect error: Error: Peripheral already connected - try hciconfig reset...</code></pre></div><p>If this happens, you can simply stop both processes. Then run:</p><div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">hciconfig reset</code></pre></div><p>And start the processes again.</p><h3 id=\"making-this-work-on-a-mac\" style=\"position:relative;\"><a href=\"#making-this-work-on-a-mac\" aria-label=\"making this work on a mac permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Making this work on a Mac</h3><p><a href=\"https://github.com/abandonware/noble#sandboxed-terminal\">https://github.com/abandonware/noble#sandboxed-terminal</a></p><p>On newer versions of OSX, allow bluetooth access on the terminal app: “System Preferences” —> “Security &#x26; Privacy” —> “Bluetooth” -> Add terminal app (see Sandboxed terminal)</p></section>","frontmatter":{"title":"Bluetooth Hacking","date":"April 19, 2020","tags":["bluetooth","hacks"],"excerpt":"Bluetooth can be an incredibly secure protocol... but it usually isn't.","comments":"https://github.com/jeffrafter/jeffrafter.github.io/issues/14","image":{"childImageSharp":{"resize":{"src":"/static/e79b8746f874d58028d71bafbb5cff83/9d169/cue-twin.jpg"}}}}}},"pageContext":{"slug":"/bluetooth/","previous":{"fields":{"slug":"/releasing-github-actions/"},"frontmatter":{"tags":["typescript","github","actions","honk","goose"],"title":"Releasing GitHub Actions"}},"next":{"fields":{"slug":"/getting-started-with-arduino-and-esp8266/"},"frontmatter":{"tags":["esp8266","hardware","arduino"],"title":"Getting started with ESP8266 and Arduino"}}}}}