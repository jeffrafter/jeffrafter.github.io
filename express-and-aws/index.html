<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.237ba1bc08ffadef5a9e.css">html{box-sizing:border-box;margin:0;padding:0}*,:after,:before{box-sizing:inherit}body{margin:0!important;padding:0}a.anchor,a.anchor:hover,a.anchor:link{background:none!important}figure a.gatsby-resp-image-link{background:none}figure span.gatsby-resp-image-wrapper{max-width:100%!important}article .excerpt{display:none}.btn,.button{display:inline-block;background:none!important;border-radius:40px;line-height:40px;min-height:40px;min-width:80px;padding:0 12px;text-align:center;text-decoration:none;border:1px solid #666;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji}@font-face{font-family:et-book;src:url(/et-book/et-book-roman-line-figures/et-book-roman-line-figures.eot);src:url(/et-book/et-book-roman-line-figures/et-book-roman-line-figures.eot?#iefix) format("embedded-opentype"),url(/et-book/et-book-roman-line-figures/et-book-roman-line-figures.woff) format("woff"),url(/et-book/et-book-roman-line-figures/et-book-roman-line-figures.ttf) format("truetype"),url(/et-book/et-book-roman-line-figures/et-book-roman-line-figures.svg#etbookromanosf) format("svg");font-weight:400;font-style:normal}@font-face{font-family:et-book;src:url(/et-book/et-book-display-italic-old-style-figures/et-book-display-italic-old-style-figures.eot);src:url(/et-book/et-book-display-italic-old-style-figures/et-book-display-italic-old-style-figures.eot?#iefix) format("embedded-opentype"),url(/et-book/et-book-display-italic-old-style-figures/et-book-display-italic-old-style-figures.woff) format("woff"),url(/et-book/et-book-display-italic-old-style-figures/et-book-display-italic-old-style-figures.ttf) format("truetype"),url(/et-book/et-book-display-italic-old-style-figures/et-book-display-italic-old-style-figures.svg#etbookromanosf) format("svg");font-weight:400;font-style:italic}@font-face{font-family:et-book;src:url(/et-book/et-book-bold-line-figures/et-book-bold-line-figures.eot);src:url(/et-book/et-book-bold-line-figures/et-book-bold-line-figures.eot?#iefix) format("embedded-opentype"),url(/et-book/et-book-bold-line-figures/et-book-bold-line-figures.woff) format("woff"),url(/et-book/et-book-bold-line-figures/et-book-bold-line-figures.ttf) format("truetype"),url(/et-book/et-book-bold-line-figures/et-book-bold-line-figures.svg#etbookromanosf) format("svg");font-weight:700;font-style:normal}@font-face{font-family:et-book-roman-old-style;src:url(/et-book/et-book-roman-old-style-figures/et-book-roman-old-style-figures.eot);src:url(/et-book/et-book-roman-old-style-figures/et-book-roman-old-style-figures.eot?#iefix) format("embedded-opentype"),url(/et-book/et-book-roman-old-style-figures/et-book-roman-old-style-figures.woff) format("woff"),url(/et-book/et-book-roman-old-style-figures/et-book-roman-old-style-figures.ttf) format("truetype"),url(/et-book/et-book-roman-old-style-figures/et-book-roman-old-style-figures.svg#etbookromanosf) format("svg");font-weight:400;font-style:normal}html{font-size:15px}body{width:87.5%;margin-left:auto;margin-right:auto;padding-left:12.5%;font-family:et-book,Palatino,Palatino Linotype,Palatino LT STD,Book Antiqua,Georgia,serif;background-color:#fffff8;color:#111;max-width:1400px;counter-reset:sidenote-counter}h1{font-weight:400;margin-top:4rem;margin-bottom:1.5rem;font-size:3.2rem;line-height:1}h2{margin-top:2.1rem;font-size:2.2rem}h2,h3{font-style:italic;font-weight:400;margin-bottom:1.4rem;line-height:1}h3{font-size:1.7rem;margin-top:2rem}hr{display:block;height:1px;width:55%;border:0;border-top:1px solid #ccc;margin:1em 0;padding:0}p.subtitle{font-style:italic;margin-top:1rem;margin-bottom:1rem;font-size:1.8rem;display:block;line-height:1}.numeral{font-family:et-book-roman-old-style}.danger{color:red}article{position:relative;padding:1rem 0}section{padding-top:1rem;padding-bottom:1rem}ol,p,ul{font-size:1.4rem;line-height:2rem}p{margin-top:1.4rem;margin-bottom:1.4rem;padding-right:0;vertical-align:baseline}div.epigraph{margin:5em 0}div.epigraph>blockquote{margin-top:3em;margin-bottom:3em}div.epigraph>blockquote,div.epigraph>blockquote>p{font-style:italic}div.epigraph>blockquote>footer{font-style:normal}div.epigraph>blockquote>footer>cite{font-style:italic}blockquote{font-size:1.4rem}blockquote p{width:55%;margin-right:40px;font-style:italic;color:#999}blockquote footer{width:55%;font-size:1.1rem;text-align:right}section>footer,section>p,section>table{width:55%;clear:left}section>ol,section>ul{width:55%;-webkit-padding-start:5%}li:not(:first-child){margin-top:.25rem}figure{padding:0;border:0;font-size:100%;font:inherit;max-width:55%;-webkit-margin-start:0;-webkit-margin-end:0;-webkit-margin-before:0;margin-block-start:0;-webkit-margin-after:0;margin-block-end:0;margin:0 0 3em}figcaption,figure{vertical-align:baseline}figcaption{margin-top:-2em;margin-bottom:0;font-size:1.1rem;font-style:italic;line-height:1.6;position:relative;max-width:40%}figure.fullwidth figcaption{max-width:80%}a:link,a:visited{color:inherit}a:link{text-decoration:none;border-bottom:1px solid #000;padding-bottom:.05em;margin-bottom:.05em;word-break:break-word}a.anchor:link,nav.navigation a{border-bottom:0;padding-bottom:0;margin-bottom:0}@media screen and (-webkit-min-device-pixel-ratio:0){a:link{background-position-y:101%,101%,101%}}img{max-width:100%}.sidenote{margin-bottom:2em!important}.marginnote,.sidenote{float:right;clear:right;width:45%;margin:0 -75% 0 5%;font-size:1.1rem;line-height:1.3;vertical-align:baseline;position:relative}.sidenote-number{counter-increment:sidenote-counter}.sidenote-number:after,.sidenote:before{font-family:et-book-roman-old-style;position:relative;vertical-align:baseline}.sidenote-number:after{content:counter(sidenote-counter);font-size:1rem;top:-.5rem;left:.1rem}.sidenote:before{content:counter(sidenote-counter) " ";font-size:1rem;top:-.5rem}blockquote .marginnote,blockquote .sidenote{margin-right:-82%;min-width:59%;text-align:left}div.fullwidth,table.fullwidth{width:100%}div.table-wrapper{overflow-x:auto}.sans,div.table-wrapper{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji}.sans{letter-spacing:.03em}code{font-family:Consolas,Liberation Mono,Menlo,Courier,monospace;font-size:1rem;line-height:1.42}.sans>code{font-size:1.2rem}h1>code,h2>code,h3>code{font-size:.8em}.marginnote>code,.sidenote>code{font-size:1rem}pre.code{font-size:.9rem;width:52.5%;margin-left:2.5%;overflow-x:auto}pre.code.fullwidth{width:90%}.fullwidth{max-width:100%;clear:both}span.newthought{font-variant:small-caps;font-size:1.2em}input.margin-toggle{display:none}label.sidenote-number{display:inline}label.margin-toggle:not(.sidenote-number){display:none}.iframe-wrapper{position:relative;padding-bottom:56.25%;padding-top:25px;height:0}.iframe-wrapper iframe{position:absolute;top:0;left:0;width:100%;height:100%}@media (max-width:760px){body{padding-left:8%;padding-right:8%}body,hr,section>footer,section>p,section>table{width:100%}pre.code{width:97%}section>ol,section>ul{width:90%}figure{max-width:90%}figcaption,figure.fullwidth figcaption{margin-right:0;max-width:none}blockquote{margin-left:1.5em;margin-right:0}blockquote footer,blockquote p{width:100%}label.margin-toggle:not(.sidenote-number){display:inline}.marginnote,.sidenote{display:none}.margin-toggle:checked+.marginnote,.margin-toggle:checked+.sidenote{display:block;float:left;left:1rem;clear:both;width:95%;margin:1rem 2.5%;vertical-align:baseline;position:relative}label{cursor:pointer}div.table-wrapper,table{width:85%}img{width:100%}}:not(pre)>code[class*=language-]{font-size:.9em!important}.gatsby-highlight:after{content:"";display:block;clear:both}.gatsby-highlight{clear:both}h4{font-size:1.3em}.markdown-body ol,.markdown-body p,.markdown-body ul{font-size:inherit;line-height:inherit}.markdown-body blockquote{font-size:inherit}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto;padding:24px;letter-spacing:normal;border-bottom:1px solid #efefef}@media (max-width:767px){.markdown-body{padding:15px}}code[class*=language-],pre[class*=language-]{color:#000;background:none;text-shadow:0 1px #fff;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-]::selection,code[class*=language-] ::selection,pre[class*=language-]::selection,pre[class*=language-] ::selection{text-shadow:none;background:#b3d4fc}@media print{code[class*=language-],pre[class*=language-]{text-shadow:none}}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#f5f2f0}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#708090}.token.punctuation{color:#999}.token.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#905}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#690}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url{color:#9a6e3a;background:hsla(0,0%,100%,.5)}.token.atrule,.token.attr-value,.token.keyword{color:#07a}.token.class-name,.token.function{color:#dd4a68}.token.important,.token.regex,.token.variable{color:#e90}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.markdown-body .octicon{display:inline-block;fill:currentColor;vertical-align:text-bottom}.markdown-body .anchor{float:left;line-height:1;margin-left:-20px;padding-right:4px}.markdown-body .anchor:focus{outline:none}.markdown-body h1 .octicon-link,.markdown-body h2 .octicon-link,.markdown-body h3 .octicon-link,.markdown-body h4 .octicon-link,.markdown-body h5 .octicon-link,.markdown-body h6 .octicon-link{color:#1b1f23;vertical-align:middle;visibility:hidden}.markdown-body h1:hover .anchor,.markdown-body h2:hover .anchor,.markdown-body h3:hover .anchor,.markdown-body h4:hover .anchor,.markdown-body h5:hover .anchor,.markdown-body h6:hover .anchor{text-decoration:none}.markdown-body h1:hover .anchor .octicon-link,.markdown-body h2:hover .anchor .octicon-link,.markdown-body h3:hover .anchor .octicon-link,.markdown-body h4:hover .anchor .octicon-link,.markdown-body h5:hover .anchor .octicon-link,.markdown-body h6:hover .anchor .octicon-link{visibility:visible}.markdown-body h1:hover .anchor .octicon-link:before,.markdown-body h2:hover .anchor .octicon-link:before,.markdown-body h3:hover .anchor .octicon-link:before,.markdown-body h4:hover .anchor .octicon-link:before,.markdown-body h5:hover .anchor .octicon-link:before,.markdown-body h6:hover .anchor .octicon-link:before{width:16px;height:16px;content:" ";display:inline-block;background-image:url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' version='1.1' width='16' height='16' aria-hidden='true'%3E%3Cpath fill-rule='evenodd' d='M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z'/%3E%3C/svg%3E")}.markdown-body{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;color:#24292e;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji;font-size:16px;line-height:1.5;word-wrap:break-word}.markdown-body details{display:block}.markdown-body summary{display:list-item}.markdown-body a{background-color:initial}.markdown-body a:active,.markdown-body a:hover{outline-width:0}.markdown-body strong{font-weight:inherit;font-weight:bolder}.markdown-body h1{margin:.67em 0}.markdown-body img{border-style:none}.markdown-body code,.markdown-body kbd,.markdown-body pre{font-family:monospace,monospace;font-size:1em}.markdown-body hr{box-sizing:initial;overflow:visible}.markdown-body input{font:inherit;margin:0;overflow:visible}.markdown-body [type=checkbox]{box-sizing:border-box;padding:0}.markdown-body *{box-sizing:border-box}.markdown-body input{font-family:inherit;font-size:inherit;line-height:inherit}.markdown-body a{color:#0366d6;text-decoration:none}.markdown-body a:hover{text-decoration:underline}.markdown-body strong{font-weight:600}.markdown-body hr{height:0;margin:15px 0;overflow:hidden;background:transparent;border-bottom:1px solid #dfe2e5}.markdown-body hr:after,.markdown-body hr:before{display:table;content:""}.markdown-body hr:after{clear:both}.markdown-body table{border-spacing:0;border-collapse:collapse}.markdown-body td,.markdown-body th{padding:0}.markdown-body details summary{cursor:pointer}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:0;margin-bottom:0}.markdown-body h1{font-size:32px}.markdown-body h1,.markdown-body h2{font-weight:600}.markdown-body h2{font-size:24px}.markdown-body h3{font-size:20px}.markdown-body h3,.markdown-body h4{font-weight:600}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:14px}.markdown-body h5,.markdown-body h6{font-weight:600}.markdown-body h6{font-size:12px}.markdown-body p{margin-top:0;margin-bottom:10px}.markdown-body blockquote{margin:0}.markdown-body ol,.markdown-body ul{padding-left:0;margin-top:0;margin-bottom:0}.markdown-body ol ol,.markdown-body ul ol{list-style-type:lower-roman}.markdown-body ol ol ol,.markdown-body ol ul ol,.markdown-body ul ol ol,.markdown-body ul ul ol{list-style-type:lower-alpha}.markdown-body dd{margin-left:0}.markdown-body code,.markdown-body pre{font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px}.markdown-body pre{margin-top:0;margin-bottom:0}.markdown-body input::-webkit-inner-spin-button,.markdown-body input::-webkit-outer-spin-button{margin:0;-webkit-appearance:none;appearance:none}.markdown-body :checked+.radio-label{position:relative;z-index:1;border-color:#0366d6}.markdown-body .border{border:1px solid #e1e4e8!important}.markdown-body .border-0{border:0!important}.markdown-body .border-bottom{border-bottom:1px solid #e1e4e8!important}.markdown-body .rounded-1{border-radius:3px!important}.markdown-body .bg-white{background-color:#fff!important}.markdown-body .bg-gray-light{background-color:#fafbfc!important}.markdown-body .text-gray-light{color:#6a737d!important}.markdown-body .pl-3,.markdown-body .px-3{padding-left:16px!important}.markdown-body .px-3{padding-right:16px!important}.markdown-body .f6{font-size:12px!important}.markdown-body .lh-condensed{line-height:1.25!important}.markdown-body .text-bold{font-weight:600!important}.markdown-body .pl-c{color:#6a737d}.markdown-body .pl-c1,.markdown-body .pl-s .pl-v{color:#005cc5}.markdown-body .pl-e,.markdown-body .pl-en{color:#6f42c1}.markdown-body .pl-s .pl-s1,.markdown-body .pl-smi{color:#24292e}.markdown-body .pl-ent{color:#22863a}.markdown-body .pl-k{color:#d73a49}.markdown-body .pl-pds,.markdown-body .pl-s,.markdown-body .pl-s .pl-pse .pl-s1,.markdown-body .pl-sr,.markdown-body .pl-sr .pl-cce,.markdown-body .pl-sr .pl-sra,.markdown-body .pl-sr .pl-sre{color:#032f62}.markdown-body .pl-smw,.markdown-body .pl-v{color:#e36209}.markdown-body .pl-bu{color:#b31d28}.markdown-body .pl-ii{color:#fafbfc;background-color:#b31d28}.markdown-body .pl-c2{color:#fafbfc;background-color:#d73a49}.markdown-body .pl-c2:before{content:"^M"}.markdown-body .pl-sr .pl-cce{font-weight:700;color:#22863a}.markdown-body .pl-ml{color:#735c0f}.markdown-body .pl-mh,.markdown-body .pl-mh .pl-en,.markdown-body .pl-ms{font-weight:700;color:#005cc5}.markdown-body .pl-mi{font-style:italic;color:#24292e}.markdown-body .pl-mb{font-weight:700;color:#24292e}.markdown-body .pl-md{color:#b31d28;background-color:#ffeef0}.markdown-body .pl-mi1{color:#22863a;background-color:#f0fff4}.markdown-body .pl-mc{color:#e36209;background-color:#ffebda}.markdown-body .pl-mi2{color:#f6f8fa;background-color:#005cc5}.markdown-body .pl-mdr{font-weight:700;color:#6f42c1}.markdown-body .pl-ba{color:#586069}.markdown-body .pl-sg{color:#959da5}.markdown-body .pl-corl{text-decoration:underline;color:#032f62}.markdown-body .mb-0{margin-bottom:0!important}.markdown-body .my-2{margin-bottom:8px!important;margin-top:8px!important}.markdown-body .pl-0{padding-left:0!important}.markdown-body .py-0{padding-top:0!important;padding-bottom:0!important}.markdown-body .pl-1{padding-left:4px!important}.markdown-body .pl-2{padding-left:8px!important}.markdown-body .py-2{padding-top:8px!important;padding-bottom:8px!important}.markdown-body .pl-3{padding-left:16px!important}.markdown-body .pl-4{padding-left:24px!important}.markdown-body .pl-5{padding-left:32px!important}.markdown-body .pl-6{padding-left:40px!important}.markdown-body .pl-7{padding-left:48px!important}.markdown-body .pl-8{padding-left:64px!important}.markdown-body .pl-9{padding-left:80px!important}.markdown-body .pl-10{padding-left:96px!important}.markdown-body .pl-11{padding-left:112px!important}.markdown-body .pl-12{padding-left:128px!important}.markdown-body hr{border-bottom-color:#eee}.markdown-body kbd{display:inline-block;padding:3px 5px;font:11px SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #d1d5da;border-radius:3px;box-shadow:inset 0 -1px 0 #d1d5da}.markdown-body:after,.markdown-body:before{display:table;content:""}.markdown-body:after{clear:both}.markdown-body>:first-child{margin-top:0!important}.markdown-body>:last-child{margin-bottom:0!important}.markdown-body a:not([href]){color:inherit;text-decoration:none}.markdown-body blockquote,.markdown-body details,.markdown-body dl,.markdown-body ol,.markdown-body p,.markdown-body pre,.markdown-body table,.markdown-body ul{margin-top:0;margin-bottom:16px}.markdown-body hr{height:.25em;padding:0;margin:24px 0;background-color:#e1e4e8;border:0}.markdown-body blockquote{padding:0 1em;color:#6a737d;border-left:.25em solid #dfe2e5}.markdown-body blockquote>:first-child{margin-top:0}.markdown-body blockquote>:last-child{margin-bottom:0}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:24px;margin-bottom:16px;font-weight:600;line-height:1.25}.markdown-body h1{font-size:2em}.markdown-body h1,.markdown-body h2{padding-bottom:.3em;border-bottom:1px solid #eaecef}.markdown-body h2{font-size:1.5em}.markdown-body h3{font-size:1.25em}.markdown-body h4{font-size:1em}.markdown-body h5{font-size:.875em}.markdown-body h6{font-size:.85em;color:#6a737d}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:0;margin-bottom:0}.markdown-body li{word-wrap:break-all}.markdown-body li>p{margin-top:16px}.markdown-body li+li{margin-top:.25em}.markdown-body dl{padding:0}.markdown-body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:600}.markdown-body dl dd{padding:0 16px;margin-bottom:16px}.markdown-body table{display:block;width:100%;overflow:auto}.markdown-body table th{font-weight:600}.markdown-body table td,.markdown-body table th{padding:6px 13px;border:1px solid #dfe2e5}.markdown-body table tr{background-color:#fff;border-top:1px solid #c6cbd1}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}.markdown-body img{max-width:100%;box-sizing:initial;background-color:#fff}.markdown-body img[align=right]{padding-left:20px}.markdown-body img[align=left]{padding-right:20px}.markdown-body code{padding:.2em .4em;margin:0;font-size:85%;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body pre{word-wrap:normal}.markdown-body pre>code{padding:0;margin:0;font-size:100%;word-break:normal;white-space:pre;background:transparent;border:0}.markdown-body .highlight{margin-bottom:16px}.markdown-body .highlight pre{margin-bottom:0;word-break:normal}.markdown-body .highlight pre,.markdown-body pre{padding:16px;overflow:auto;font-size:85%;line-height:1.45;background-color:#f6f8fa;border-radius:3px}.markdown-body pre code{display:inline;max-width:auto;padding:0;margin:0;overflow:visible;line-height:inherit;word-wrap:normal;background-color:initial;border:0}.markdown-body .commit-tease-sha{display:inline-block;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:90%;color:#444d56}.markdown-body .full-commit .btn-outline:not(:disabled):hover{color:#005cc5;border-color:#005cc5}.markdown-body .blob-wrapper{overflow-x:auto;overflow-y:hidden}.markdown-body .blob-wrapper-embedded{max-height:240px;overflow-y:auto}.markdown-body .blob-num{width:1%;min-width:50px;padding-right:10px;padding-left:10px;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px;line-height:20px;color:rgba(27,31,35,.3);text-align:right;white-space:nowrap;vertical-align:top;cursor:pointer;-webkit-user-select:none;-ms-user-select:none;user-select:none}.markdown-body .blob-num:hover{color:rgba(27,31,35,.6)}.markdown-body .blob-num:before{content:attr(data-line-number)}.markdown-body .blob-code{position:relative;padding-right:10px;padding-left:10px;line-height:20px;vertical-align:top}.markdown-body .blob-code-inner{overflow:visible;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px;color:#24292e;word-wrap:normal;white-space:pre}.markdown-body .pl-token.active,.markdown-body .pl-token:hover{cursor:pointer;background:#ffea7f}.markdown-body .tab-size[data-tab-size="1"]{-moz-tab-size:1;-o-tab-size:1;tab-size:1}.markdown-body .tab-size[data-tab-size="2"]{-moz-tab-size:2;-o-tab-size:2;tab-size:2}.markdown-body .tab-size[data-tab-size="3"]{-moz-tab-size:3;-o-tab-size:3;tab-size:3}.markdown-body .tab-size[data-tab-size="4"]{-moz-tab-size:4;-o-tab-size:4;tab-size:4}.markdown-body .tab-size[data-tab-size="5"]{-moz-tab-size:5;-o-tab-size:5;tab-size:5}.markdown-body .tab-size[data-tab-size="6"]{-moz-tab-size:6;-o-tab-size:6;tab-size:6}.markdown-body .tab-size[data-tab-size="7"]{-moz-tab-size:7;-o-tab-size:7;tab-size:7}.markdown-body .tab-size[data-tab-size="8"]{-moz-tab-size:8;-o-tab-size:8;tab-size:8}.markdown-body .tab-size[data-tab-size="9"]{-moz-tab-size:9;-o-tab-size:9;tab-size:9}.markdown-body .tab-size[data-tab-size="10"]{-moz-tab-size:10;-o-tab-size:10;tab-size:10}.markdown-body .tab-size[data-tab-size="11"]{-moz-tab-size:11;-o-tab-size:11;tab-size:11}.markdown-body .tab-size[data-tab-size="12"]{-moz-tab-size:12;-o-tab-size:12;tab-size:12}.markdown-body .task-list-item{list-style-type:none}.markdown-body .task-list-item+.task-list-item{margin-top:3px}.markdown-body .task-list-item input{margin:0 .2em .25em -1.6em;vertical-align:middle}</style><meta name="generator" content="Gatsby 2.23.4"/><style type="text/css">
    .anchor.before {
      position: absolute;
      top: 0;
      left: 0;
      transform: translateX(-100%);
      padding-right: 4px;
    }
    .anchor.after {
      display: inline-block;
      padding-left: 4px;
    }
    h1 .anchor svg,
    h2 .anchor svg,
    h3 .anchor svg,
    h4 .anchor svg,
    h5 .anchor svg,
    h6 .anchor svg {
      visibility: hidden;
    }
    h1:hover .anchor svg,
    h2:hover .anchor svg,
    h3:hover .anchor svg,
    h4:hover .anchor svg,
    h5:hover .anchor svg,
    h6:hover .anchor svg,
    h1 .anchor:focus svg,
    h2 .anchor:focus svg,
    h3 .anchor:focus svg,
    h4 .anchor:focus svg,
    h5 .anchor:focus svg,
    h6 .anchor:focus svg {
      visibility: visible;
    }
  </style><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop
          var clientTop = document.documentElement.clientTop || document.body.clientTop || 0
          var offset = element.getBoundingClientRect().top + scrollTop - clientTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 0)
          }), 0)
        }
      }
    })
  </script><link rel="canonical" href="https://jeffrafter.com/express-and-aws/" data-baseprotocol="https:" data-basehost="jeffrafter.com"/><link rel="icon" href="/favicon-32x32.png?v=bddcaef8d466d0f77d76d3d885709d8f"/><link rel="manifest" href="/manifest.webmanifest"/><meta name="theme-color" content="#663399"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=bddcaef8d466d0f77d76d3d885709d8f"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=bddcaef8d466d0f77d76d3d885709d8f"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=bddcaef8d466d0f77d76d3d885709d8f"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=bddcaef8d466d0f77d76d3d885709d8f"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=bddcaef8d466d0f77d76d3d885709d8f"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=bddcaef8d466d0f77d76d3d885709d8f"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=bddcaef8d466d0f77d76d3d885709d8f"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=bddcaef8d466d0f77d76d3d885709d8f"/><link rel="preconnect dns-prefetch" href="https://www.google-analytics.com"/><link rel="alternate" type="application/rss+xml" href="/rss.xml"/><title data-react-helmet="true">Exploring - Using Express and Amazon Web Services | Jeff Rafter</title><meta data-react-helmet="true" name="description" content="Using Express to build out your API can be challenging; but integrating it with all of the products available from Amazon Web Services can feel impossible."/><meta data-react-helmet="true" property="og:title" content="Exploring - Using Express and Amazon Web Services"/><meta data-react-helmet="true" property="og:description" content="Using Express to build out your API can be challenging; but integrating it with all of the products available from Amazon Web Services can feel impossible."/><meta data-react-helmet="true" property="og:type" content="website"/><meta data-react-helmet="true" property="og:image" content="https://jeffrafter.com//static/eae0aba8f83488451e9758afef95c138/10e03/express.png"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="twitter:creator" content="Jeff Rafter"/><meta data-react-helmet="true" name="twitter:title" content="Exploring - Using Express and Amazon Web Services"/><meta data-react-helmet="true" name="twitter:description" content="Using Express to build out your API can be challenging; but integrating it with all of the products available from Amazon Web Services can feel impossible."/><meta data-react-helmet="true" name="keywords" content="aws, express, terraform"/><style data-styled="coseIW ddlDEo bOnSNx gXLbcD aCPwf" data-styled-version="4.4.1">
/* sc-component-id: sc-global-3268680936 */
::selection{background-color:#dad9d9;color:rgba(0,0,0,0.70);}
/* sc-component-id: sc-bdVaJa */
.coseIW ul{list-style-type:none;margin:1rem 0;padding:0;margin-left:-16px;} .coseIW li{display:inline-block;margin:16px;} .coseIW li a{background:none;}
/* sc-component-id: sc-bwzfXH */
.aCPwf{padding-bottom:36px;}
/* sc-component-id: sc-ifAKCX */
.ddlDEo{width:55%;}
/* sc-component-id: sc-gzVnrw */
.bOnSNx{margin-top:40px;margin-bottom:40px;float:right;}
/* sc-component-id: sc-htoDjs */
.gXLbcD{list-style-type:none;} .gXLbcD li::before{content:'' !important;padding-right:0 !important;}</style><link as="script" rel="preload" href="/webpack-runtime-38c8a4ef93b968ef91ae.js"/><link as="script" rel="preload" href="/framework-8dcecaaefd71e2213eb2.js"/><link as="script" rel="preload" href="/styles-fa79fef4936efa84b233.js"/><link as="script" rel="preload" href="/app-3b271d6a60df7cd92087.js"/><link as="script" rel="preload" href="/commons-52923487d36b93dc329d.js"/><link as="script" rel="preload" href="/component---src-templates-post-tsx-30b85df3d8081f386f13.js"/><link as="fetch" rel="preload" href="/page-data/express-and-aws/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><nav class="sc-bdVaJa coseIW navigation"><ul><li><a href="/">&amp;</a></li><li><a href="/tags">Tags</a></li><li><a href="/about">About</a></li></ul></nav><main class="content" role="main"><article><header><h1>Exploring - Using Express and Amazon Web Services</h1><p>October 09, 2020</p></header><div class="page-content"><div><section><figure class="fullwidth"><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1280px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/eae0aba8f83488451e9758afef95c138/21b4d/express.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 56.25%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsSAAALEgHS3X78AAABT0lEQVQoz7WSy07CQBSGeS1de+Uq0rRAL5SLhhoxkkCMxsTEjYk74s5X4JmEtsy0rPoKv2dmSgSkLExcfDltz8x//p5zcseHU7QuEpjFEFaJwdyDVeQqSngambwrNIRWbiXYLISU4OnBLFKxMoedIr7/FqwklCCHZYZmUVTMgkuMMwb9hME4pfOFLYdHB1O41QR9Zw5Xn8G6nMHRFHZN4WhfsCqqJTYVHXsRnocxHgcRejpHIx/CXRfs1hLctOfwiPEgxG3Pl/G+H2DoCXxcNRbyLzoaw+dkiclbjI/3GE93EbkNpakNh936HG2DRFsBek2fnknEFAS4tny4tQW5W6BVZVLkZbTE60OMUV+0YM3hqofCtujHBnkVGxTNgpqseHcqHJ4ZkVuucrumrNZm/5RXWyAGVD9XxXZPORX82bGMPSypaW+v0p8dZjv/R8FvRlguobBQ5hIAAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="Express + AWS"
        title="Express + AWS"
        src="/static/eae0aba8f83488451e9758afef95c138/21b4d/express.png"
        srcset="/static/eae0aba8f83488451e9758afef95c138/72799/express.png 320w,
/static/eae0aba8f83488451e9758afef95c138/6af66/express.png 640w,
/static/eae0aba8f83488451e9758afef95c138/21b4d/express.png 1280w"
        sizes="(max-width: 1280px) 100vw, 1280px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
      />
  </a>
    </span></figure><figcaption class="fullwidth">
</figcaption><p><strong>üó∫ Exploring - Work in progress</strong></p><p>Using Express to build out your API can be challenging; but integrating it with all of the products available from Amazon Web Services can feel impossible. This post focuses less on best practices for your API and more on reusable patterns to tie all of those products together. This is the second part in a series on building out a scalable website on AWS. In the <a href="/terraform-and-aws">first part</a> we setup all of the infrastructure we‚Äôll need using Terraform.</p></section>
<section><h2 id="choosing-a-framework" style="position:relative;"><a href="#choosing-a-framework" aria-label="choosing a framework permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Choosing a framework</h2><p>Before we even get started we need to decide what framework we‚Äôll use to write our AWS Lambda function - if any. Out of the box AWS gives you a <code class="language-text">handler</code> pattern that you can use to receive an incoming web request, perform some actions and return a response. For a web server this is really all we need. In fact, using this simple pattern is actually the recommended best practice.</p><p>AWS Lambda is a FaaS (Function as a Service) or ‚Äúserverless‚Äù platform designed to execute discrete ‚Äúfunctions‚Äù or <em>handlers</em>. The expectation is that each route on our website will execute a separate specific function inside Lambda. Each of these routes would be setup individually inside AWS API Gateway and point to their respective AWS Lambda functions. We‚Äôve setup our API Gateway to send all routes to a single function (<code class="language-text">site_api</code>).</p><p>Why would we do this? What are the tradeoffs?</p><p><strong>All routes pointing to a single function</strong></p><ul>
<li>When developing your API you want to be able to test it locally</li>
<li>When deploying you want shared dependencies to be updated simultaneously</li>
<li>Adding a new route to API Gateway and pointing to a new Lambda function is cumbersome</li>
<li>Changing API Gateway can be slow</li>
<li>Our function will have fewer cold-starts</li>
</ul><p><strong>Many routes pointing to separate functions</strong></p><ul>
<li>You might want to restrict deployments for specific parts of the site</li>
<li>You can change parts of the site without changing everything</li>
<li>A single mistake won‚Äôt break the entire site</li>
<li>Deploying new functions will only cause cold-starts on part of the site</li>
<li>You want to use Lambda@Edge</li>
<li>Smaller functions take less time to upload and deploy</li>
<li>Smaller functions have a shorter cold-start time</li>
</ul><p>In general, how you choose between these trade-offs is dictated by the site and team (and in some cases preferences). If you have a smaller site and smaller team then it is often better to favor simplicity. Choosing <strong>All routes pointing to a single function</strong> simplifies local development and deployment but increases risk by putting everything in one function. For example, if you are the only developer (or there are only a couple developers), then layering strict permissions about who can deploy specific parts of the site is overkill.</p><p>What‚Äôs a cold-start? Even though AWS Lambda runs functions ‚Äúon-demand‚Äù it still needs to load the code in order to execute it. If your code-base is large it will take a long time to load before your function can respond to requests. Because this can be slow, AWS tries to avoid doing it too often and keeps the code in a hot-cache for five minutes after it is loaded. If the function is used again, the timeout is restarted. You should try to avoid cold-starts as much as possible and you should try to minimize their impact as much as possible to keep your site snappy. Keeping all of your routes in a separate functions means that the code that needs to be loaded is smaller (and therefore faster to load). But pointing all of your routes to a single shared function means that the function will be used more frequently and will likely have fewer cold-starts.</p><p>As with most things, it depends.</p><p>For our API we‚Äôll use a single function. This is almost always the simplest and easiest choice especially when getting started. As our site grows we can slowly transition from this model to a hybrid model with multiple functions and ultimately to individual functions for every route if needed.</p><h3 id="why-express" style="position:relative;"><a href="#why-express" aria-label="why express permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Why Express?</h3><p>Because we‚Äôre using a single function we‚Äôll need to enable that function to handle routing for us (like a traditional web server). There are numerous frameworks that make it easy. <a href="https://expressjs.com/">Express</a> is a ‚ÄúFast, unopinionated, minimalist web framework for Node.js‚Äù. That sounds like what we want. We could choose a smaller framework like Micro from Vercel (used as part of Next.js) - but it is not typically used in serverless environments. We could also choose <a href="https://sailsjs.com/">Sails.js</a>, a much richer MVC framework written in JavaScript. In many cases this is the right choice, but for our purposes we‚Äôll use Express as it is <em>closer to the metal</em> which makes it easier to follow the logic.</p><p>Because we are building an API there are a few other options available to us.</p><h1 id="getting-started" style="position:relative;"><a href="#getting-started" aria-label="getting started permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Getting started</h1><p>In the previous post we created a very simple API function:</p><div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js">exports<span class="token punctuation">.</span><span class="token function-variable function">handler</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">,</span> context</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Event: '</span> <span class="token operator">+</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Context: '</span> <span class="token operator">+</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">)</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    statusCode<span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
    body<span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      event<span class="token operator">:</span> event<span class="token punctuation">,</span>
      context<span class="token operator">:</span> context<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div><p>In the handler we logged information about the event and context and echoed back the result as JSON. You would never want a function like this in a production application, but this allowed us to quickly setup our API Gateway deployment, test AWS Lambda and make sure our logging worked.</p><p>To make our API we‚Äôll need more code than this. Let‚Äôs create a new folder called <code class="language-text">api</code>. I usually make this a sibling folder to the <code class="language-text">terraform</code> folder we created previously.</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">mkdir</span> api</code></pre></div><p>Change to that folder:</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token builtin class-name">cd</span> api</code></pre></div><p>We‚Äôll use <code class="language-text">npm</code> to install and manage the packages for our API. Let‚Äôs set that up now:</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">npm</span> init -y</code></pre></div><p>This will generate a default <code class="language-text">package.json</code>:</p><div class="gatsby-highlight" data-language="json"><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"api"</span><span class="token punctuation">,</span>
  <span class="token property">"version"</span><span class="token operator">:</span> <span class="token string">"1.0.0"</span><span class="token punctuation">,</span>
  <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
  <span class="token property">"main"</span><span class="token operator">:</span> <span class="token string">"index.js"</span><span class="token punctuation">,</span>
  <span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"test"</span><span class="token operator">:</span> <span class="token string">"echo \"Error: no test specified\" &amp;&amp; exit 1"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"keywords"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">"author"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
  <span class="token property">"license"</span><span class="token operator">:</span> <span class="token string">"ISC"</span>
<span class="token punctuation">}</span></code></pre></div><p>Next, we‚Äôll install express:</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> --save express</code></pre></div><p>We‚Äôll need a few more packages right away:</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> --save cors helmet body-parser cookie-parser http-errors</code></pre></div><p>We‚Äôll also need some AWS and serverless specific packages:</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> --save aws-sdk @vendia/serverless-express</code></pre></div><h3 id="typescript" style="position:relative;"><a href="#typescript" aria-label="typescript permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>TypeScript</h3><p>I usually choose to use TypeScript for my projects. Though it isn‚Äôt required it makes some things easier (and some things much harder). It can be a tough trade-off.</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> --save-dev typescript</code></pre></div><p>We only need TypeScript support while developing. We‚Äôll convert the application to JavaScript when deploying. Install the following TypeScript dependencies:</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> --save-dev ts-node-dev ts-loader</code></pre></div><p>We‚Äôll need to setup our TypeScript configuration; create a new file called <code class="language-text">tsconfig.json</code>:</p><div class="gatsby-highlight" data-language="json"><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"compilerOptions"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"module"</span><span class="token operator">:</span> <span class="token string">"commonjs"</span><span class="token punctuation">,</span>
    <span class="token property">"target"</span><span class="token operator">:</span> <span class="token string">"esnext"</span><span class="token punctuation">,</span>
    <span class="token property">"lib"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"es2015"</span><span class="token punctuation">,</span> <span class="token string">"es2017"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">"strict"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token property">"esModuleInterop"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token property">"skipLibCheck"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token property">"noUnusedLocals"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token property">"noUnusedParameters"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token property">"noImplicitAny"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token property">"removeComments"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token property">"preserveConstEnums"</span><span class="token operator">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"include"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"**/*.ts"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">"exclude"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"node_modules"</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span></code></pre></div><p>Next we‚Äôll want to download type definitions for our dependencies:</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> --save-dev <span class="token punctuation">\</span>
  @types/node <span class="token punctuation">\</span>
  @types/cors <span class="token punctuation">\</span>
  @types/cookie-parser <span class="token punctuation">\</span>
  @types/http-errors <span class="token punctuation">\</span></code></pre></div><p>We‚Äôll want to add a few <code class="language-text">scripts</code> to <code class="language-text">package.json</code> to utilize these dependencies. The only script we need at the moment is <code class="language-text">build</code> which will convert our TypeScript to JavaScript. We can remove the placeholder <code class="language-text">test</code> script for now. While we‚Äôre developing our action we‚Äôll need access to all of our project‚Äôs dependencies; but when we release our action we don‚Äôt want to include the testing, linting and TypeScript dependencies. Because of this, the difference between <code class="language-text">dependencies</code> and <code class="language-text">devDependencies</code> is important (as well as <code class="language-text">--save</code> versus <code class="language-text">--save-dev</code>).</p><p>Add the following scripts to <code class="language-text">package.json</code></p><div class="gatsby-highlight" data-language="json"><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"build"</span><span class="token operator">:</span> <span class="token string">"tsc --noEmit"</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span></code></pre></div></section>
<section><h2 id="keep-it-clean-optional" style="position:relative;"><a href="#keep-it-clean-optional" aria-label="keep it clean optional permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Keep it clean (optional)</h2><blockquote>
<p>Note: this section is not required to complete this tutorial; if you want to skip it feel free.</p>
</blockquote><p>Everyone has different preferences when they edit code. Some prefer tabs over spaces. Some want two spaces instead of four. Some prefer semicolons and some don‚Äôt. It shouldn‚Äôt matter right? But it does. If editors are auto-formatting code based on user preferences it is important to make sure everyone has chosen the same set of defaults for that auto-formatting. This makes it easy to tell what changed between versions ‚Äì even when different developers (with different preferences) have made changes.</p><p>For this reason we‚Äôll setup a linter and code formatter for our code. Install <a href="https://eslint.org/">eslint</a> and <a href="https://prettier.io/">prettier</a>:</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> --save-dev <span class="token punctuation">\</span>
  eslint <span class="token punctuation">\</span>
  @typescript-eslint/eslint-plugin <span class="token punctuation">\</span>
  @typescript-eslint/parser <span class="token punctuation">\</span>
  eslint-config-prettier <span class="token punctuation">\</span>
  eslint-plugin-prettier <span class="token punctuation">\</span>
  prettier</code></pre></div><p>Now that we have the packages we‚Äôll need to configure them in <code class="language-text">.eslintrc.json</code>. Create that file in your project root folder:</p><div class="gatsby-highlight" data-language="json"><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"parser"</span><span class="token operator">:</span> <span class="token string">"@typescript-eslint/parser"</span><span class="token punctuation">,</span>
  <span class="token property">"plugins"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"@typescript-eslint"</span><span class="token punctuation">,</span> <span class="token string">"prettier"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">"extends"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">"eslint:recommended"</span><span class="token punctuation">,</span>
    <span class="token string">"plugin:@typescript-eslint/recommended"</span><span class="token punctuation">,</span>
    <span class="token string">"plugin:prettier/recommended"</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">"rules"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"prettier/prettier"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token string">"error"</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        <span class="token property">"singleQuote"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token property">"trailingComma"</span><span class="token operator">:</span> <span class="token string">"all"</span><span class="token punctuation">,</span>
        <span class="token property">"bracketSpacing"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token property">"printWidth"</span><span class="token operator">:</span> <span class="token number">120</span><span class="token punctuation">,</span>
        <span class="token property">"tabWidth"</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
        <span class="token property">"semi"</span><span class="token operator">:</span> <span class="token boolean">false</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"env"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"node"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token property">"es6"</span><span class="token operator">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"parserOptions"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"ecmaVersion"</span><span class="token operator">:</span> <span class="token number">2018</span><span class="token punctuation">,</span>
    <span class="token property">"sourceType"</span><span class="token operator">:</span> <span class="token string">"module"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div><p>I won‚Äôt go into too much detail here; there are <a href="https://www.robertcooper.me/using-eslint-and-prettier-in-a-typescript-project">better explanations</a> to be found. This configuration does a few things:</p><ul>
<li>Relies on the TypeScript ESlint parser with the prettier plugin - I‚Äôve found this works very well in VS Code.</li>
<li>The expected environment should include <code class="language-text">node</code> - this will help <code class="language-text">eslint</code> ignore missing declarations for things like <code class="language-text">process</code>, <code class="language-text">module</code>, etc.</li>
</ul><p>If you need to ignore specific files when linting you can add them to <code class="language-text">.eslintignore</code>. Because our setup doesn‚Äôt work well for JavaScript we‚Äôll ignore all JavaScript files. Create <code class="language-text">.eslintignore</code> in the project root folder:</p><div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">*.js</code></pre></div><p>If you are using VS Code, you can install the <a href="https://marketplace.visualstudio.com/items?itemName=dbaeumer.vscode-eslint">ESLint extension</a> so you can see lint warnings in your editor. Additionally, we can add a <code class="language-text">lint</code> item to the <code class="language-text">scripts</code> node in <code class="language-text">package.json</code> so that we can check for lint warnings when building and deploying:</p><div class="gatsby-highlight" data-language="json"><pre class="language-json"><code class="language-json">  <span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"build"</span><span class="token operator">:</span> <span class="token string">"tsc --noEmit"</span><span class="token punctuation">,</span>
    <span class="token property">"lint"</span><span class="token operator">:</span> <span class="token string">"eslint . --ext .ts"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span></code></pre></div><p>With this in place we can run:</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">npm</span> run lint</code></pre></div><p>Wait, there‚Äôs an error:</p><div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">Oops! Something went wrong! :(

ESLint: 7.24.0

No files matching the pattern &quot;.&quot; were found.
Please check for typing mistakes in the pattern.</code></pre></div><p>We haven‚Äôt written any TypeScript to lint yet.</p><h3 id="prettier--code-classlanguage-textprettierrccode" style="position:relative;"><a href="#prettier--code-classlanguage-textprettierrccode" aria-label="prettier  code classlanguage textprettierrccode permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Prettier &#x26; <code class="language-text">.prettierrc</code></h3><p>Prettier works to auto-format your code based on a shared configuration. If you are using VSCode you can install the <a href="https://marketplace.visualstudio.com/items?itemName=esbenp.prettier-vscode">prettier extension</a> and it will auto-format your code every time you save. The configuration is setup in the <code class="language-text">.prettierrc</code> file. Create <code class="language-text">.prettierrc</code>. I tend to use the following setup:</p><div class="gatsby-highlight" data-language="json"><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"endOfLine"</span><span class="token operator">:</span> <span class="token string">"lf"</span><span class="token punctuation">,</span>
  <span class="token property">"semi"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token property">"singleQuote"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token property">"tabWidth"</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
  <span class="token property">"trailingComma"</span><span class="token operator">:</span> <span class="token string">"all"</span><span class="token punctuation">,</span>
  <span class="token property">"bracketSpacing"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token property">"jsxBracketSameLine"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token property">"printWidth"</span><span class="token operator">:</span> <span class="token number">120</span>
<span class="token punctuation">}</span></code></pre></div><p>You might have different preferences in your project. That‚Äôs fine, so long as all of the developers working on the code agree. For more information on the available options, view the <a href="https://prettier.io/docs/en/options.html">Prettier docs</a>.</p><p>There are some files in our project that we shouldn‚Äôt (or don‚Äôt want to) prettify. The reasons we might not want to run Prettier vary but include: different formatting preferences, external libraries, generated files, frequency of change, or speed. Luckily we can tell Prettier to ignore files. Add a <code class="language-text">.prettierignore</code> file:</p><div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">package.json
package-lock.json
node_modules</code></pre></div><p>Time to stop configuring and start writing code.</p></section>
<section><h2 id="building-the-express-api" style="position:relative;"><a href="#building-the-express-api" aria-label="building the express api permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Building the Express API</h2><p>Express applications can be very simple - all of the logic can be contained in a single file. As your project becomes more complex this can become very confusing. Because of this, we‚Äôll use files and folders that help us keep the project organized:</p><div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">api/
  |- .env
  |- src/
  |  |- app.ts
  |  |- env.ts
  |  |- lambda.ts
  |  |- local.ts
  |  |- middleware/
  |  |  |- error.ts
  |  |  |- not-found.ts
  |  |- routes/
  |  |  |- index.ts
  |  |  |- ok.ts</code></pre></div><h3 id="main-application" style="position:relative;"><a href="#main-application" aria-label="main application permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Main Application</h3><p>Even though it is not required, it is common to put the main application logic in a file called <code class="language-text">app.ts</code> (or <code class="language-text">app.js</code> if you are not using TypeScript). That‚Äôs the name the <a href="https://expressjs.com/en/starter/generator.html">Express application generator</a> chooses (which we are not using). In our case we‚Äôll want to store all of the code for our application in a <code class="language-text">src</code> folder to keep things organized. Create <code class="language-text">src/app.ts</code> and copy the following:</p><div class="gatsby-highlight" data-language="typescript"><pre class="language-typescript"><code class="language-typescript"><span class="token keyword">import</span> express <span class="token keyword">from</span> <span class="token string">'express'</span>
<span class="token keyword">import</span> cookieParser <span class="token keyword">from</span> <span class="token string">'cookie-parser'</span>
<span class="token keyword">import</span> cors <span class="token keyword">from</span> <span class="token string">'cors'</span>
<span class="token keyword">import</span> helmet <span class="token keyword">from</span> <span class="token string">'helmet'</span>
<span class="token keyword">import</span> router <span class="token keyword">from</span> <span class="token string">'./routes'</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> errorMiddleware <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./middleware/error'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> notFoundMiddleware <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./middleware/not-found'</span>

<span class="token comment">// Create the Express app</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// Setup middleware for our API</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">urlencoded</span><span class="token punctuation">(</span><span class="token punctuation">{</span> extended<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">cookieParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">helmet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">cors</span><span class="token punctuation">(</span><span class="token punctuation">{</span> credentials<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">// The aws-serverless-express library creates a server and listens on a Unix</span>
<span class="token comment">// Domain Socket for you, so you don't need the usual call to app.listen.</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> router<span class="token punctuation">)</span>

<span class="token comment">// If the user tries to access any path which doesn't exist, and there was no error, return a 404</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>notFoundMiddleware<span class="token punctuation">)</span>

<span class="token comment">// Error handling middleware should be loaded after the loading the routes</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>errorMiddleware<span class="token punctuation">)</span>

<span class="token comment">// Export your express server so it can be reused depending on how the server is run.</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> app</code></pre></div><p>After creating the default <code class="language-text">express</code> application we begin using specific <em>middleware</em>. Express applications receive a request (containing <code class="language-text">params</code> and other information) and return a response (in our case, containing JSON). The <a href="https://expressjs.com/en/guide/using-middleware.html">middleware pattern</a> allows us to treat this request-response cycle as a pipeline using specific functions:</p><div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> customMiddleware <span class="token operator">=</span> <span class="token punctuation">(</span>request<span class="token operator">:</span> Request<span class="token punctuation">,</span> response<span class="token operator">:</span> Response<span class="token punctuation">,</span> next<span class="token operator">:</span> NextFunction<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Time:'</span><span class="token punctuation">,</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div><p>The <code class="language-text">customMiddleware</code> function receives the <code class="language-text">request</code> and <code class="language-text">response</code> objects and can modify them before allowing the middleware pipeline to move to the next middleware function.</p><p>When setting up our application we‚Äôve specified that our application should <code class="language-text">use</code> a common set of middleware:</p><ul>
<li><code class="language-text">express.json()</code>: allows our application to handle JSON requests</li>
<li><code class="language-text">express.urlencoded({ extended: true })</code>: allows our application to handle URL encoded parameters</li>
<li><code class="language-text">cookieParser()</code>: parses any cookie headers sent to our application</li>
<li><code class="language-text">helmet()</code>: introduces a set of security-related middleware including default content security policies</li>
<li><code class="language-text">cors({ credentials: true })</code>: allows our API to be called from other domains by returning correct Cross-Origin Resource Sharing responses</li>
</ul><p>The routes - or paths - that your API handles can also be treated as middleware. We‚Äôll store those in a separate folder so that we can keep the logic separate. For now, we‚Äôve included them in our application in the correct order. We want to process all of our routes <em>after</em> our security middleware and serverless middleware and <em>before</em> any of our error handling middleware.</p><p>Our error handling middleware comes last so that we can catch any errors that happen within our routes (or security middleware). We haven‚Äôt written our <code class="language-text">notFoundMiddleware</code> or <code class="language-text">errorMiddleware</code> yet.</p><p>Finally, we export the application. This isn‚Äôt strictly necessary; but it will simplify our tests later.</p><h3 id="middleware" style="position:relative;"><a href="#middleware" aria-label="middleware permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Middleware</h3><p>We haven‚Äôt written any middleware yet - let‚Äôs do that now. Create a new folder in the <code class="language-text">src</code> directory called <code class="language-text">middleware</code>. Then create a new file called <code class="language-text">src/middleware/not-found.ts</code>:</p><div class="gatsby-highlight" data-language="typescript"><pre class="language-typescript"><code class="language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{</span> Request<span class="token punctuation">,</span> Response<span class="token punctuation">,</span> NextFunction <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'express'</span>
<span class="token keyword">import</span> createError <span class="token keyword">from</span> <span class="token string">'http-errors'</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> notFoundMiddleware <span class="token operator">=</span> <span class="token punctuation">(</span>_request<span class="token operator">:</span> Request<span class="token punctuation">,</span> _response<span class="token operator">:</span> Response<span class="token punctuation">,</span> next<span class="token operator">:</span> NextFunction<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token function">createError</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div><p>This is a very simple function that creates a <code class="language-text">404</code> not found error if no response has been returned by a previous route middleware.<label for="sd-why-do-the-less-than" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sd-why-do-the-less-than" class="margin-toggle" /><span class="sidenote">Why do the <code>_request</code> and <code>_response</code> parameters start with an underscore (<code>_</code>)? One of our linter rules states that there can be <code>no-unused-vars</code>. Unfortunately we need to include them so that we can access the third parameter: <code>next</code>. By adding an <code>_</code> to the beginning of the parameter name it indicates that we won't use that parameter and the linter can safely ignore it.</span></p><p>Next, create a new file called <code class="language-text">src/middleware/error.ts</code>:</p><div class="gatsby-highlight" data-language="typescript"><pre class="language-typescript"><code class="language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{</span> HttpError <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'http-errors'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Request<span class="token punctuation">,</span> Response<span class="token punctuation">,</span> NextFunction <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'express'</span>

<span class="token comment">// Error handler (must have all four parameters)</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> errorMiddleware <span class="token operator">=</span> <span class="token punctuation">(</span>
  error<span class="token operator">:</span> HttpError<span class="token punctuation">,</span>
  _request<span class="token operator">:</span> Request<span class="token punctuation">,</span>
  response<span class="token operator">:</span> Response<span class="token punctuation">,</span>
  <span class="token comment">// eslint-disable-next-line @typescript-eslint/no-unused-vars</span>
  _next<span class="token operator">:</span> NextFunction<span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> message <span class="token operator">=</span> <span class="token punctuation">(</span>error<span class="token punctuation">.</span>expose <span class="token operator">?</span> error<span class="token punctuation">.</span>message <span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">'Internal Server Error'</span>
  response<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span>error<span class="token punctuation">.</span>statusCode <span class="token operator">||</span> <span class="token number">500</span><span class="token punctuation">)</span>
  response<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> error<span class="token operator">:</span> message<span class="token punctuation">,</span> statusCode<span class="token operator">:</span> error<span class="token punctuation">.</span>statusCode <span class="token operator">||</span> <span class="token number">500</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div><p>This middleware is slightly different - when creating an error middleware you must include all four parameters in the function signature for Express to use it. We have to include the fourth parameter even though we won‚Äôt use it. Because of this we have to disable the <code class="language-text">no-unused-vars</code> linter warning for the last parameter (even though it starts with an underscore).</p><p>In the handler we attempt to respond with information about the error that occurred. If there is an exception within one of our routes, Express will catch the exception and funnel it through the <code class="language-text">errorMiddleware</code>.</p><h3 id="routes" style="position:relative;"><a href="#routes" aria-label="routes permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Routes</h3><p>We haven‚Äôt written any route-handling code for our Express application. Like our middleware, we‚Äôll organize our route logic in separate files within a <code class="language-text">src/routes</code> folder. We‚Äôll create a default <code class="language-text">src/routes/index.ts</code> to manage all of the routes. Create <code class="language-text">src/routes/index.ts</code>:</p><div class="gatsby-highlight" data-language="typescript"><pre class="language-typescript"><code class="language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{</span> Router <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'express'</span>
<span class="token keyword">import</span> okRoutes <span class="token keyword">from</span> <span class="token string">'./ok'</span>

<span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

router<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/ok'</span><span class="token punctuation">,</span> okRoutes<span class="token punctuation">)</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> router</code></pre></div><p>To start, we create and export a basic express router. For now we‚Äôve included a single route handler that responds to <code class="language-text">/ok</code>. We‚Äôll be adding more routes soon.<label for="sd-why-did-we-choose-to" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sd-why-did-we-choose-to" class="margin-toggle" /><span class="sidenote">Why did we choose to make an API endpoint for <code>/ok</code> instead of the root route <code>/</code> to test things? Because we've setup our API Gateway as a proxy for <code>/{proxy+}</code>, the root route <code>/</code> won't ever be passed to our Express server (it must have an additional path part of the route). If you attempt to fetch the root route (for example, in a browser) you'll see <code>{'message':"Missing Authentication Token"}</code> regardless of how your Express server is setup. We might have also chosen <code>/ping</code> which is commonly used for health checks. Unfortunately this route is reserved by API Gateway and returns the health status of the gateway itself and will also never be passed to the Express server.</span></p><p>Next, we need to create the <code class="language-text">ok</code> route handler. Create <code class="language-text">src/routes/ok.ts</code>:</p><div class="gatsby-highlight" data-language="typescript"><pre class="language-typescript"><code class="language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{</span> Router <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'express'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> getCurrentInvoke <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@vendia/serverless-express'</span>

<span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

router<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>_request<span class="token punctuation">,</span> response<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>

  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'GET ok'</span><span class="token punctuation">)</span>

  <span class="token keyword">const</span> <span class="token punctuation">{</span> event<span class="token punctuation">,</span> context <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">getCurrentInvoke</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Serverless Event: '</span> <span class="token operator">+</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Serverless Context: '</span> <span class="token operator">+</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">)</span>

  response<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    ok<span class="token operator">:</span> <span class="token string">'ok'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> router</code></pre></div><p>Our <code class="language-text">ok</code> router handles a <code class="language-text">GET</code> request and returns a simple JSON response. We also log some information about the request. In general, you wouldn‚Äôt want to use this in a production application as you might accidentally log private information. For now, it will help us see how the server is working.</p></section>
<section><h2 id="setting-up-the-lambda-handler-function" style="position:relative;"><a href="#setting-up-the-lambda-handler-function" aria-label="setting up the lambda handler function permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Setting up the Lambda handler function</h2><p>Notice that we aren‚Äôt calling <code class="language-text">app.listen</code> in <code class="language-text">app.ts</code> as we normally would in an Express application. When our server is running within AWS lambda, we don‚Äôt want to listen on a port to receive requests; instead we‚Äôll build a custom AWS handler function and pass the request to our Express server directly.</p><p>Create a new file called <code class="language-text">src/lambda.ts</code>:</p><div class="gatsby-highlight" data-language="typescript"><pre class="language-typescript"><code class="language-typescript"><span class="token keyword">import</span> serverlessExpress <span class="token keyword">from</span> <span class="token string">'@vendia/serverless-express'</span>
<span class="token keyword">import</span> app <span class="token keyword">from</span> <span class="token string">'./app'</span>

exports<span class="token punctuation">.</span>handler <span class="token operator">=</span> <span class="token function">serverlessExpress</span><span class="token punctuation">(</span><span class="token punctuation">{</span> app <span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div><p>We‚Äôll configure our AWS Lambda function to call this handler which will then pass the request to our Express application. Even if we add more routes to our Express application, we won‚Äôt need to change this simple handler.</p></section>
<section><h2 id="setting-up-a-local-server-for-development" style="position:relative;"><a href="#setting-up-a-local-server-for-development" aria-label="setting up a local server for development permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Setting up a local server for development</h2><p>We‚Äôve setup our Express app and added a Lambda handler wrapper for it for production, but it is still difficult for us to test our application locally. Create a file called <code class="language-text">src/local.ts</code>:</p><div class="gatsby-highlight" data-language="typescript"><pre class="language-typescript"><code class="language-typescript"><span class="token keyword">import</span> <span class="token string">'./env'</span>
<span class="token keyword">import</span> app <span class="token keyword">from</span> <span class="token string">'./app'</span>

<span class="token keyword">const</span> port <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">[</span><span class="token string">'PORT'</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token number">4000</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Listening on http://localhost:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>port<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span></code></pre></div><p>Like <code class="language-text">lambda.ts</code>, this wrapper is very simple. It loads our configuration and sets the application to listen on a  port (by default, port <code class="language-text">4000</code>). When running in development mode we‚Äôll need to manage our environment variables manually. Add the following dependency:</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> --save-dev dotenv</code></pre></div><p>Notice that we‚Äôre saving this as a development dependency. We won‚Äôt need these for our Lambda function and we want to keep it as small as possible. Next create a new file called <code class="language-text">env.ts</code>:</p><div class="gatsby-highlight" data-language="typescript"><pre class="language-typescript"><code class="language-typescript"><span class="token keyword">import</span> dotenv <span class="token keyword">from</span> <span class="token string">'dotenv'</span>

dotenv<span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> dotenv</code></pre></div><p>This will automatically load a file called <code class="language-text">.env</code> where we can keep local environment variables. For now, the only local environment variable we want to set is the <code class="language-text">NODE_ENV</code>. Create a file called <code class="language-text">.env</code> in the project root folder:</p><div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">NODE_ENV=development</code></pre></div><p>We‚Äôll add more variables to our environment later, but for now this is all we need.</p><p>To use <code class="language-text">local.ts</code>, we‚Äôll change <code class="language-text">package.json</code> so that the <code class="language-text">start</code> script loads it when starting in development mode:</p><div class="gatsby-highlight" data-language="json"><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token property">"start"</span><span class="token operator">:</span> <span class="token string">"ts-node-dev --respawn --pretty --transpile-only src/local.ts"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span></code></pre></div><p>Notice that we execute <code class="language-text">local.ts</code> using <code class="language-text">ts-node-dev</code>. This will watch our project folder for changes and reload and restart our server automatically while recompiling our TypeScript.</p><p>You can start the server by running:</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">npm</span> start</code></pre></div><p>You should see (your version numbers might be different):</p><div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">[INFO] 07:53:57 ts-node-dev ver. 1.1.6 (using ts-node ver. 9.1.1, typescript ver. 4.2.4)
Listening on http://localhost:4000</code></pre></div><p>If you open <a href="http://localhost:4000/ok">http://localhost:4000/ok</a> you should see:</p><div class="gatsby-highlight" data-language="json"><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span><span class="token property">"ok"</span><span class="token operator">:</span> <span class="token string">"ok"</span><span class="token punctuation">}</span></code></pre></div><p>Not very exciting content, but this is our first JSON API response!</p><h1 id="save-our-progress" style="position:relative;"><a href="#save-our-progress" aria-label="save our progress permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Save our progress</h1><p>We‚Äôll want to use version control to keep track of our changes. We‚Äôll use <code class="language-text">git</code>:</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">git</span> init</code></pre></div></section>
<section><h2 id="ignore-some-things" style="position:relative;"><a href="#ignore-some-things" aria-label="ignore some things permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Ignore some things</h2><p>Let‚Äôs make sure to ignore our environment variables (which may include sensitive secrets) and some of the files we‚Äôve generated. Create a <code class="language-text">.gitignore</code> file in the project root folder:</p><div class="gatsby-highlight" data-language="gitignore"><pre class="language-gitignore"><code class="language-gitignore"><span class="token comment"># Ignore built releases</span>
<span class="token entry string">dist<span class="token punctuation">/</span><span class="token operator">*</span></span>

<span class="token comment"># =========================</span>
<span class="token comment"># Node.js-Specific Ignores</span>
<span class="token comment"># =========================</span>

<span class="token comment"># Ignore any localstack configuration</span>
<span class="token entry string">.localstack<span class="token operator">*</span></span>

<span class="token comment"># Logs</span>
<span class="token entry string">logs</span>
<span class="token entry string"><span class="token operator">*</span>.log</span>
<span class="token entry string">npm-debug.log<span class="token operator">*</span></span>
<span class="token entry string">yarn-debug.log<span class="token operator">*</span></span>
<span class="token entry string">yarn-error.log<span class="token operator">*</span></span>

<span class="token comment"># Runtime data</span>
<span class="token entry string">pids</span>
<span class="token entry string"><span class="token operator">*</span>.pid</span>
<span class="token entry string"><span class="token operator">*</span>.seed</span>
<span class="token entry string"><span class="token operator">*</span>.pid.lock</span>

<span class="token comment"># Directory for instrumented libs generated by jscoverage/JSCover</span>
<span class="token entry string">lib-cov</span>

<span class="token comment"># Coverage directory used by tools like istanbul</span>
<span class="token entry string">coverage</span>

<span class="token comment"># nyc test coverage</span>
<span class="token entry string">.nyc_output</span>

<span class="token comment"># Ignore test runner output</span>
<span class="token entry string">__tests__<span class="token punctuation">/</span>runner<span class="token punctuation">/</span><span class="token operator">*</span></span>

<span class="token comment"># Grunt intermediate storage (http://gruntjs.com/creating-plugins#storing-task-files)</span>
<span class="token entry string">.grunt</span>

<span class="token comment"># Bower dependency directory (https://bower.io/)</span>
<span class="token entry string">bower_components</span>

<span class="token comment"># node-waf configuration</span>
<span class="token entry string">.lock-wscript</span>

<span class="token comment"># Compiled binary addons (https://nodejs.org/api/addons.html)</span>
<span class="token entry string">build<span class="token punctuation">/</span>Release</span>

<span class="token comment"># Dependency directories</span>
<span class="token entry string">node_modules<span class="token punctuation">/</span></span>
<span class="token entry string">jspm_packages<span class="token punctuation">/</span></span>

<span class="token comment"># Typescript v1 declaration files</span>
<span class="token entry string">typings<span class="token punctuation">/</span></span>

<span class="token comment"># Optional npm cache directory</span>
<span class="token entry string">.npm</span>

<span class="token comment"># Optional eslint cache</span>
<span class="token entry string">.eslintcache</span>

<span class="token comment"># Optional REPL history</span>
<span class="token entry string">.node_repl_history</span>

<span class="token comment"># Output of 'npm pack'</span>
<span class="token entry string"><span class="token operator">*</span>.tgz</span>

<span class="token comment"># Yarn Integrity file</span>
<span class="token entry string">.yarn-integrity</span>

<span class="token comment"># dotenv environment variables file</span>
<span class="token entry string">.env</span>

<span class="token comment"># =========================</span>
<span class="token comment"># Operating System Files</span>
<span class="token comment"># =========================</span>

<span class="token comment"># OSX</span>
<span class="token comment"># =========================</span>

<span class="token entry string">.DS_Store</span>
<span class="token entry string">.AppleDouble</span>
<span class="token entry string">.LSOverride</span>

<span class="token comment"># Thumbnails</span>
<span class="token entry string">._<span class="token operator">*</span></span>

<span class="token comment"># Files that might appear on external disk</span>
<span class="token entry string">.Spotlight-V100</span>
<span class="token entry string">.Trashes</span>

<span class="token comment"># Directories potentially created on remote AFP share</span>
<span class="token entry string">.AppleDB</span>
<span class="token entry string">.AppleDesktop</span>
<span class="token entry string">Network Trash Folder</span>
<span class="token entry string">Temporary Items</span>
<span class="token entry string">.apdisk</span>

<span class="token comment"># Windows</span>
<span class="token comment"># =========================</span>

<span class="token comment"># Windows image file caches</span>
<span class="token entry string">Thumbs.db</span>
<span class="token entry string">ehthumbs.db</span>

<span class="token comment"># Folder config file</span>
<span class="token entry string">Desktop.ini</span>

<span class="token comment"># Recycle Bin used on file shares</span>
<span class="token entry string">$RECYCLE.BIN<span class="token punctuation">/</span></span>

<span class="token comment"># Windows Installer files</span>
<span class="token entry string"><span class="token operator">*</span>.cab</span>
<span class="token entry string"><span class="token operator">*</span>.msi</span>
<span class="token entry string"><span class="token operator">*</span>.msm</span>
<span class="token entry string"><span class="token operator">*</span>.msp</span>

<span class="token comment"># Windows shortcuts</span>
<span class="token entry string"><span class="token operator">*</span>.lnk</span></code></pre></div></section>
<section><h2 id="commit" style="position:relative;"><a href="#commit" aria-label="commit permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Commit</h2><p>To add all of the files and commit them to the repository we‚Äôll use <a href="https://desktop.github.com">GitHub Desktop</a>:</p><p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1189px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/54e2d7427e086560b08282a53b207a91/1790f/express-github-desktop.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 75%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsSAAALEgHS3X78AAAC3ElEQVQ4y3VTXU/TYBhtxBgDBgYyxtqu7frd9WvrNrZ13fcnQjBGjVwYY7xWgsbEaPwL3gl44T8l9Pi0gjDFi5Pz9mnek/M8z3kZP6hflLwAuuXFqunA9mvwggb0ko/k2y3XUW9105ph+1T3bkOcsuVdMFatj1I1ik23Co1ELDcgVKBaHgwngOlUYJOocflfMVwo5iJkqqmWH+teBYzbeRzvtPvwa2FsVqrYaLzC/fATlP4Y/qwMs08XWjL4poRsXfwf4oS3dqSY8TsHKNeaEFUbsutiufcRzPQn+Mku1EkR8kgFPxCQiVistfMENj2vR785014E44dT1GvUjqZDLWl4EB3hzuQE/GgGeVyEvh9AmdnQxjqMsQJhIIHtCeAIG20OmZDD+g0wxsFnOHvvwLbfgO+9xvLwK5Ym38FNdyGOJMi7PvJ9GblOAVxfxHa3kAqtXyITsn/OCRhr/hbm4CVytecQohdYGXwhwRPkSbAwlMANTWx2BKzRxdVWPuXMDfwtyriNEapBGYZu0KZUrHSOSPAU0t5TmHOKzjwAR3PMkcvNrngpdO3uX4eNOYJGROhC88tY7hzj7vQUwu4B5IkGcWpje6ASFDyMeGQj7np2t7XshI8ouBE0izLmOOTwGEvTM7DUsj4rQZ5VwA8tiBMbBVqMSG43SHjthtBCy5pbowCXKZwOtexipZ04PENuOgfbL4AdGASdzhrYoZq63eyI5LawIHbFTMnx6AWUodvlBUF2tpfmLz/QsNWTaIZF5HrF9Jyn9hO+bTlMrdGKdSd5am4s6zbl8H06Q26+n265MLTpMgl1pRRZWkyCZPPrV62GXJyKhmzMSKoFXpRjViiiICnk8AOWZj/AJoIjGcLYI0cqsuRo69LhFZKtJ/WHlFF6JXHastJ8cq53DmF1D2Ol9Qyr0THujb5RVGYQyQXfNbHVpsuhQCwiF5FL4mxILls0xwabIE65yZ7/AtTfxnzA5/k7AAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="Create a commit titled &#39;Initial commit&#39;"
        title="Create a commit titled &#39;Initial commit&#39;"
        src="/static/54e2d7427e086560b08282a53b207a91/1790f/express-github-desktop.png"
        srcset="/static/54e2d7427e086560b08282a53b207a91/72799/express-github-desktop.png 320w,
/static/54e2d7427e086560b08282a53b207a91/6af66/express-github-desktop.png 640w,
/static/54e2d7427e086560b08282a53b207a91/1790f/express-github-desktop.png 1189w"
        sizes="(max-width: 1189px) 100vw, 1189px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
      />
  </a>
    </span></p><h1 id="deploying" style="position:relative;"><a href="#deploying" aria-label="deploying permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Deploying</h1><p>We‚Äôll use the <code class="language-text">terrform</code> setup from the <a href="./terraform-and-aws">previous post</a> to deploy our Express application to AWS Lambda. To do this we‚Äôll need to do the following:</p><ul>
<li>Install only the production dependencies</li>
<li>Build and compress the release and copy them to the <code class="language-text">terraform</code> folder</li>
<li>Use terraform to deploy our changes</li>
</ul></section>
<section><h2 id="install-only-the-production-dependencies" style="position:relative;"><a href="#install-only-the-production-dependencies" aria-label="install only the production dependencies permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Install only the production dependencies</h2><p>While working locally, we‚Äôve been using some development packages. These aren‚Äôt needed for our production application so we‚Äôll want to remove them (to make our build smaller and startup time faster). If you‚Äôre running your server locally, stop it (use <code class="language-text">Ctrl+C</code>).</p><p>Next, let‚Äôs prune the dependencies to only production packages:</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">npm</span> prune --production</code></pre></div></section>
<section><h2 id="build-and-compress-the-release" style="position:relative;"><a href="#build-and-compress-the-release" aria-label="build and compress the release permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Build and compress the release</h2><p>We‚Äôll need to package all of the files into a release for deployment. There are a few ways to do this, each with tradeoffs. To start, we‚Äôll simply compress all of the source code and dependencies into a single zip file. This is far less efficient and will include many files our production application won‚Äôt need - but it will make the process simpler and easier to debug.</p><p>Add the <code class="language-text">zip</code> script to your <code class="language-text">package.json</code>:</p><div class="gatsby-highlight" data-language="json"><pre class="language-json"><code class="language-json">  ...
  <span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"zip"</span><span class="token operator">:</span> <span class="token string">"zip -r ../terraform/api.zip *.js package* node_modules"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  ...</code></pre></div><p>This creates a file called <code class="language-text">api.zip</code> in the terraform folder. If you‚Äôve named your folders differently (or put them in different locations) you may need to change this.</p><p>Run the command:</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">npm</span> run <span class="token function">zip</span></code></pre></div><p>The zip file is created but it is very large: <code class="language-text">8.0M</code>. We‚Äôll want to make this smaller. Re-install your development dependencies:</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span></code></pre></div><p>Instead of including everything, we should build our release using a tool like <a href="https://webpack.js.org/">Webpack</a>. Webpack allows you to transpile and minify your source code into a single JavaScript file; bundling all of the dependencies in the most efficient way. It will also save the hassle of pruning and re-installing dependencies. Let‚Äôs install it:</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> --save-dev webpack webpack-cli</code></pre></div><p>Next, we‚Äôll want to create a configuration for Webpack. For now, we‚Äôll focus only on the production build that we plan to upload to AWS. Create a file called <code class="language-text">webpack.config.js</code> in the project root folder:</p><div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  entry<span class="token operator">:</span> <span class="token string">'./src/lambda.ts'</span><span class="token punctuation">,</span>
  output<span class="token operator">:</span> <span class="token punctuation">{</span>
    library<span class="token operator">:</span> <span class="token string">'api'</span><span class="token punctuation">,</span>
    libraryTarget<span class="token operator">:</span> <span class="token string">'umd'</span><span class="token punctuation">,</span>
    umdNamedDefine<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    path<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    filename<span class="token operator">:</span> <span class="token string">'api.js'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  resolve<span class="token operator">:</span> <span class="token punctuation">{</span>
    extensions<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'.ts'</span><span class="token punctuation">,</span> <span class="token string">'.tsx'</span><span class="token punctuation">,</span> <span class="token string">'.js'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    modules<span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token string">'node_modules'</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  target<span class="token operator">:</span> <span class="token string">'node'</span><span class="token punctuation">,</span>
  mode<span class="token operator">:</span> <span class="token string">'production'</span><span class="token punctuation">,</span>
  module<span class="token operator">:</span> <span class="token punctuation">{</span>
    rules<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
      <span class="token comment">// all files with a `.ts` or `.tsx` extension will be handled by `ts-loader`</span>
      test<span class="token operator">:</span> <span class="token regex">/\.tsx?$/</span><span class="token punctuation">,</span>
      use<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
        loader<span class="token operator">:</span> <span class="token string">'ts-loader'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div><p>This configuration tells Webpack to start with <code class="language-text">./src/lambda.ts</code> and export a bundled release called <code class="language-text">dist/api.js</code> which will be used as an API and has a <em>Universal Module Declaration</em> (our exported <code class="language-text">handler</code> function). We‚Äôve set our target to <code class="language-text">node</code> meaning we plan to run the generated file using Node (we don‚Äôt plan to run it in a browser).</p><p>To run <code class="language-text">webpack</code> we need to add another script to our <code class="language-text">package.json</code>:</p><div class="gatsby-highlight has-highlighted-lines" data-language="json"><pre class="language-json"><code class="language-json">  ...
  <span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"build"</span><span class="token operator">:</span> <span class="token string">"tsc --noEmit &amp;&amp; webpack"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  ...</code></pre></div><p>Run it:</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">npm</span> run build</code></pre></div><p>You should see:</p><div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">asset api.js 587 KiB [compared for emit] [minimized] (name: main) 1 related asset
runtime modules 211 bytes 2 modules
modules by path ./node_modules/ 769 KiB
  javascript modules 510 KiB 85 modules
  json modules 258 KiB
    modules by path ./node_modules/iconv-lite/encodings/tables/*.json 86.7 KiB 8 modules
    3 modules
modules by path ./src/ 4.18 KiB
  modules by path ./src/*.ts 2.45 KiB 2 modules
  modules by path ./src/routes/*.ts 760 bytes
    ./src/routes/index.ts 395 bytes [built] [code generated]
    ./src/routes/ok.ts 365 bytes [built] [code generated]
  modules by path ./src/middleware/*.ts 1010 bytes
    ./src/middleware/error.ts 546 bytes [built] [code generated]
    ./src/middleware/not-found.ts 466 bytes [built] [code generated]
14 modules

WARNING in ./node_modules/express/lib/view.js 81:13-25
Critical dependency: the request of a dependency is an expression
 @ ./node_modules/express/lib/application.js 22:11-28
 @ ./node_modules/express/lib/express.js 18:12-36
 @ ./node_modules/express/index.js 11:0-41
 @ ./src/app.ts 6:34-52
 @ ./src/lambda.ts 8:30-46

1 warning has detailed information that is not shown.
Use &#39;stats.errorDetails: true&#39; resp. &#39;--stats-error-details&#39; to show it.

webpack 5.34.0 compiled with 1 warning in 4393 ms</code></pre></div><p>The compiled size is now <code class="language-text">769 KiB</code>! That is much smaller than <code class="language-text">8 MB</code>. Unfortunately, you may also see a <code class="language-text">Critical Dependency</code> warning<label for="sd-more-information" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sd-more-information" class="margin-toggle" /><span class="sidenote">More information about this error can be found <a href="https://github.com/webpack/webpack/issues/1576#issuecomment-475118999">on GitHub</a>.</span>. Why are we getting this warning? Express loads its view engines using a dynamic require:</p><div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">var fn = require(mod).__express</code></pre></div><p>Webpack isn‚Äôt sure how to handle this; but luckily we don‚Äôt really care because we‚Äôre not using any view engines. Because of this we can just ignore the warning. If, like me, this bothers you then there are a few options:</p><ol>
<li>Exclude all <code class="language-text">nodeExternals</code> - this will prevent Webpack from bundling any of the <code class="language-text">node_modules</code> in our build</li>
<li>Exclude <code class="language-text">express</code> - this will prevent Webpack from bundling the <code class="language-text">express</code> package in our build</li>
<li>Silence the warning</li>
</ol><p>The first option makes the build incredibly small (less than <code class="language-text">1 Kib</code>), but unfortunately doesn‚Äôt work at all. Because we‚Äôre running on AWS Lambda we need the node modules to be bundled. This also means option 2 won‚Äôt work. Our only option is to silence the warning. Change <code class="language-text">webpack.config.js</code>:</p><div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  entry<span class="token operator">:</span> <span class="token string">'./src/lambda.ts'</span><span class="token punctuation">,</span>
  output<span class="token operator">:</span> <span class="token punctuation">{</span>
    library<span class="token operator">:</span> <span class="token string">'api'</span><span class="token punctuation">,</span>
    libraryTarget<span class="token operator">:</span> <span class="token string">'umd'</span><span class="token punctuation">,</span>
    umdNamedDefine<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    path<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    filename<span class="token operator">:</span> <span class="token string">'api.js'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  resolve<span class="token operator">:</span> <span class="token punctuation">{</span>
    extensions<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'.ts'</span><span class="token punctuation">,</span> <span class="token string">'.tsx'</span><span class="token punctuation">,</span> <span class="token string">'.js'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    modules<span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token string">'node_modules'</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  target<span class="token operator">:</span> <span class="token string">'node'</span><span class="token punctuation">,</span>
  mode<span class="token operator">:</span> <span class="token string">'production'</span><span class="token punctuation">,</span>
  ignoreWarnings<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token regex">/^(?!CriticalDependenciesWarning$)/</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  module<span class="token operator">:</span> <span class="token punctuation">{</span>
    rules<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
      <span class="token comment">// all files with a `.ts` or `.tsx` extension will be handled by `ts-loader`</span>
      test<span class="token operator">:</span> <span class="token regex">/\.tsx?$/</span><span class="token punctuation">,</span>
      use<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
        loader<span class="token operator">:</span> <span class="token string">'ts-loader'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div><p>Let‚Äôs change our <code class="language-text">zip</code> script in <code class="language-text">package.json</code> to use this new file. Also, we‚Äôll add a new <code class="language-text">release</code> script that combines the <code class="language-text">build</code> and <code class="language-text">zip</code> scripts:</p><div class="gatsby-highlight" data-language="json"><pre class="language-json"><code class="language-json">  <span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    ...
    <span class="token property">"zip"</span><span class="token operator">:</span> <span class="token string">"cd dist; zip -r ../../terraform/api.zip api.js"</span><span class="token punctuation">,</span>
    <span class="token property">"release"</span><span class="token operator">:</span> <span class="token string">"npm run build &amp;&amp; npm run zip"</span>
    ...
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  ...</code></pre></div><p>Run the <code class="language-text">release</code>:</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">npm</span> run release</code></pre></div><p>Our compressed <code class="language-text">api.zip</code> is only <code class="language-text">235 KiB</code>.</p><h3 id="remove-the-extracted-comments" style="position:relative;"><a href="#remove-the-extracted-comments" aria-label="remove the extracted comments permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Remove the extracted comments</h3><p>In newer versions of webpack the comments will be automatically extracted and placed in a <code class="language-text">LICENSE.txt</code> file. If you want to avoid this you can turn off comment extraction in your <code class="language-text">webpack.config.js</code>:</p><div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> TerserPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"terser-webpack-plugin"</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  entry<span class="token operator">:</span> <span class="token string">'./src/lambda.ts'</span><span class="token punctuation">,</span>
  output<span class="token operator">:</span> <span class="token punctuation">{</span>
    library<span class="token operator">:</span> <span class="token string">'api'</span><span class="token punctuation">,</span>
    libraryTarget<span class="token operator">:</span> <span class="token string">'umd'</span><span class="token punctuation">,</span>
    umdNamedDefine<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    path<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    filename<span class="token operator">:</span> <span class="token string">'api.js'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  resolve<span class="token operator">:</span> <span class="token punctuation">{</span>
    extensions<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'.ts'</span><span class="token punctuation">,</span> <span class="token string">'.tsx'</span><span class="token punctuation">,</span> <span class="token string">'.js'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    modules<span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token string">'node_modules'</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  target<span class="token operator">:</span> <span class="token string">'node'</span><span class="token punctuation">,</span>
  mode<span class="token operator">:</span> <span class="token string">'production'</span><span class="token punctuation">,</span>
  ignoreWarnings<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token regex">/^(?!CriticalDependenciesWarning$)/</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  module<span class="token operator">:</span> <span class="token punctuation">{</span>
    rules<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
      <span class="token comment">// all files with a `.ts` or `.tsx` extension will be handled by `ts-loader`</span>
      test<span class="token operator">:</span> <span class="token regex">/\.tsx?$/</span><span class="token punctuation">,</span>
      use<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
        loader<span class="token operator">:</span> <span class="token string">'ts-loader'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  optimization<span class="token operator">:</span> <span class="token punctuation">{</span>
    minimize<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    minimizer<span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token keyword">new</span> <span class="token class-name">TerserPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        terserOptions<span class="token operator">:</span> <span class="token punctuation">{</span>
          format<span class="token operator">:</span> <span class="token punctuation">{</span>
            comments<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        extractComments<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div></section>
<section><h2 id="use-terraform-to-deploy-our-changes" style="position:relative;"><a href="#use-terraform-to-deploy-our-changes" aria-label="use terraform to deploy our changes permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Use terraform to deploy our changes</h2><p>Now that we have prepared the release we should be able to apply our changes using <code class="language-text">terraform</code>. Check the plan:</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">terraform plan</code></pre></div><p>You should see the modified hash of the source code:</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token punctuation">..</span>.
 ~ source_code_hash <span class="token operator">=</span> <span class="token string">"PM7qAOa3MhcDW7/4fxKHxkSe5c6c3DyElx5iTGb8bPY="</span> -<span class="token operator">></span> <span class="token string">"APdymEzpkA8Gm1BqKtSRnr/4O5Xl0gZBJHknkbA4LYE="</span>
<span class="token punctuation">..</span>.</code></pre></div><p>Apply the changes:</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">terraform apply</code></pre></div><p>And answer <code class="language-text">yes</code>. Once complete, open your API in a browser: <a href="https://api.example.com/ok">https://api.example.com/ok</a> (replacing <code class="language-text">example</code> with your domain name). You should see:</p><div class="gatsby-highlight" data-language="json"><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span><span class="token property">"ok"</span><span class="token operator">:</span> <span class="token string">"ok"</span><span class="token punctuation">}</span></code></pre></div><p>If you don‚Äôt see ‚Äúok‚Äù you might instead see:</p><div class="gatsby-highlight" data-language="json"><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>'message'<span class="token operator">:</span><span class="token string">"Missing Authentication Token"</span><span class="token punctuation">}</span></code></pre></div><p>There are several reasons you might see this:</p><ul>
<li>You attempted to navigate to the root URL (which isn‚Äôt configured)</li>
<li>Your integration or options integration is configured incorrectly</li>
<li>The Lambda function is failing (and errors are configured incorrectly)</li>
<li>The integration is setup to require authorization and there is no authorized user.</li>
</ul><p>In most cases the problem is required authorization. In fact, if you‚Äôve followed the previous tutorial, you should see this error. Feel free to continue (we‚Äôll setup user authorization in the next post). If you want to remove the user authorization requirement, revisit the <a href="https://jeffrafter.com/terraform-and-aws/#create-an-api-gateway-that-proxies-to-the-function"><code class="language-text">site_api_method</code></a> definition. Change <code class="language-text">AWS_IAM</code> to <code class="language-text">NONE</code> and apply the changes. After a few minutes you should be able to see <code class="language-text">&quot;ok&quot;</code> response.</p></section>
<section><h2 id="invoking-the-function-directly" style="position:relative;"><a href="#invoking-the-function-directly" aria-label="invoking the function directly permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Invoking the function directly</h2><p>We could also invoke our function directly (without opening a browser and sending a request through the API Gateway). We can do this using <code class="language-text">awscli</code>. Run the following (changing the <code class="language-text">profile</code> name <code class="language-text">example</code> to the name of your <code class="language-text">awscli</code> profile)<label for="sd-it-s-easy-to-forget" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sd-it-s-easy-to-forget" class="margin-toggle" /><span class="sidenote">It's easy to forget to add the <code>cli-binary-format</code> parameter. If you leave it off you'll see an error: "An error occurred (InvalidRequestContentException) when calling the Invoke operation: Could not parse request body into json: Unexpected character ('¬≠' (code 173)): expected a valid value (number, String, array, object, 'true', 'false' or 'null')
at [Source: (byte[])"ÔøΩÔøΩ(ÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩ/ÔøΩjÔøΩÔøΩHmÔøΩÔøΩÔøΩD€°‹°yÔøΩ^ÔøΩÔøΩ(ÔøΩ◊ßÔøΩ‹©y ÔøΩiÔøΩ'ÔøΩ*'ÔøΩ;(ÔøΩÔøΩZÔøΩ«≠Q1|"; line: 1, column: 2]". You can make this parameter the default in your <code>~/.aws/config</code>. For more information, see the <a href="https://docs.aws.amazon.com/cli/latest/userguide/cliv2-migration.html#cliv2-migration-binaryparam">AWS documentation</a>.</span>:</p><div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">aws lambda invoke \
  --profile example \
  --cli-binary-format raw-in-base64-out \
  --function-name site_lambda_function \
  --payload &#39;{
    &quot;resource&quot;: &quot;/{proxy+}&quot;,
    &quot;path&quot;: &quot;/ok&quot;,
    &quot;httpMethod&quot;: &quot;GET&quot;,
    &quot;body&quot;: &quot;{\&quot;\&quot;}&quot;,
    &quot;headers&quot;: &quot;{\&quot;content-type\&quot;:\&quot;application/json; charset=UTF-8\&quot;}&quot;
  }&#39; /dev/stdout</code></pre></div><p>You should see:</p><div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">{&quot;statusCode&quot;:200,&quot;body&quot;:&quot;{\&quot;ok\&quot;:\&quot;ok\&quot;}&quot;,&quot;headers&quot;:{&quot;x-powered-by&quot;:&quot;Express&quot;,&quot;access-control-allow-origin&quot;:&quot;*&quot;,&quot;access-control-allow-credentials&quot;:&quot;true&quot;,&quot;content-type&quot;:&quot;application/json; charset=utf-8&quot;,&quot;content-length&quot;:&quot;11&quot;,&quot;etag&quot;:&quot;W/\&quot;b-2F/2BWc0KYbtLqL5U2Kv5B6uQUQ\&quot;&quot;,&quot;date&quot;:&quot;Thu, 08 Oct 2020 03:25:{4 GMT&quot;,&quot;connection&quot;:&quot;close&quot;},&quot;isBase64Encoded&quot;:false}
    &quot;StatusCode&quot;: 200,
    &quot;ExecutedVersion&quot;: &quot;$LATEST&quot;
}</code></pre></div><p>This is really helpful when debugging API Gateway configuration and request payload problems.</p><p>If you want to view the Lambda function on AWS itself, you should be able to log in and go to <a href="https://console.aws.amazon.com/lambda/home?region=us-east-1#/functions/site_lambda_function?tab=configuration">https://console.aws.amazon.com/lambda/home?region=us-east-1#/functions/site_lambda_function?tab=configuration</a>. From here you can quickly get to the CloudWatch logs to see any information you‚Äôve logged.</p><p>Save the change and create a new release:</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">npm</span> run release</code></pre></div><p>Next, we‚Äôll need to deploy the change using Terraform. Let‚Äôs add a <code class="language-text">deploy</code> script to our <code class="language-text">package.json</code>:</p><div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">  &quot;scripts&quot;: {
    &quot;build&quot;: &quot;tsc --noEmit &amp;&amp; webpack&quot;,
    &quot;lint&quot;: &quot;eslint . --ext .ts&quot;,
    &quot;start&quot;: &quot;ts-node-dev --respawn --pretty --transpile-only src/local.ts&quot;,
    &quot;zip&quot;: &quot;cd dist; zip -r ../../terraform/api.zip api.js&quot;,
    &quot;release&quot;: &quot;npm run build &amp;&amp; npm run zip&quot;,
    &quot;deploy&quot;: &quot;cd ../terraform; terraform apply --auto-approve&quot;
  },</code></pre></div><p>Now run:</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">npm</span> run deploy</code></pre></div><p>You should see Terraform run. Go to your <code class="language-text">ok</code> route in a browser again; wait a few seconds and then open the CloudWatch logs by clicking the <code class="language-text">View logs in CloudWatch</code> button (or, if you‚Äôve closely followed my setup: <a href="https://console.aws.amazon.com/cloudwatch/home?region=us-east-1#logsV2:log-groups/log-group/$252Faws$252Flambda$252Fsite_lambda_function">here</a>).</p><p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1280px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/d69bc387a06730821e0b01a2978e0a91/9c507/express-cloudwatch.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 32.1875%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAABYlAAAWJQFJUiTwAAAA/0lEQVQY011R2ZKEIAz0/3/Rcas8FhwREMUD0OpN0JmHfWg6CekmQCFHC6k0pJ6grMNgXGZBOeNNubYWatSEEQOB47dSsNME62bSukc/o7DUPAwDYgxfnCkhpYgUY85D4HrMCJQflM/LAm1s5nVdsfibi3Xb4Clgvq4rixyduh9HFoaYcJ7nF2y+7zuOzz6BtRvVfDakxTm6ljbgab33kLKHEBJd94t+UDDGZFg7ZaPwGP3HRsYFGwgh8HpVGXx9NqrrBlX1g7IsCS80TZMPYWMeYKL3u/mOP8MUCy1c5An10yykRNt1aNsuc03cj7Q3zzAkZLExN/PUrOMP4vf8A+QVyXUiqfptAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="CloudWatch logs showing the API invocation"
        title="CloudWatch logs showing the API invocation"
        src="/static/d69bc387a06730821e0b01a2978e0a91/21b4d/express-cloudwatch.png"
        srcset="/static/d69bc387a06730821e0b01a2978e0a91/72799/express-cloudwatch.png 320w,
/static/d69bc387a06730821e0b01a2978e0a91/6af66/express-cloudwatch.png 640w,
/static/d69bc387a06730821e0b01a2978e0a91/21b4d/express-cloudwatch.png 1280w,
/static/d69bc387a06730821e0b01a2978e0a91/29114/express-cloudwatch.png 1920w,
/static/d69bc387a06730821e0b01a2978e0a91/c2d13/express-cloudwatch.png 2560w,
/static/d69bc387a06730821e0b01a2978e0a91/9c507/express-cloudwatch.png 2768w"
        sizes="(max-width: 1280px) 100vw, 1280px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
      />
  </a>
    </span></p><h1 id="testing" style="position:relative;"><a href="#testing" aria-label="testing permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Testing</h1><p>With all of our setup, deploying is fairly quick and easy. However, we‚Äôll move much faster if we can test all of our code before deploying. We can do this manually using our local development server but it is very good to also have automated tests. Let‚Äôs setup <a href="https://jestjs.io">Jest</a>. As with all of the other choices we‚Äôve had to make, there are lots of choices for our testing framework. I tend to use Jest because I‚Äôve always used it and it is easy for me to understand.</p><p>Let‚Äôs install the <code class="language-text">jest</code> and <code class="language-text">supertest</code> packages:</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> --save-dev jest supertest</code></pre></div><p>We‚Äôll also want to add the TypeScript support:</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> --save-dev ts-jest @types/jest @types/supertest</code></pre></div><p>Now that we have the packages we‚Äôll need to add <code class="language-text">jest</code> to the <code class="language-text">env</code> in <code class="language-text">.eslintrc.json</code>:</p><div class="gatsby-highlight" data-language="json"><pre class="language-json"><code class="language-json">  ...
  <span class="token property">"env"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"node"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token property">"jest"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token property">"es6"</span><span class="token operator">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  ...
<span class="token punctuation">}</span></code></pre></div><p>We‚Äôll also need to add a <code class="language-text">test</code> script in our <code class="language-text">package.json</code>:</p><div class="gatsby-highlight" data-language="json"><pre class="language-json"><code class="language-json">  <span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"build"</span><span class="token operator">:</span> <span class="token string">"tsc --noEmit &amp;&amp; webpack"</span><span class="token punctuation">,</span>
    <span class="token property">"lint"</span><span class="token operator">:</span> <span class="token string">"eslint . --ext .ts"</span><span class="token punctuation">,</span>
    <span class="token property">"start"</span><span class="token operator">:</span> <span class="token string">"ts-node-dev --respawn --pretty --transpile-only src/local.ts"</span><span class="token punctuation">,</span>
    <span class="token property">"zip"</span><span class="token operator">:</span> <span class="token string">"cd dist; zip -r ../../terraform/api.zip api.js"</span><span class="token punctuation">,</span>
    <span class="token property">"release"</span><span class="token operator">:</span> <span class="token string">"npm run build &amp;&amp; npm run zip"</span><span class="token punctuation">,</span>
    <span class="token property">"deploy"</span><span class="token operator">:</span> <span class="token string">"cd ../terraform; terraform apply --auto-approve"</span><span class="token punctuation">,</span>
    <span class="token property">"test"</span><span class="token operator">:</span> <span class="token string">"tsc --noEmit &amp;&amp; jest"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span></code></pre></div><p>The <code class="language-text">test</code> script will compile our TypeScript (which will check the types) and then run <code class="language-text">jest</code> to run all of our tests. For this to work we‚Äôll have to add another configuration file to the root of our project. Create <code class="language-text">jest.config.js</code>:</p><div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  clearMocks<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  moduleFileExtensions<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'js'</span><span class="token punctuation">,</span> <span class="token string">'ts'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  testEnvironment<span class="token operator">:</span> <span class="token string">'node'</span><span class="token punctuation">,</span>
  testMatch<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'**/*.test.ts'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  transform<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string">'^.+\\.ts$'</span><span class="token operator">:</span> <span class="token string">'ts-jest'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  verbose<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span></code></pre></div><p>This configuration is pretty simple and will allow us to find any tests in our project and run them. Let‚Äôs try it:</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">npm</span> <span class="token builtin class-name">test</span></code></pre></div><p>Whoops, we have an error! We haven‚Äôt written any tests:</p><div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">No tests found, exiting with code 1</code></pre></div><p>Let‚Äôs add a test. There are a few ways that you can organize your tests. I prefer to keep my tests alongside the code they are testing. Create a new file called <code class="language-text">src/routes/ok.test.ts</code>:</p><div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">import</span> request <span class="token keyword">from</span> <span class="token string">'supertest'</span>
<span class="token keyword">import</span> app <span class="token keyword">from</span> <span class="token string">'../app'</span>

<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'GET /ok'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'returns ok as json'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">request</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/ok'</span><span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>statusCode<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'content-type'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token string">'application/json; charset=utf-8'</span><span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>body<span class="token punctuation">.</span>ok<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token string">'ok'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div><p>This is a very simple test: it uses <code class="language-text">supertest</code> to generate a request (and uses <code class="language-text">await</code> to wait for the <code class="language-text">async</code> call) and sets expectations on the response. Let‚Äôs run this:</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">npm</span> <span class="token builtin class-name">test</span></code></pre></div><p>You should see:</p><div class="gatsby-highlight" data-language="jest"><pre class="language-jest"><code class="language-jest"> PASS  src/routes/ok.test.ts
  GET /ok
    ‚úì returns ok as json (43 ms)

  console.log
    GET ok

      at src/routes/ok.ts:7:11

  console.log
    Serverless Event: undefined

      at src/routes/ok.ts:10:11

  console.log
    Serverless Context: undefined

      at src/routes/ok.ts:11:11

Test Suites: 1 passed, 1 total
Tests:       1 passed, 1 total
Snapshots:   0 total
Time:        0.862 s, estimated 1 s
Ran all test suites.</code></pre></div><p>The test passed! There are a couple of extraneous logs in the output. Also, there is no <code class="language-text">event</code> or <code class="language-text">context</code> available within our test environment so they are <code class="language-text">undefined</code>. For now, that‚Äôs fine we can mock those later.</p><h1 id="working-with-authenticated-requests" style="position:relative;"><a href="#working-with-authenticated-requests" aria-label="working with authenticated requests permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Working with authenticated requests</h1><p>Looking closely at the logs you might have noticed the <code class="language-text">requestContext</code> node in the <code class="language-text">apiGateway</code> object that was logged:</p><div class="gatsby-highlight" data-language="json"><pre class="language-json"><code class="language-json">        ...
        <span class="token property">"requestContext"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">"resourceId"</span><span class="token operator">:</span> <span class="token string">"9df9s7"</span><span class="token punctuation">,</span>
            <span class="token property">"resourcePath"</span><span class="token operator">:</span> <span class="token string">"/{proxy+}"</span><span class="token punctuation">,</span>
            <span class="token property">"httpMethod"</span><span class="token operator">:</span> <span class="token string">"GET"</span><span class="token punctuation">,</span>
            <span class="token property">"extendedRequestId"</span><span class="token operator">:</span> <span class="token string">"p9d45s2gIAMD9yg="</span><span class="token punctuation">,</span>
            <span class="token property">"requestTime"</span><span class="token operator">:</span> <span class="token string">"11/Oct/2020:11:37:39 +0000"</span><span class="token punctuation">,</span>
            <span class="token property">"path"</span><span class="token operator">:</span> <span class="token string">"/ok"</span><span class="token punctuation">,</span>
            <span class="token property">"accountId"</span><span class="token operator">:</span> <span class="token string">"15635678299"</span><span class="token punctuation">,</span>
            <span class="token property">"protocol"</span><span class="token operator">:</span> <span class="token string">"HTTP/1.1"</span><span class="token punctuation">,</span>
            <span class="token property">"stage"</span><span class="token operator">:</span> <span class="token string">"production"</span><span class="token punctuation">,</span>
            <span class="token property">"domainPrefix"</span><span class="token operator">:</span> <span class="token string">"api"</span><span class="token punctuation">,</span>
            <span class="token property">"requestTimeEpoch"</span><span class="token operator">:</span> <span class="token number">1602416259517</span><span class="token punctuation">,</span>
            <span class="token property">"requestId"</span><span class="token operator">:</span> <span class="token string">"629ceff-03d3-4939-b008-a9920072979e"</span><span class="token punctuation">,</span>
            <span class="token property">"identity"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">"cognitoIdentityPoolId"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
                <span class="token property">"accountId"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
                <span class="token property">"cognitoIdentityId"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
                <span class="token property">"caller"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
                <span class="token property">"sourceIp"</span><span class="token operator">:</span> <span class="token string">"111.222.333.444"</span><span class="token punctuation">,</span>
                <span class="token property">"principalOrgId"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
                <span class="token property">"accessKey"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
                <span class="token property">"cognitoAuthenticationType"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
                <span class="token property">"cognitoAuthenticationProvider"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
                <span class="token property">"userArn"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
                <span class="token property">"userAgent"</span><span class="token operator">:</span> <span class="token string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.121 Safari/537.36"</span><span class="token punctuation">,</span>
                <span class="token property">"user"</span><span class="token operator">:</span> <span class="token null keyword">null</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token property">"domainName"</span><span class="token operator">:</span> <span class="token string">"api.example.com"</span><span class="token punctuation">,</span>
            <span class="token property">"apiId"</span><span class="token operator">:</span> <span class="token string">"9sa8ucem6g"</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        ...</code></pre></div><p>The <code class="language-text">requestContext</code> has a lot of useful information but most importantly it has an <code class="language-text">identity</code> node representing the user‚Äôs AWS Cognito identity. In this case everything is <code class="language-text">null</code>. That‚Äôs because we didn‚Äôt include any information about our identity pool when making the request. We‚Äôll learn more about this when we begin building the front end.</p><h1 id="storing-and-retrieving-items-from-the-database" style="position:relative;"><a href="#storing-and-retrieving-items-from-the-database" aria-label="storing and retrieving items from the database permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Storing and retrieving items from the database</h1><p>As we‚Äôve seen with the other parts of our server there are lots of choices available for storing and retrieving data. When <a href="/terraform-and-aws/#database">setting up our database using Terraform</a> we chose DynamoDB mostly because of cost. Working with DynamoDB is very different from working in a traditional relational database like MySQL or Postgres. We‚Äôve made some strong choices about how the data should be arranged in our DynamoDB instance - these choices will give us decent flexibility while allowing us to keep our costs (read unit capacity) very low. In many cases - if you aren‚Äôt optimizing for cost and scale - there are simpler configurations. For me, I rely on this pattern regardless of scale to keep from having to make new decisions.</p><p>For context, the <a href="http://www.cs.cornell.edu/courses/cs5414/2017fa/papers/dynamo.pdf">Dynamo Paper</a> from 2007 lays out the fundamental aspects of Amazon‚Äôs highly available key-value store. You don‚Äôt need to read the paper to use DynamoDB but if you are looking to better understand its origin and foundation the paper can be a good read. There are also two fantastic resources about the data access patterns I use:</p><ul>
<li><a href="https://www.trek10.com/blog/dynamodb-single-table-relational-modeling/">https://www.trek10.com/blog/dynamodb-single-table-relational-modeling/</a></li>
<li><a href="https://www.youtube.com/watch?v=HaEPXoXVf2k">https://www.youtube.com/watch?v=HaEPXoXVf2k</a></li>
</ul><p>Again, you don‚Äôt need to read these but they offer deeper insight than I cover. For me, these took multiple tries to fully comprehend.</p></section>
<section><h2 id="localstack" style="position:relative;"><a href="#localstack" aria-label="localstack permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Localstack</h2><p>Although it is possible to setup a temporary DynamoDB on AWS for testing purposes, it is very cumbersome. Luckily, it is possible to run a local DynamoDB for development using <a href="https://localstack.cloud/">Localstack</a>. Localstack utilizes Docker to create watered-down versions of many AWS products. For our purposes, the Community Edition (free and Open Source) should work fine.</p><p>To install <code class="language-text">localstack</code> you need use <code class="language-text">pip</code> (the package installer for Python) and run:</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">pip <span class="token function">install</span> localstack</code></pre></div><p>If you get a permission error you can try:</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">pip <span class="token function">install</span> --user localstack</code></pre></div><p>If you don‚Äôt have the <code class="language-text">pip</code> command, try <code class="language-text">pip3</code> (the Python 3 version) instead.</p><p>Normally you would start Localstack using <code class="language-text">localstack start</code> to run the default stack. You can configure which services run and where the data is stored using environment variables. We‚Äôll use the following services:</p><ul>
<li>S3</li>
<li>DynamoDB</li>
<li>SES</li>
<li>Lambda</li>
</ul><p>We‚Äôll want to persist our data in between <code class="language-text">localstack</code> restarts. To do this we actually need to point our data directory to the our computer‚Äôs <code class="language-text">/tmp</code> directory. Why? Localstack relies on docker which mounts a shared folder in the <code class="language-text">/tmp</code> directory by default. We‚Äôll need to store our data within that mounted folder.</p><p>We‚Äôll also need to set directory for Localstack‚Äôs temporary storage. We‚Äôll use a directory called <code class="language-text">.localstack</code> in our project‚Äôs root folder.</p><p>This can be a lot to remember; let‚Äôs add another script to our <code class="language-text">package.json</code>:</p><div class="gatsby-highlight" data-language="json"><pre class="language-json"><code class="language-json">  scripts<span class="token operator">:</span> <span class="token punctuation">{</span>
    ...
    <span class="token property">"localstack"</span><span class="token operator">:</span> <span class="token string">"SERVICES=s3,dynamodb,ses,lambda DEBUG=1 DATA_DIR=/tmp/localstack/data TMPDIR=.localstack localstack start"</span>
    ...
  <span class="token punctuation">}</span></code></pre></div><p>Notice that we also set <code class="language-text">localstack</code> to run in debug mode for better output.</p><p>Before we can run the command we‚Äôll want setup which ports each of the services will use. To do this add the following your <code class="language-text">.env</code> file:</p><div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">LOCALSTACK_HOSTNAME=0.0.0.0
AWS_DYNAMODB_ENDPOINT=http://$LOCALSTACK_HOSTNAME:4566
AWS_ACCESS_KEY_ID=test
AWS_SECRET_ACCESS_KEY=test
AWS_REGION=us-east-1</code></pre></div><p>With this in place you should be able to run:</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">npm</span> run localstack</code></pre></div><h1 id="sending-email" style="position:relative;"><a href="#sending-email" aria-label="sending email permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Sending email</h1><h1 id="working-locally" style="position:relative;"><a href="#working-locally" aria-label="working locally permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Working locally</h1><h1 id="testing-1" style="position:relative;"><a href="#testing-1" aria-label="testing 1 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Testing</h1><h1 id="references" style="position:relative;"><a href="#references" aria-label="references permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>References</h1><p><a href="https://auth0.com/blog/node-js-and-typescript-tutorial-build-a-crud-api/">https://auth0.com/blog/node-js-and-typescript-tutorial-build-a-crud-api/</a></p><div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">api/
  |
  |- .env
  |- .env.sample
  |- .eslintignore
  |- .eslintrc.json
  |- .gitignore
  |- .node-version
  |- .prettierrc
  |- package-lock.json
  |- package.json
  |- tsconfig.json
  |- webpack.config.json
  |- src/
  |  |- data/
  |  |- lib/
  |  |  |- http-exception.ts
  |  |- mailers/
  |  |- middleware/
  |  |  |- error.ts
  |  |  |- not-found.ts
  |  |- routes/
  |  |  |- index.ts
  |  |  |- ok.ts
  |  |- views/
  |  |  |- (empty)</code></pre></div></section></div><hr/><h2>Comments</h2><div class="sc-ifAKCX ddlDEo github"><div><p>Thanks for reading ‚ù§Ô∏è ‚Äì comment by replying to the <a href="https://github.com/jeffrafter/jeffrafter.github.io/issues/14">issue for this post</a>.<!-- --> <!-- -->There‚Äôs no comments yet; you could be the first.<br/></p></div><div class="sc-gzVnrw bOnSNx"><a href="https://github.com/jeffrafter/jeffrafter.github.io/issues/14#new_comment_field" target="_blank" rel="noreferrer noopener" class="button btn">Add a comment ‚Üí</a></div></div><hr/><h2>There‚Äôs more to read</h2><div><p><em>Looking for more long-form posts? Here ya go...</em></p></div><ul class="sc-htoDjs gXLbcD"><li><a rel="prev" href="/terraform-and-aws/">‚Üê <!-- -->Terraform and Amazon Web Services</a></li><li><a rel="next" href="/getting-started-with-unity-and-vr/">Getting Started With Unity and Virtual Reality<!-- --> ‚Üí</a></li></ul></div></article></main><footer class="sc-bwzfXH aCPwf footer">¬© <!-- -->2023<!-- -->,<!-- --> <a href="https://jeffrafter.com">jeffrafter.com</a>. Built with<!-- --> <a href="https://www.gatsbyjs.org">Gatsby</a></footer></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script>
  
  
  if(true) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  }
  if (typeof ga === "function") {
    ga('create', 'UA-61511214-2', 'auto', {});
      
      
      
      
      
      }</script><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/express-and-aws/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-3b271d6a60df7cd92087.js"],"component---src-pages-404-tsx":["/component---src-pages-404-tsx-6846fb06ec67c7df9104.js"],"component---src-pages-about-tsx":["/component---src-pages-about-tsx-06b4f92e6d6da3e7e748.js"],"component---src-pages-index-tsx":["/component---src-pages-index-tsx-62ade78c2e0e44b33fb5.js"],"component---src-pages-tags-tsx":["/component---src-pages-tags-tsx-85ba1002141d5ed31e60.js"],"component---src-templates-post-tsx":["/component---src-templates-post-tsx-30b85df3d8081f386f13.js"],"component---src-templates-tag-tsx":["/component---src-templates-tag-tsx-1289ad2b8e0e8d66d692.js"]};/*]]>*/</script><script src="/component---src-templates-post-tsx-30b85df3d8081f386f13.js" async=""></script><script src="/commons-52923487d36b93dc329d.js" async=""></script><script src="/app-3b271d6a60df7cd92087.js" async=""></script><script src="/styles-fa79fef4936efa84b233.js" async=""></script><script src="/framework-8dcecaaefd71e2213eb2.js" async=""></script><script src="/webpack-runtime-38c8a4ef93b968ef91ae.js" async=""></script></body></html>