<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.237ba1bc08ffadef5a9e.css">html{box-sizing:border-box;margin:0;padding:0}*,:after,:before{box-sizing:inherit}body{margin:0!important;padding:0}a.anchor,a.anchor:hover,a.anchor:link{background:none!important}figure a.gatsby-resp-image-link{background:none}figure span.gatsby-resp-image-wrapper{max-width:100%!important}article .excerpt{display:none}.btn,.button{display:inline-block;background:none!important;border-radius:40px;line-height:40px;min-height:40px;min-width:80px;padding:0 12px;text-align:center;text-decoration:none;border:1px solid #666;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji}@font-face{font-family:et-book;src:url(/et-book/et-book-roman-line-figures/et-book-roman-line-figures.eot);src:url(/et-book/et-book-roman-line-figures/et-book-roman-line-figures.eot?#iefix) format("embedded-opentype"),url(/et-book/et-book-roman-line-figures/et-book-roman-line-figures.woff) format("woff"),url(/et-book/et-book-roman-line-figures/et-book-roman-line-figures.ttf) format("truetype"),url(/et-book/et-book-roman-line-figures/et-book-roman-line-figures.svg#etbookromanosf) format("svg");font-weight:400;font-style:normal}@font-face{font-family:et-book;src:url(/et-book/et-book-display-italic-old-style-figures/et-book-display-italic-old-style-figures.eot);src:url(/et-book/et-book-display-italic-old-style-figures/et-book-display-italic-old-style-figures.eot?#iefix) format("embedded-opentype"),url(/et-book/et-book-display-italic-old-style-figures/et-book-display-italic-old-style-figures.woff) format("woff"),url(/et-book/et-book-display-italic-old-style-figures/et-book-display-italic-old-style-figures.ttf) format("truetype"),url(/et-book/et-book-display-italic-old-style-figures/et-book-display-italic-old-style-figures.svg#etbookromanosf) format("svg");font-weight:400;font-style:italic}@font-face{font-family:et-book;src:url(/et-book/et-book-bold-line-figures/et-book-bold-line-figures.eot);src:url(/et-book/et-book-bold-line-figures/et-book-bold-line-figures.eot?#iefix) format("embedded-opentype"),url(/et-book/et-book-bold-line-figures/et-book-bold-line-figures.woff) format("woff"),url(/et-book/et-book-bold-line-figures/et-book-bold-line-figures.ttf) format("truetype"),url(/et-book/et-book-bold-line-figures/et-book-bold-line-figures.svg#etbookromanosf) format("svg");font-weight:700;font-style:normal}@font-face{font-family:et-book-roman-old-style;src:url(/et-book/et-book-roman-old-style-figures/et-book-roman-old-style-figures.eot);src:url(/et-book/et-book-roman-old-style-figures/et-book-roman-old-style-figures.eot?#iefix) format("embedded-opentype"),url(/et-book/et-book-roman-old-style-figures/et-book-roman-old-style-figures.woff) format("woff"),url(/et-book/et-book-roman-old-style-figures/et-book-roman-old-style-figures.ttf) format("truetype"),url(/et-book/et-book-roman-old-style-figures/et-book-roman-old-style-figures.svg#etbookromanosf) format("svg");font-weight:400;font-style:normal}html{font-size:15px}body{width:87.5%;margin-left:auto;margin-right:auto;padding-left:12.5%;font-family:et-book,Palatino,Palatino Linotype,Palatino LT STD,Book Antiqua,Georgia,serif;background-color:#fffff8;color:#111;max-width:1400px;counter-reset:sidenote-counter}h1{font-weight:400;margin-top:4rem;margin-bottom:1.5rem;font-size:3.2rem;line-height:1}h2{margin-top:2.1rem;font-size:2.2rem}h2,h3{font-style:italic;font-weight:400;margin-bottom:1.4rem;line-height:1}h3{font-size:1.7rem;margin-top:2rem}hr{display:block;height:1px;width:55%;border:0;border-top:1px solid #ccc;margin:1em 0;padding:0}p.subtitle{font-style:italic;margin-top:1rem;margin-bottom:1rem;font-size:1.8rem;display:block;line-height:1}.numeral{font-family:et-book-roman-old-style}.danger{color:red}article{position:relative;padding:1rem 0}section{padding-top:1rem;padding-bottom:1rem}ol,p,ul{font-size:1.4rem;line-height:2rem}p{margin-top:1.4rem;margin-bottom:1.4rem;padding-right:0;vertical-align:baseline}div.epigraph{margin:5em 0}div.epigraph>blockquote{margin-top:3em;margin-bottom:3em}div.epigraph>blockquote,div.epigraph>blockquote>p{font-style:italic}div.epigraph>blockquote>footer{font-style:normal}div.epigraph>blockquote>footer>cite{font-style:italic}blockquote{font-size:1.4rem}blockquote p{width:55%;margin-right:40px;font-style:italic;color:#999}blockquote footer{width:55%;font-size:1.1rem;text-align:right}section>footer,section>p,section>table{width:55%;clear:left}section>ol,section>ul{width:55%;-webkit-padding-start:5%}li:not(:first-child){margin-top:.25rem}figure{padding:0;border:0;font-size:100%;font:inherit;max-width:55%;-webkit-margin-start:0;-webkit-margin-end:0;-webkit-margin-before:0;margin-block-start:0;-webkit-margin-after:0;margin-block-end:0;margin:0 0 3em}figcaption,figure{vertical-align:baseline}figcaption{margin-top:-2em;margin-bottom:0;font-size:1.1rem;font-style:italic;line-height:1.6;position:relative;max-width:40%}figure.fullwidth figcaption{max-width:80%}a:link,a:visited{color:inherit}a:link{text-decoration:none;border-bottom:1px solid #000;padding-bottom:.05em;margin-bottom:.05em;word-break:break-word}a.anchor:link,nav.navigation a{border-bottom:0;padding-bottom:0;margin-bottom:0}@media screen and (-webkit-min-device-pixel-ratio:0){a:link{background-position-y:101%,101%,101%}}img{max-width:100%}.sidenote{margin-bottom:2em!important}.marginnote,.sidenote{float:right;clear:right;width:45%;margin:0 -75% 0 5%;font-size:1.1rem;line-height:1.3;vertical-align:baseline;position:relative}.sidenote-number{counter-increment:sidenote-counter}.sidenote-number:after,.sidenote:before{font-family:et-book-roman-old-style;position:relative;vertical-align:baseline}.sidenote-number:after{content:counter(sidenote-counter);font-size:1rem;top:-.5rem;left:.1rem}.sidenote:before{content:counter(sidenote-counter) " ";font-size:1rem;top:-.5rem}blockquote .marginnote,blockquote .sidenote{margin-right:-82%;min-width:59%;text-align:left}div.fullwidth,table.fullwidth{width:100%}div.table-wrapper{overflow-x:auto}.sans,div.table-wrapper{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji}.sans{letter-spacing:.03em}code{font-family:Consolas,Liberation Mono,Menlo,Courier,monospace;font-size:1rem;line-height:1.42}.sans>code{font-size:1.2rem}h1>code,h2>code,h3>code{font-size:.8em}.marginnote>code,.sidenote>code{font-size:1rem}pre.code{font-size:.9rem;width:52.5%;margin-left:2.5%;overflow-x:auto}pre.code.fullwidth{width:90%}.fullwidth{max-width:100%;clear:both}span.newthought{font-variant:small-caps;font-size:1.2em}input.margin-toggle{display:none}label.sidenote-number{display:inline}label.margin-toggle:not(.sidenote-number){display:none}.iframe-wrapper{position:relative;padding-bottom:56.25%;padding-top:25px;height:0}.iframe-wrapper iframe{position:absolute;top:0;left:0;width:100%;height:100%}@media (max-width:760px){body{padding-left:8%;padding-right:8%}body,hr,section>footer,section>p,section>table{width:100%}pre.code{width:97%}section>ol,section>ul{width:90%}figure{max-width:90%}figcaption,figure.fullwidth figcaption{margin-right:0;max-width:none}blockquote{margin-left:1.5em;margin-right:0}blockquote footer,blockquote p{width:100%}label.margin-toggle:not(.sidenote-number){display:inline}.marginnote,.sidenote{display:none}.margin-toggle:checked+.marginnote,.margin-toggle:checked+.sidenote{display:block;float:left;left:1rem;clear:both;width:95%;margin:1rem 2.5%;vertical-align:baseline;position:relative}label{cursor:pointer}div.table-wrapper,table{width:85%}img{width:100%}}:not(pre)>code[class*=language-]{font-size:.9em!important}.gatsby-highlight:after{content:"";display:block;clear:both}.gatsby-highlight{clear:both}h4{font-size:1.3em}.markdown-body ol,.markdown-body p,.markdown-body ul{font-size:inherit;line-height:inherit}.markdown-body blockquote{font-size:inherit}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto;padding:24px;letter-spacing:normal;border-bottom:1px solid #efefef}@media (max-width:767px){.markdown-body{padding:15px}}code[class*=language-],pre[class*=language-]{color:#000;background:none;text-shadow:0 1px #fff;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-]::selection,code[class*=language-] ::selection,pre[class*=language-]::selection,pre[class*=language-] ::selection{text-shadow:none;background:#b3d4fc}@media print{code[class*=language-],pre[class*=language-]{text-shadow:none}}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#f5f2f0}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#708090}.token.punctuation{color:#999}.token.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#905}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#690}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url{color:#9a6e3a;background:hsla(0,0%,100%,.5)}.token.atrule,.token.attr-value,.token.keyword{color:#07a}.token.class-name,.token.function{color:#dd4a68}.token.important,.token.regex,.token.variable{color:#e90}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.markdown-body .octicon{display:inline-block;fill:currentColor;vertical-align:text-bottom}.markdown-body .anchor{float:left;line-height:1;margin-left:-20px;padding-right:4px}.markdown-body .anchor:focus{outline:none}.markdown-body h1 .octicon-link,.markdown-body h2 .octicon-link,.markdown-body h3 .octicon-link,.markdown-body h4 .octicon-link,.markdown-body h5 .octicon-link,.markdown-body h6 .octicon-link{color:#1b1f23;vertical-align:middle;visibility:hidden}.markdown-body h1:hover .anchor,.markdown-body h2:hover .anchor,.markdown-body h3:hover .anchor,.markdown-body h4:hover .anchor,.markdown-body h5:hover .anchor,.markdown-body h6:hover .anchor{text-decoration:none}.markdown-body h1:hover .anchor .octicon-link,.markdown-body h2:hover .anchor .octicon-link,.markdown-body h3:hover .anchor .octicon-link,.markdown-body h4:hover .anchor .octicon-link,.markdown-body h5:hover .anchor .octicon-link,.markdown-body h6:hover .anchor .octicon-link{visibility:visible}.markdown-body h1:hover .anchor .octicon-link:before,.markdown-body h2:hover .anchor .octicon-link:before,.markdown-body h3:hover .anchor .octicon-link:before,.markdown-body h4:hover .anchor .octicon-link:before,.markdown-body h5:hover .anchor .octicon-link:before,.markdown-body h6:hover .anchor .octicon-link:before{width:16px;height:16px;content:" ";display:inline-block;background-image:url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' version='1.1' width='16' height='16' aria-hidden='true'%3E%3Cpath fill-rule='evenodd' d='M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z'/%3E%3C/svg%3E")}.markdown-body{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;color:#24292e;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji;font-size:16px;line-height:1.5;word-wrap:break-word}.markdown-body details{display:block}.markdown-body summary{display:list-item}.markdown-body a{background-color:initial}.markdown-body a:active,.markdown-body a:hover{outline-width:0}.markdown-body strong{font-weight:inherit;font-weight:bolder}.markdown-body h1{margin:.67em 0}.markdown-body img{border-style:none}.markdown-body code,.markdown-body kbd,.markdown-body pre{font-family:monospace,monospace;font-size:1em}.markdown-body hr{box-sizing:initial;overflow:visible}.markdown-body input{font:inherit;margin:0;overflow:visible}.markdown-body [type=checkbox]{box-sizing:border-box;padding:0}.markdown-body *{box-sizing:border-box}.markdown-body input{font-family:inherit;font-size:inherit;line-height:inherit}.markdown-body a{color:#0366d6;text-decoration:none}.markdown-body a:hover{text-decoration:underline}.markdown-body strong{font-weight:600}.markdown-body hr{height:0;margin:15px 0;overflow:hidden;background:transparent;border-bottom:1px solid #dfe2e5}.markdown-body hr:after,.markdown-body hr:before{display:table;content:""}.markdown-body hr:after{clear:both}.markdown-body table{border-spacing:0;border-collapse:collapse}.markdown-body td,.markdown-body th{padding:0}.markdown-body details summary{cursor:pointer}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:0;margin-bottom:0}.markdown-body h1{font-size:32px}.markdown-body h1,.markdown-body h2{font-weight:600}.markdown-body h2{font-size:24px}.markdown-body h3{font-size:20px}.markdown-body h3,.markdown-body h4{font-weight:600}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:14px}.markdown-body h5,.markdown-body h6{font-weight:600}.markdown-body h6{font-size:12px}.markdown-body p{margin-top:0;margin-bottom:10px}.markdown-body blockquote{margin:0}.markdown-body ol,.markdown-body ul{padding-left:0;margin-top:0;margin-bottom:0}.markdown-body ol ol,.markdown-body ul ol{list-style-type:lower-roman}.markdown-body ol ol ol,.markdown-body ol ul ol,.markdown-body ul ol ol,.markdown-body ul ul ol{list-style-type:lower-alpha}.markdown-body dd{margin-left:0}.markdown-body code,.markdown-body pre{font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px}.markdown-body pre{margin-top:0;margin-bottom:0}.markdown-body input::-webkit-inner-spin-button,.markdown-body input::-webkit-outer-spin-button{margin:0;-webkit-appearance:none;appearance:none}.markdown-body :checked+.radio-label{position:relative;z-index:1;border-color:#0366d6}.markdown-body .border{border:1px solid #e1e4e8!important}.markdown-body .border-0{border:0!important}.markdown-body .border-bottom{border-bottom:1px solid #e1e4e8!important}.markdown-body .rounded-1{border-radius:3px!important}.markdown-body .bg-white{background-color:#fff!important}.markdown-body .bg-gray-light{background-color:#fafbfc!important}.markdown-body .text-gray-light{color:#6a737d!important}.markdown-body .pl-3,.markdown-body .px-3{padding-left:16px!important}.markdown-body .px-3{padding-right:16px!important}.markdown-body .f6{font-size:12px!important}.markdown-body .lh-condensed{line-height:1.25!important}.markdown-body .text-bold{font-weight:600!important}.markdown-body .pl-c{color:#6a737d}.markdown-body .pl-c1,.markdown-body .pl-s .pl-v{color:#005cc5}.markdown-body .pl-e,.markdown-body .pl-en{color:#6f42c1}.markdown-body .pl-s .pl-s1,.markdown-body .pl-smi{color:#24292e}.markdown-body .pl-ent{color:#22863a}.markdown-body .pl-k{color:#d73a49}.markdown-body .pl-pds,.markdown-body .pl-s,.markdown-body .pl-s .pl-pse .pl-s1,.markdown-body .pl-sr,.markdown-body .pl-sr .pl-cce,.markdown-body .pl-sr .pl-sra,.markdown-body .pl-sr .pl-sre{color:#032f62}.markdown-body .pl-smw,.markdown-body .pl-v{color:#e36209}.markdown-body .pl-bu{color:#b31d28}.markdown-body .pl-ii{color:#fafbfc;background-color:#b31d28}.markdown-body .pl-c2{color:#fafbfc;background-color:#d73a49}.markdown-body .pl-c2:before{content:"^M"}.markdown-body .pl-sr .pl-cce{font-weight:700;color:#22863a}.markdown-body .pl-ml{color:#735c0f}.markdown-body .pl-mh,.markdown-body .pl-mh .pl-en,.markdown-body .pl-ms{font-weight:700;color:#005cc5}.markdown-body .pl-mi{font-style:italic;color:#24292e}.markdown-body .pl-mb{font-weight:700;color:#24292e}.markdown-body .pl-md{color:#b31d28;background-color:#ffeef0}.markdown-body .pl-mi1{color:#22863a;background-color:#f0fff4}.markdown-body .pl-mc{color:#e36209;background-color:#ffebda}.markdown-body .pl-mi2{color:#f6f8fa;background-color:#005cc5}.markdown-body .pl-mdr{font-weight:700;color:#6f42c1}.markdown-body .pl-ba{color:#586069}.markdown-body .pl-sg{color:#959da5}.markdown-body .pl-corl{text-decoration:underline;color:#032f62}.markdown-body .mb-0{margin-bottom:0!important}.markdown-body .my-2{margin-bottom:8px!important;margin-top:8px!important}.markdown-body .pl-0{padding-left:0!important}.markdown-body .py-0{padding-top:0!important;padding-bottom:0!important}.markdown-body .pl-1{padding-left:4px!important}.markdown-body .pl-2{padding-left:8px!important}.markdown-body .py-2{padding-top:8px!important;padding-bottom:8px!important}.markdown-body .pl-3{padding-left:16px!important}.markdown-body .pl-4{padding-left:24px!important}.markdown-body .pl-5{padding-left:32px!important}.markdown-body .pl-6{padding-left:40px!important}.markdown-body .pl-7{padding-left:48px!important}.markdown-body .pl-8{padding-left:64px!important}.markdown-body .pl-9{padding-left:80px!important}.markdown-body .pl-10{padding-left:96px!important}.markdown-body .pl-11{padding-left:112px!important}.markdown-body .pl-12{padding-left:128px!important}.markdown-body hr{border-bottom-color:#eee}.markdown-body kbd{display:inline-block;padding:3px 5px;font:11px SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #d1d5da;border-radius:3px;box-shadow:inset 0 -1px 0 #d1d5da}.markdown-body:after,.markdown-body:before{display:table;content:""}.markdown-body:after{clear:both}.markdown-body>:first-child{margin-top:0!important}.markdown-body>:last-child{margin-bottom:0!important}.markdown-body a:not([href]){color:inherit;text-decoration:none}.markdown-body blockquote,.markdown-body details,.markdown-body dl,.markdown-body ol,.markdown-body p,.markdown-body pre,.markdown-body table,.markdown-body ul{margin-top:0;margin-bottom:16px}.markdown-body hr{height:.25em;padding:0;margin:24px 0;background-color:#e1e4e8;border:0}.markdown-body blockquote{padding:0 1em;color:#6a737d;border-left:.25em solid #dfe2e5}.markdown-body blockquote>:first-child{margin-top:0}.markdown-body blockquote>:last-child{margin-bottom:0}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:24px;margin-bottom:16px;font-weight:600;line-height:1.25}.markdown-body h1{font-size:2em}.markdown-body h1,.markdown-body h2{padding-bottom:.3em;border-bottom:1px solid #eaecef}.markdown-body h2{font-size:1.5em}.markdown-body h3{font-size:1.25em}.markdown-body h4{font-size:1em}.markdown-body h5{font-size:.875em}.markdown-body h6{font-size:.85em;color:#6a737d}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:0;margin-bottom:0}.markdown-body li{word-wrap:break-all}.markdown-body li>p{margin-top:16px}.markdown-body li+li{margin-top:.25em}.markdown-body dl{padding:0}.markdown-body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:600}.markdown-body dl dd{padding:0 16px;margin-bottom:16px}.markdown-body table{display:block;width:100%;overflow:auto}.markdown-body table th{font-weight:600}.markdown-body table td,.markdown-body table th{padding:6px 13px;border:1px solid #dfe2e5}.markdown-body table tr{background-color:#fff;border-top:1px solid #c6cbd1}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}.markdown-body img{max-width:100%;box-sizing:initial;background-color:#fff}.markdown-body img[align=right]{padding-left:20px}.markdown-body img[align=left]{padding-right:20px}.markdown-body code{padding:.2em .4em;margin:0;font-size:85%;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body pre{word-wrap:normal}.markdown-body pre>code{padding:0;margin:0;font-size:100%;word-break:normal;white-space:pre;background:transparent;border:0}.markdown-body .highlight{margin-bottom:16px}.markdown-body .highlight pre{margin-bottom:0;word-break:normal}.markdown-body .highlight pre,.markdown-body pre{padding:16px;overflow:auto;font-size:85%;line-height:1.45;background-color:#f6f8fa;border-radius:3px}.markdown-body pre code{display:inline;max-width:auto;padding:0;margin:0;overflow:visible;line-height:inherit;word-wrap:normal;background-color:initial;border:0}.markdown-body .commit-tease-sha{display:inline-block;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:90%;color:#444d56}.markdown-body .full-commit .btn-outline:not(:disabled):hover{color:#005cc5;border-color:#005cc5}.markdown-body .blob-wrapper{overflow-x:auto;overflow-y:hidden}.markdown-body .blob-wrapper-embedded{max-height:240px;overflow-y:auto}.markdown-body .blob-num{width:1%;min-width:50px;padding-right:10px;padding-left:10px;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px;line-height:20px;color:rgba(27,31,35,.3);text-align:right;white-space:nowrap;vertical-align:top;cursor:pointer;-webkit-user-select:none;-ms-user-select:none;user-select:none}.markdown-body .blob-num:hover{color:rgba(27,31,35,.6)}.markdown-body .blob-num:before{content:attr(data-line-number)}.markdown-body .blob-code{position:relative;padding-right:10px;padding-left:10px;line-height:20px;vertical-align:top}.markdown-body .blob-code-inner{overflow:visible;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px;color:#24292e;word-wrap:normal;white-space:pre}.markdown-body .pl-token.active,.markdown-body .pl-token:hover{cursor:pointer;background:#ffea7f}.markdown-body .tab-size[data-tab-size="1"]{-moz-tab-size:1;-o-tab-size:1;tab-size:1}.markdown-body .tab-size[data-tab-size="2"]{-moz-tab-size:2;-o-tab-size:2;tab-size:2}.markdown-body .tab-size[data-tab-size="3"]{-moz-tab-size:3;-o-tab-size:3;tab-size:3}.markdown-body .tab-size[data-tab-size="4"]{-moz-tab-size:4;-o-tab-size:4;tab-size:4}.markdown-body .tab-size[data-tab-size="5"]{-moz-tab-size:5;-o-tab-size:5;tab-size:5}.markdown-body .tab-size[data-tab-size="6"]{-moz-tab-size:6;-o-tab-size:6;tab-size:6}.markdown-body .tab-size[data-tab-size="7"]{-moz-tab-size:7;-o-tab-size:7;tab-size:7}.markdown-body .tab-size[data-tab-size="8"]{-moz-tab-size:8;-o-tab-size:8;tab-size:8}.markdown-body .tab-size[data-tab-size="9"]{-moz-tab-size:9;-o-tab-size:9;tab-size:9}.markdown-body .tab-size[data-tab-size="10"]{-moz-tab-size:10;-o-tab-size:10;tab-size:10}.markdown-body .tab-size[data-tab-size="11"]{-moz-tab-size:11;-o-tab-size:11;tab-size:11}.markdown-body .tab-size[data-tab-size="12"]{-moz-tab-size:12;-o-tab-size:12;tab-size:12}.markdown-body .task-list-item{list-style-type:none}.markdown-body .task-list-item+.task-list-item{margin-top:3px}.markdown-body .task-list-item input{margin:0 .2em .25em -1.6em;vertical-align:middle}</style><meta name="generator" content="Gatsby 2.23.4"/><style type="text/css">
    .anchor.before {
      position: absolute;
      top: 0;
      left: 0;
      transform: translateX(-100%);
      padding-right: 4px;
    }
    .anchor.after {
      display: inline-block;
      padding-left: 4px;
    }
    h1 .anchor svg,
    h2 .anchor svg,
    h3 .anchor svg,
    h4 .anchor svg,
    h5 .anchor svg,
    h6 .anchor svg {
      visibility: hidden;
    }
    h1:hover .anchor svg,
    h2:hover .anchor svg,
    h3:hover .anchor svg,
    h4:hover .anchor svg,
    h5:hover .anchor svg,
    h6:hover .anchor svg,
    h1 .anchor:focus svg,
    h2 .anchor:focus svg,
    h3 .anchor:focus svg,
    h4 .anchor:focus svg,
    h5 .anchor:focus svg,
    h6 .anchor:focus svg {
      visibility: visible;
    }
  </style><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop
          var clientTop = document.documentElement.clientTop || document.body.clientTop || 0
          var offset = element.getBoundingClientRect().top + scrollTop - clientTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 0)
          }), 0)
        }
      }
    })
  </script><link rel="canonical" href="https://jeffrafter.com/terraform-and-aws/" data-baseprotocol="https:" data-basehost="jeffrafter.com"/><link rel="icon" href="/favicon-32x32.png?v=bddcaef8d466d0f77d76d3d885709d8f"/><link rel="manifest" href="/manifest.webmanifest"/><meta name="theme-color" content="#663399"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=bddcaef8d466d0f77d76d3d885709d8f"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=bddcaef8d466d0f77d76d3d885709d8f"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=bddcaef8d466d0f77d76d3d885709d8f"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=bddcaef8d466d0f77d76d3d885709d8f"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=bddcaef8d466d0f77d76d3d885709d8f"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=bddcaef8d466d0f77d76d3d885709d8f"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=bddcaef8d466d0f77d76d3d885709d8f"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=bddcaef8d466d0f77d76d3d885709d8f"/><link rel="preconnect dns-prefetch" href="https://www.google-analytics.com"/><link rel="alternate" type="application/rss+xml" href="/rss.xml"/><title data-react-helmet="true">Terraform and Amazon Web Services | Jeff Rafter</title><meta data-react-helmet="true" name="description" content="There are a lot of options for configuring AWS. Terraform from HashiCorp is a tool for configuring remote infrastructure. You can create Terraform configuration files and treat your infrastructure as code; versioning the changes and storing your settings in your repository."/><meta data-react-helmet="true" property="og:title" content="Terraform and Amazon Web Services"/><meta data-react-helmet="true" property="og:description" content="There are a lot of options for configuring AWS. Terraform from HashiCorp is a tool for configuring remote infrastructure. You can create Terraform configuration files and treat your infrastructure as code; versioning the changes and storing your settings in your repository."/><meta data-react-helmet="true" property="og:type" content="website"/><meta data-react-helmet="true" property="og:image" content="https://jeffrafter.com//static/71c53b27614c0e4f7c6c53c691fbef09/9d169/terraform.jpg"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="twitter:creator" content="Jeff Rafter"/><meta data-react-helmet="true" name="twitter:title" content="Terraform and Amazon Web Services"/><meta data-react-helmet="true" name="twitter:description" content="There are a lot of options for configuring AWS. Terraform from HashiCorp is a tool for configuring remote infrastructure. You can create Terraform configuration files and treat your infrastructure as code; versioning the changes and storing your settings in your repository."/><meta data-react-helmet="true" name="keywords" content="terraform, aws, express, gatsby"/><style data-styled="coseIW ddlDEo bOnSNx gXLbcD aCPwf" data-styled-version="4.4.1">
/* sc-component-id: sc-global-3268680936 */
::selection{background-color:#dad9d9;color:rgba(0,0,0,0.70);}
/* sc-component-id: sc-bdVaJa */
.coseIW ul{list-style-type:none;margin:1rem 0;padding:0;margin-left:-16px;} .coseIW li{display:inline-block;margin:16px;} .coseIW li a{background:none;}
/* sc-component-id: sc-bwzfXH */
.aCPwf{padding-bottom:36px;}
/* sc-component-id: sc-ifAKCX */
.ddlDEo{width:55%;}
/* sc-component-id: sc-gzVnrw */
.bOnSNx{margin-top:40px;margin-bottom:40px;float:right;}
/* sc-component-id: sc-htoDjs */
.gXLbcD{list-style-type:none;} .gXLbcD li::before{content:'' !important;padding-right:0 !important;}</style><link as="script" rel="preload" href="/webpack-runtime-e2dd2bd4ceef3b18c316.js"/><link as="script" rel="preload" href="/framework-95b680cb3190aa9bfe59.js"/><link as="script" rel="preload" href="/styles-24c541b6ac347bae38f1.js"/><link as="script" rel="preload" href="/app-51d0929071629bddce45.js"/><link as="script" rel="preload" href="/commons-6458b952aa116f5f11f8.js"/><link as="script" rel="preload" href="/109cf451cc5d7f6d2abc8e688d09142e78350594-53a6b222a8910dfb5d1b.js"/><link as="script" rel="preload" href="/component---src-templates-post-tsx-7133ab7322325c379163.js"/><link as="fetch" rel="preload" href="/page-data/terraform-and-aws/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><nav class="sc-bdVaJa coseIW navigation"><ul><li><a href="/">&amp;</a></li><li><a href="/tags">Tags</a></li><li><a href="/about">About</a></li></ul></nav><main class="content" role="main"><article><header><h1>Terraform and Amazon Web Services</h1><p>October 09, 2020</p></header><div class="page-content"><div><section><figure class="fullwidth"><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1280px; "
    >
      <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 56.25%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAEDAv/EABcBAAMBAAAAAAAAAAAAAAAAAAABAgX/2gAMAwEAAhADEAAAAYvD0FMCD//EABoQAAICAwAAAAAAAAAAAAAAAAABAhARITH/2gAIAQEAAQUCS1gl2pH/xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAVEQEBAAAAAAAAAAAAAAAAAAAAAf/aAAgBAgEBPwFX/8QAFhABAQEAAAAAAAAAAAAAAAAAMQAg/9oACAEBAAY/Amc//8QAGRAAAgMBAAAAAAAAAAAAAAAAAREAEDEh/9oACAEBAAE/IQJxkANJQMFan//aAAwDAQACAAMAAAAQCC//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/ED//xAAWEQEBAQAAAAAAAAAAAAAAAAABADH/2gAIAQIBAT8QBtX/xAAdEAACAgEFAAAAAAAAAAAAAAABEQAhMRBBcaHB/9oACAEBAAE/ECDrJwLqFOGE2LEqG9ezrDTDxP/Z'); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="Terraform + AWS"
        title="Terraform + AWS"
        src="/static/71c53b27614c0e4f7c6c53c691fbef09/eea4a/terraform.jpg"
        srcset="/static/71c53b27614c0e4f7c6c53c691fbef09/cb69c/terraform.jpg 320w,
/static/71c53b27614c0e4f7c6c53c691fbef09/c08c5/terraform.jpg 640w,
/static/71c53b27614c0e4f7c6c53c691fbef09/eea4a/terraform.jpg 1280w"
        sizes="(max-width: 1280px) 100vw, 1280px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
      />
    </span></figure><figcaption class="fullwidth">
Image credit: <a href="https://terraform.io" rel="noopener noreferrer">HashiCorp's Terraform</a>
</figcaption><p>I’ve previously written about <a href="./gatsby-with-typescript">building a static website with Gatsby and TypeScript</a>. If you’re building a static website like a blog then deploying to GitHub Pages is more than enough. But what if the website you are building needs user authentication and authorization? What if you need to store and retrieve items from a database? What if you need server side processing. What if you want to integrate payment processing? There are a lot of options and managing it all quickly becomes difficult.</p><h1 id="who-is-this-for" style="position:relative;"><a href="#who-is-this-for" aria-label="who is this for permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Who is this for?</h1><p>This is a long post. Even by my standards. Also, this isn’t exactly introductory or beginner friendly (though I do try to explain how things are setup and how to make decisions). This post is more of a long-winded reference. I’ve written it because I needed opinionated documentation with all of my choices in one place. Your choices will probably be different because there are lots of trade-offs. Because this is opinionated it is also limited. There are many deeper technical topics I omit because I don’t use them. Nevertheless, hopefully this is useful for you.</p><h1 id="some-history" style="position:relative;"><a href="#some-history" aria-label="some history permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Some history</h1><p>Years ago, I was helping to build an E-Commerce startup. It was one of those experiences where you’re surrounded by brilliant and creative people that can make anything. Our platform was built using Ruby on Rails 1.2, relied on an early beta of Stripe for payment processing, and we used the beta of Slack to communicate.</p><p>We deployed everything to Amazon Web Services because we knew it could scale. At the time the tooling was limited. So we hired a consultant named Mitchell Hashimoto to help us. Mitchell and I would work late setting up the infrastructure using a series of YAML files and a AWS API tool called fog. It was rudimentary but it worked amazingly well.</p><p>From experience I can tell you that Mitchell is one of the fastest, most brilliant people I have ever seen. He built everything we needed flawlessly. One night, he started telling me about what he envisioned as a much better configuration language and platform. Looking back, I realize now he was envisioning Terraform.</p><h1 id="setup" style="position:relative;"><a href="#setup" aria-label="setup permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Setup</h1><p>Before you begin building anything it is useful to understand the trade-offs associated with different platforms, frameworks, and languages. When I’m building something new I tend to optimize for the following:</p><ol>
<li>Price</li>
<li>Scalability</li>
<li>Performance</li>
<li>Maintainability</li>
</ol><p>It is very likely your priorities are different. I put price first because I don’t want to be restricted from making a lot of websites. Using <a href="https://now.sh">Now</a> or <a href="https://netflify.com">Netlify</a> or <a href="https://heroku.com">Heroku</a> will get you up and running very quickly. In many cases you can get your website running for free and it will be free forever. As you scale your service though - adding authentication, storage, background jobs and more the price quickly goes up - even if you don’t have a large number of users.</p><p>If you anticipate a small consistent scale you could spin up a VPS (virtual private server) on <a href="https://digitalocean.com">Digital Ocean</a> and the price will stay constant, but you’ll have a lot more to manage including security updates.</p><p>Building on a cloud platform like AWS, Azure or Google Cloud allows you to keep a low price while providing massive scalability. These platforms have a free-tier that allows you to build your website at virtually no-cost. For the kinds of websites I build Amazon Web Services has the best pricing, but is arguably the most difficult to work with. That’s the trade-off: you get more options, scalability and lower-price but it comes with higher complexity.</p><p>In this post, I’ll detail my setup. It should allow you to build a dynamic website at essentially no cost until it scales beyond 50,000 users per month.</p><p>Our website can be divided into three main projects:</p><ul>
<li>Our infrastructure - built using Terraform</li>
<li>Our server-side API - built using Express</li>
<li>Our front-end website - built using Gatsby</li>
</ul><p>We’ll keep these in separate folders (and each will have a separate repository):</p><div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">example/
  |
  |- terraform/
  |   |- .git
  |   |- ... Terraform project files
  |- api/
  |   |- .git
  |   |- ... Express project files
  |- site/
  |   |- .git
  |   |- ... Gatsby project files</code></pre></div><h1 id="terraform" style="position:relative;"><a href="#terraform" aria-label="terraform permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Terraform</h1><p><a href="https://terraform.io">Terraform</a> is a tool for configuring remote infrastructure. There are a lot of other options for configuring AWS.<label for="sd-one-of-the-best" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sd-one-of-the-best" class="margin-toggle" /><span class="sidenote">One of the best tools is <a href="https://serverless-stack.com">serverless</a> which is generally much simpler than Terraform to use. You can also check out <a href="https://apex.run">apex</a> but it is no longer maintained. Additionally, you could use AWS CloudFormation directly but Terraform is slightly easier to manage when working with larger organizations.</span> but Terraform provides much more flexibility (even allowing you to deploy to multiple cloud providers). You can create Terraform configuration files (<code class="language-text">*.tf</code>) and treat your infrastructure as code; versioning the changes and storing your settings in your repository.</p><p>You’ll need to <a href="https://www.terraform.io/downloads.html">download and install</a> Terraform. You can also use Homebrew (if you are on a Mac):</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">brew <span class="token function">install</span> terraform</code></pre></div></section>
<section><h2 id="getting-started" style="position:relative;"><a href="#getting-started" aria-label="getting started permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Getting started</h2><p>To get started I’ll assume you’ve purchased a domain, but for the purposes of this post, we’ll pretend our domain is <code class="language-text">example.com</code> (you’ll need to replace <code class="language-text">example.com</code> with your domain throughout). You can buy a domain pretty much anywhere for $0.99 to $12.00 for the first year. I use <a href="https://domains.google">Google Domains</a> because I use Gmail so it’s easier to keep track of. By default you get an email address you can use to start setting up services.</p><p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1280px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/55cadaa7e93bfccbc5967d7f7f38f7f5/be460/google-domains-email-alias.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 31.25%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsSAAALEgHS3X78AAAA2ElEQVQY052Q227EIAxE+f9frBIgK0VJq1a74c4Cs7a7t9cW6WjwgLAZlXOB8x7eBzjnMcbAAEh/eaynhzdvvOi949oaVAgR+75jY7YNIQSklBBjFDw3I499rsN9zwNITfB9bsXDqMvh8DFpTHohNdDGYppnGFJrFxhrMc9avGU5iae1EY9VG9rbFevnGfVKE7pYsH4d2L4dTvsFZxdRckYpRai1IpPme/2Ao8p0j0mlIeSG1jpUo78faeDHd8T6ntBfliQsOapGQcbS4alDrp1y6HLwH/itG8zj0XiIh5MnAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="Setting up an email alias in Google Domains"
        title="Setting up an email alias in Google Domains"
        src="/static/55cadaa7e93bfccbc5967d7f7f38f7f5/21b4d/google-domains-email-alias.png"
        srcset="/static/55cadaa7e93bfccbc5967d7f7f38f7f5/72799/google-domains-email-alias.png 320w,
/static/55cadaa7e93bfccbc5967d7f7f38f7f5/6af66/google-domains-email-alias.png 640w,
/static/55cadaa7e93bfccbc5967d7f7f38f7f5/21b4d/google-domains-email-alias.png 1280w,
/static/55cadaa7e93bfccbc5967d7f7f38f7f5/be460/google-domains-email-alias.png 1645w"
        sizes="(max-width: 1280px) 100vw, 1280px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
      />
  </a>
    </span></p><p>Within your domain provider, setup an alias for <code class="language-text">*@example.com</code> to point to your personal email address. This way any email sent to <code class="language-text">example.com</code> will still get through.</p><p>Next, <a href="https://aws.amazon.com/">sign up for AWS</a> using the new email address. When signing up, I tend to use a single-use email like <code class="language-text">aws@example.com</code> and I generally use the domain name as the AWS Account Name (for example: if my domain is example.com my I would choose <code class="language-text">example</code> as my account name). To complete your account creation you’ll need to enter a credit card for billing<label for="sd-though-we-ll-attempt" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sd-though-we-ll-attempt" class="margin-toggle" /><span class="sidenote">Though we'll attempt to keep the costs down, we'll be utilizing Route53 for DNS. Because of this the bill will be at least $0.50 per month (the cost of the primary DNS zone). There are alternatives for setting up your DNS, but keeping everything together makes things simpler.</span> and you’ll need to select a support plan (I generally choose the free support plan). You’ll also need a phone number for verification.</p></section>
<section><h2 id="setting-up-an-iam-user" style="position:relative;"><a href="#setting-up-an-iam-user" aria-label="setting up an iam user permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Setting up an IAM user</h2><p>In general, it is not a good practice to use root user accounts to log into the console and manage your configuration. Creating IAM users for each person in your organization allows you to control access at an individual level. Additionally, if credentials are compromised for a given user those credentials can be revoked centrally.</p><p>Let’s create a user in the <a href="https://console.aws.amazon.com/iam/home?#/home">Identity and Access Management service</a>. Choose your own (personal) user name and choose <strong>AWS Management Console Access</strong>:</p><p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1280px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/70167a48ffc7b15abe6b513c9265959f/720e3/iam-add-user.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 83.4375%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAAAsSAAALEgHS3X78AAABfUlEQVQ4y6VUy27DIBDk/7+pp6pSP6CHVlVeh8iS3wEb22DIlMXBQW7SxOpKaxCws7PLYCalhBACwzCA7Hw+P3SypB7w8pG7mYUeR4zOtdZgBEjeNI1ffGQBUCrjQHtagbV2dpZlGY7HIw6HA4qiQN/3nrEQ/DIK8NMJopXgUjs2xgcSEJldsGf0oQM0UnBZlhiUglLalzA7leTAjD9r55ilsWU5owuqW42UDygahdFMbK4srmBxT2fAcCnUQ5rfyvpHRxfJXMlUYp7noF4mSYI0TSE4R11VqOsalRs5n/rZtq1PTKMQDUQ/onOXM7XtAhjfEAUSAElov99jt9thu9164JO7GEpO85CAO1DZdfd7GMwYg81m451AiXlQACWLXbsLjPXLbgmX2BKjwCwwijUbWtBdGM6A94S7xuIYFi+GjWee31I2dxn+19haNo+c3VL7mt79einLzbW98z8IOwnbhpdCYp427FNA4W9TtQq5e/NvXyVeP0u8f1f4ASxkN2g7uE4aAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="Add user"
        title="Add user"
        src="/static/70167a48ffc7b15abe6b513c9265959f/21b4d/iam-add-user.png"
        srcset="/static/70167a48ffc7b15abe6b513c9265959f/72799/iam-add-user.png 320w,
/static/70167a48ffc7b15abe6b513c9265959f/6af66/iam-add-user.png 640w,
/static/70167a48ffc7b15abe6b513c9265959f/21b4d/iam-add-user.png 1280w,
/static/70167a48ffc7b15abe6b513c9265959f/29114/iam-add-user.png 1920w,
/static/70167a48ffc7b15abe6b513c9265959f/720e3/iam-add-user.png 1962w"
        sizes="(max-width: 1280px) 100vw, 1280px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
      />
  </a>
    </span></p><p>Setup your password and configure your policies:</p><p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1280px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/a54310359d5d37403a3fbeba743a1834/41b28/iam-add-user-administrator-access.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 82.8125%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAAAsSAAALEgHS3X78AAACLElEQVQ4y5VU246bMBDl/x/6Df2HqlIf+tjnrlS12d3cRGIMgXCH2AYDpzNOk6VNKm0sHY3ljE/OnPHg1XUNYwx4TdN0A/yJ4/wME5Tp8el7DNP1GIcBfU9xHOE1TYOqqq6k710DXY4Kg2EYMdGeyfjPvCiKkKYpiqKgHwdoraGUOkeC7Tv4R41NoohAIcwVZK7R2fFuVV4QSHRdh7Zt3UGWZRBC4HA4IMtzTLbD10WBz08RFrsjnmWNhWyh++mGkJcnA+HUuTJIIYPlXyKjtwMMKdL9SHFyGMc3El6n08nB+7HcQ4QJKTuXbahMLvcaydu2qZGlR+SkniPnciUM3/exXq8JK3CDva0v8GvxjPVmg4jKjOOYYowwOjjwXoYRBFmzXK0hZIiA8PK6pDtb7EWA3V44cHO9KEmx9bd42jX4KSps4pMzPa4MDuUZvE/qHisR49WP6ExDJJVrEp8ndefQmgHeaGrUmYQsLSVoR6C74a7hZVm6Cjp6e9xI92T+7fKgSxTJDn5qsD+2hBMSUqCMvTbl8sbYsyAInLcMa29ziLBCmUoEeYcwOyHIFESqkNas1FLSWzI3jZ8TN4pxl9CqAmXik8LuqjAkD+eJc4VSSkf2X4VTr6CajEy1OJL5KZkbc8kzdZdkHlOeKvbv7OFwS6hn780Y7Yach//eh+I98NiXnEaMO8iRVTxK8pfCe1+SRwnn97zHL5OX2jqkbgwzfPwW48OXAC9hi9+d1SRQoq8IkwAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="Configure AdministratorAccess"
        title="Configure AdministratorAccess"
        src="/static/a54310359d5d37403a3fbeba743a1834/21b4d/iam-add-user-administrator-access.png"
        srcset="/static/a54310359d5d37403a3fbeba743a1834/72799/iam-add-user-administrator-access.png 320w,
/static/a54310359d5d37403a3fbeba743a1834/6af66/iam-add-user-administrator-access.png 640w,
/static/a54310359d5d37403a3fbeba743a1834/21b4d/iam-add-user-administrator-access.png 1280w,
/static/a54310359d5d37403a3fbeba743a1834/29114/iam-add-user-administrator-access.png 1920w,
/static/a54310359d5d37403a3fbeba743a1834/41b28/iam-add-user-administrator-access.png 1967w"
        sizes="(max-width: 1280px) 100vw, 1280px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
      />
  </a>
    </span></p><p>You might want more granular access controls, but when getting started <code class="language-text">AdministratorAccess</code> policy keeps things simple.</p><p>Create a user for programmatic access; I’ve called my user <code class="language-text">terraform</code>:</p><p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1280px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/595723ed371d53b232d0bb6b858ea285/cd13d/iam-access-type.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 83.4375%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAAAsSAAALEgHS3X78AAABhElEQVQ4y61UyU7DMBD1x3PjxI8gceDAD3DgE1BFG9qK7PvixMtjxiVVSEMLqCM9xePY4zdvxhZlWUJKCTZr7UWwZfWA+5cPWKOhlHIYhgHGGIiiKJBl2THoebMO2lgU7UABjQsygg8UQRBgv98jTVO0bYuqqtDUNX1LMHs+sKwa5M2AXulvTJcyEFprF503J0mCNC8QRCnqVhLrHn1PoHT6gdL7WjuyWTIxdXghM/GzDgnppA3+bCKOY8eMcdDRHvXiAziDRZiDlicpj8HCMHSIkhwx+Vwons/z3OnI2rIs/GW/qCXqTp0GHKk2TeM2N1Jhvd5gtVo5uDn654pDAXnMqKlwHRVxrqWYVu2go8Zut4Pnedhut/B9H1EUoes6VyCWhcFj7r15xcWcMuvG6Y7a8phZMqOR2SgB+9OAJ1X+qRUutvtkn5jS/e31W7qOiwyvYeI/jM7hSgzt9RhKZUH97aA0MeS2MLNn6By0exgMKnq+wkLi7ukdNw9vuH3c4Pk1wyd2sjYeQpuHwQAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="Access Type"
        title="Access Type"
        src="/static/595723ed371d53b232d0bb6b858ea285/21b4d/iam-access-type.png"
        srcset="/static/595723ed371d53b232d0bb6b858ea285/72799/iam-access-type.png 320w,
/static/595723ed371d53b232d0bb6b858ea285/6af66/iam-access-type.png 640w,
/static/595723ed371d53b232d0bb6b858ea285/21b4d/iam-access-type.png 1280w,
/static/595723ed371d53b232d0bb6b858ea285/29114/iam-access-type.png 1920w,
/static/595723ed371d53b232d0bb6b858ea285/cd13d/iam-access-type.png 1958w"
        sizes="(max-width: 1280px) 100vw, 1280px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
      />
  </a>
    </span></p><p>Once you create the user you’ll need to keep a copy of the <code class="language-text">AWS Access Key ID</code> and the <code class="language-text">AWS Secret Access Key</code>. We’ll configure the AWS Command Line Interface (CLI) on our machine use these. <a href="https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-install.html">Download and install</a> <code class="language-text">awscli</code>. On a mac you can use Homebrew:</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">brew <span class="token function">install</span> awscli</code></pre></div><p>Once installed, <code class="language-text">awscli</code> will need to know about your credentials. There are a few ways to do this:</p><ul>
<li>Saving your credentials in Terraform</li>
<li>Configuring the default credentials</li>
<li>Configuring a profile</li>
<li>Using environment variables</li>
</ul><h3 id="saving-your-credentials-in-terraform-wrong" style="position:relative;"><a href="#saving-your-credentials-in-terraform-wrong" aria-label="saving your credentials in terraform wrong permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Saving your credentials in Terraform (wrong)</h3><p>It is possible to put your credentials directly inside of Terraform (<strong>don’t do this</strong>):</p><div class="gatsby-highlight" data-language="ruby"><pre class="language-ruby"><code class="language-ruby"><span class="token comment"># DON'T DO THIS</span>
provider <span class="token string">"aws"</span> <span class="token punctuation">{</span>
  aws_access_key_id <span class="token operator">=</span> <span class="token string">"YOUR_AWS_ACCESS_KEY_ID"</span>
  aws_secret_access_key <span class="token operator">=</span> <span class="token string">"YOUR_AWS_SECRET_ACCESS_KEY"</span>
<span class="token punctuation">}</span></code></pre></div><p>Not only is this unsafe (we’ll be using version control for our configuration files and you should never store credentials in your repository), it cannot be easily overridden by other developers; meaning everyone will share credentials.</p><h3 id="configuring-the-default-credentials" style="position:relative;"><a href="#configuring-the-default-credentials" aria-label="configuring the default credentials permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Configuring the default credentials</h3><p>Instead, it is much better to let the <code class="language-text">awscli</code> tool store the credentials locally. To do this run:</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">aws configure</code></pre></div><p>You’ll be prompted to enter your credentials and region:</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">AWS Access Key ID <span class="token punctuation">[</span>None<span class="token punctuation">]</span>: YOUR_ACCESS_KEY_ID
AWS Secret Access Key <span class="token punctuation">[</span>None<span class="token punctuation">]</span>: YOUR_SECRET_ACCESS_KEY
Default region name <span class="token punctuation">[</span>None<span class="token punctuation">]</span>: us-east-1
Default output <span class="token function">format</span> <span class="token punctuation">[</span>None<span class="token punctuation">]</span>: json</code></pre></div><p>By default, I’ve chosen to use <code class="language-text">us-east-1</code> (also known as <code class="language-text">N. Virginia</code>). You might prefer another region but unless you have a specific reason not to, you should choose <code class="language-text">us-east-1</code> as it will make later configuration a little easier. Setting the default credentials with <code class="language-text">aws configure</code> allows all of the developers to use individual credentials without needing to change anything within the Terraform configuration.</p><h3 id="configuring-a-profile" style="position:relative;"><a href="#configuring-a-profile" aria-label="configuring a profile permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Configuring a profile</h3><p>Storing default credentials works great, but what if you have multiple projects on your machine - each with different credentials? Luckily, <code class="language-text">awscli</code> can work with multiple profiles. Profile names may include your project name, domain name, an environment (like staging or production). There is <a href="https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-configure.html">good documentation</a> on different configurations for the <code class="language-text">awscli</code> tool.</p><p>You can name a profile anything you like. For now, just use your domain name without the <code class="language-text">.com</code> (in our case, <code class="language-text">example</code>). Run:</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">aws configure --profile example</code></pre></div><p>Fill in the prompts as you did before.</p><p>In order to use a profile you’ll need to export an environment variable (replacing <code class="language-text">example</code> with the profile name you configured). On Mac/Linux you can do this with the <code class="language-text">export</code> command:</p><div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">export AWS_PROFILE=example</code></pre></div><p>Or if you are using an alternative shell like the <code class="language-text">fish</code> shell:</p><div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">set -x AWS_PROFILE example</code></pre></div><p>On Windows:</p><div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">C:\&gt; setx AWS_PROFILE example</code></pre></div><h3 id="using-environment-variables" style="position:relative;"><a href="#using-environment-variables" aria-label="using environment variables permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Using environment variables</h3><p>It is also possible to skip the <code class="language-text">awscli</code> configuration altogether. To do this you’ll need to set environment variables for your credentials. For example, on Mac/Linux:</p><div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">export AWS_ACCESS_KEY_ID=YOUR_ACCESS_KEY_ID
export AWS_SECRET_ACCESS_KEY=YOUR_SECRET_ACCESS_KEY</code></pre></div><p>On Windows:</p><div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">C:\&gt; setx AWS_ACCESS_KEY_ID YOUR_ACCESS_KEY_ID
C:\&gt; setx AWS_SECRET_ACCESS_KEY YOUR_SECRET_ACCESS_KEY</code></pre></div><p>This pattern is particularly useful when running terraform in a continuous integration platform (such as GitHub Actions).<label for="sd-managing-multiple" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sd-managing-multiple" class="margin-toggle" /><span class="sidenote">Managing multiple environments locally can be cumbersome. A helpful tool for this is <a href="https://direnv.net/"><code>direnv</code></a>: it allows you to control the environment on a per-folder basis. We won't use that here, though.</span></p></section>
<section><h2 id="project-organization-choices" style="position:relative;"><a href="#project-organization-choices" aria-label="project organization choices permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Project organization choices</h2><p>Terraform uses its own configuration language and uses the file extension <code class="language-text">*.tf</code>. Our project will have <em>a lot</em> of Terraform configuration. There are several different approaches we could use to organize our Terraform project. These fit into three categories:</p><ul>
<li>Keep all of the configuration in one folder or one file</li>
<li>Separate the configuration of resources into separate modules</li>
<li>Control access and permissions to each resource configuration and state individually</li>
</ul><p>Each of these patterns offer advantages and disadvantages.</p><h3 id="keep-all-of-the-configuration-in-one-folder-or-one-file" style="position:relative;"><a href="#keep-all-of-the-configuration-in-one-folder-or-one-file" aria-label="keep all of the configuration in one folder or one file permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Keep all of the configuration in one folder or one file</h3><p>Terraform is made up of a series of configuration files, variables, outputs and states. When starting a project, all of this can be kept in a single <code class="language-text">terraform.tf</code> file:</p><div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">terraform/
  |
  |- terraform.tf</code></pre></div><p>After you <code class="language-text">apply</code> your Terraform configuration, a local copy of your state will be created:</p><div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">terraform/
  |
  |- terraform.tf
  |- terraform.tfstate
  |- terraform.tfstate.backup</code></pre></div><p>As your infrastructure grows, however, the number of services and resources you rely on will quickly grow and a single file will become unwieldy. It is possible to separate out each service to a separate file as well as separating out the variables and outputs to separate files. When running, Terraform loads all of the files and treats them as a single configuration and figures out the interdependencies. For example:</p><div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">terraform/
  |
  |- dns.tf
  |- certs.tf
  |- email.tf
  |- storage.tf
  |- site.tf
  |- database.tf
  |- users.tf
  |- identities.tf
  |- api.tf
  |- logging.tf
  |- variables.tf
  |- outputs.tf
  |- terraform.tfstate
  |- terraform.tfstate.backup</code></pre></div><p>In this case, it is clear where changes need to be made for specific resources. This makes it easier for developers. Unfortunately is still relies on a single state file even though we’re using separate files. Because of this, when applying the configuration using <code class="language-text">terraform apply</code>, it will need to check and compare the state of every service. If you have a lot of services this can be slow. If you’re making lots of changes that makes sense. But when making a small change (such as just changing the version of a lambda function) this might not be a good choice.</p><h3 id="separate-the-configuration-of-resources-into-separate-modules" style="position:relative;"><a href="#separate-the-configuration-of-resources-into-separate-modules" aria-label="separate the configuration of resources into separate modules permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Separate the configuration of resources into separate modules</h3><p>Terraform has a built in module system that works well to separate out your resources. To do this you would create subfolders for each resource. A default <code class="language-text">terraform.tf</code> file imports the modules and runs them:</p><div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">terraform/
  |
  |- .gitignore
  |- README.md
  |- terraform.tf
  |- terraform.tfstate
  |- terraform.tfstate.backup
  |- dns/
  |   |- main.tf
  |   |- variables.tf
  |   |- outputs.tf
  |- certs/
  |   |- main.tf
  |   |- variables.tf
  |   |- outputs.tf
  |- email/
  |   |- main.tf
  |   |- variables.tf
  |   |- outputs.tf
  |- storage/
  |   |- main.tf
  |   |- variables.tf
  |   |- outputs.tf
  |- site/
  |   |- main.tf
  |   |- variables.tf
  |   |- outputs.tf
  |- database/
  |   |- main.tf
  |   |- variables.tf
  |   |- outputs.tf
  |- users/
  |   |- main.tf
  |   |- variables.tf
  |   |- outputs.tf
  |- identities/
  |   |- main.tf
  |   |- variables.tf
  |   |- outputs.tf
  |- api/
  |   |- main.tf
  |   |- variables.tf
  |   |- outputs.tf
  |- logging/
  |   |- main.tf
  |   |- variables.tf
  |   |- outputs.tf</code></pre></div><p>This is a lot of repeated files and filenames and it is easy to get confused when making changes in an editor (“which <code class="language-text">main.tf</code> am I editing?”). At the same time, this separation of concerns is very powerful. Normally the modules (subfolders) would not contain configuration specific to your website. Instead the specific names and values would be passed into the modules via variables. Because of this, modules can actually be open source and shared between projects.<label for="sd-less-than-a-href" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sd-less-than-a-href" class="margin-toggle" /><span class="sidenote"><a href="https://cloudposse.com/">Cloud Posse</a> maintains a huge set of <a href="https://github.com/cloudposse">open source modules</a> that can be used in your project. In many cases using these modules is the right choice if you are looking to follow best practices around specific resources.</span></p><p>Just as we saw in the previous setup, when running <code class="language-text">terraform apply</code>, Terraform sees all of the modules as a single configuration. Knowing where to make a change is still relatively easy, but each change requires re-applying the entire state for every resource.</p><h3 id="control-access-and-permissions-to-each-resource-configuration-and-state-individually" style="position:relative;"><a href="#control-access-and-permissions-to-each-resource-configuration-and-state-individually" aria-label="control access and permissions to each resource configuration and state individually permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Control access and permissions to each resource configuration and state individually</h3><p>As your website grows and more developers are working on it, it will not make sense to keep everything in a single file. Likewise, maintaining all of your infrastructure in a single state file can become problematic. As your team grows you’ll have developers that understand networking, others that understand database concerns, some will work on site security, and others will deploy changes to the API and site. You’ll want to restrict access to different parts of the infrastructure. For example:</p><div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">terraform-dns/
  |
  |- README.md
  |- terraform.tfstate
  |- terraform.tfstate.backup
  |- .gitignore
  |- main.tf
  |- variables.tf
  |- outputs.tf
terraform-database/
  |
  |- README.md
  |- terraform.tfstate
  |- terraform.tfstate.backup
  |- .gitignore
  |- main.tf
  |- variables.tf
  |- outputs.tf

...</code></pre></div><p>In this setup, the Terraform state is managed per-module and each of the modules are kept in separate folders (and, likely, separate repositories). Access to the various services is managed through repository permissions and different IAM policies and roles so that only specific users can make changes to (or even see the configuration for) specific services. This is the most secure and least risky way to manage your infrastructure. Individual developers can’t accidentally make a change or destroy a critical resource if they don’t have access to it.</p><p>Unfortunately, this is also the most challenging setup. Making coordinated changes can be extremely cumbersome. For example, suppose you wanted to create an API action that sent an email from a new email sender when an entry was added to a new database table. You would need to coordinate changes to deploy the new database, create the new email address (and wait for verification), and deploy the serverless function. This would require changes to three repositories and at least three separate <code class="language-text">terraform apply</code> invocations to modify the different services. In a production site with many active users, it makes sense to plan and execute changes like this independently. In a small site with only one or two developers, this level of rigor is probably over-zealous.</p></section>
<section><h2 id="basic-project-setup" style="position:relative;"><a href="#basic-project-setup" aria-label="basic project setup permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Basic project setup</h2><p>To keep things simple, we’ll use a basic setup: keeping all of our configuration in a single folder but in separate Terraform files. We’ll also manage our state centrally (even though this may slow down our <code class="language-text">terraform apply</code> calls because the state of every resource must be checked). To start, we’ll want to create a <code class="language-text">terraform</code> folder:</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">mkdir</span> terraform
<span class="token builtin class-name">cd</span> terraform</code></pre></div><p>We’ll be using version control so that we can see what changes were made to our infrastructure over time. We’ll want to make sure we aren’t storing any secrets in our repository. Not only will we have secrets in our <code class="language-text">.tfvars</code> files but Terraform itself will store secrets in its state files. Because of this we need to ensure that they are ignored when using version control. Add a <code class="language-text">.gitignore</code>:</p><div class="gatsby-highlight" data-language="gitignore"><pre class="language-gitignore"><code class="language-gitignore"><span class="token comment"># Private key files</span>
<span class="token entry string"><span class="token operator">*</span>.pem</span>

<span class="token comment">#  Local .terraform directories</span>
<span class="token entry string"><span class="token operator">**</span><span class="token punctuation">/</span>.terraform<span class="token punctuation">/</span><span class="token operator">*</span></span>

<span class="token comment"># .tfstate files</span>
<span class="token entry string"><span class="token operator">*</span>.tfstate</span>
<span class="token entry string"><span class="token operator">*</span>.tfstate.<span class="token operator">*</span></span>

<span class="token comment"># .tfvars files</span>
<span class="token entry string"><span class="token operator">*</span>.tfvars</span></code></pre></div></section>
<section><h2 id="variables" style="position:relative;"><a href="#variables" aria-label="variables permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Variables</h2><p>Most of the configuration we’ll create will be generic. In fact, it could easily be repurposed for multiple websites with only a few small changes. Unfortunately, those small changes will be scattered across our configuration files. Terraform allows you to declare and use variables to simplify this. In the <code class="language-text">terraform</code> folder create a new file called <code class="language-text">variables.tf</code>:</p><div class="gatsby-highlight" data-language="ruby"><pre class="language-ruby"><code class="language-ruby">variable <span class="token string">"region"</span> <span class="token punctuation">{</span>
  default <span class="token operator">=</span> <span class="token string">"us-east-1"</span>
<span class="token punctuation">}</span>

variable <span class="token string">"profile"</span> <span class="token punctuation">{</span>
  default <span class="token operator">=</span> <span class="token string">"example"</span>
<span class="token punctuation">}</span>

variable <span class="token string">"domain"</span> <span class="token punctuation">{</span>
  default <span class="token operator">=</span> <span class="token string">"example.com"</span>
<span class="token punctuation">}</span></code></pre></div><p>We’ll use these variables as we write our configuration. For more information, see the <a href="https://www.terraform.io/docs/configuration/variables.html">Terraform documentation on input variables</a>.</p></section>
<section><h2 id="collaboration-and-remote-backends" style="position:relative;"><a href="#collaboration-and-remote-backends" aria-label="collaboration and remote backends permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Collaboration and remote backends</h2><p>Terraform tracks the last-known state for your configuration in the <code class="language-text">terraform.tfstate</code> and <code class="language-text">terraform.tfstate.backup</code> files. Terraform compares the stored state and configuration with what exists in the cloud. Running <code class="language-text">terraform apply</code> repeatedly should not make any changes. If we make a change to our configuration files and then run <code class="language-text">terraform apply</code> it will check the local state and apply the changes without completely recreating the resource. Because of this, the state<label for="sd-for-more-information" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sd-for-more-information" class="margin-toggle" /><span class="sidenote">For more information on how Terraform uses state files, see <a href="https://thorsten-hans.com/terraform-state-demystified">https://thorsten-hans.com/terraform-state-demystified</a>.</span> files are extremely important.</p><p>Even though they are important, the state files aren’t tracked in our repository (we’ve ignored them in the <code class="language-text">.gitignore</code>). We don’t want to store them in our repository because they will contain secrets which shouldn’t be pushed to GitHub. But what happens if another developer on our team clones our repository without the state files and runs <code class="language-text">terraform apply</code>? In some cases this can be bad - destroying and recreating resources that haven’t changed; in other cases it is just slow. We could make the assumption that we’re the only person working on our configuration via Terraform. Unfortunately, once you have multiple devices or multiple developers that assumption becomes very problematic.</p><p>Because of this we don’t want to keep our state locally; instead, we’ll move it to a shared, secure location and make sure it is encrypted.</p><p>To do this we’ll rely on Terraform’s <a href="https://www.terraform.io/docs/backends/index.html">remote backends</a> to share our state. Because we are already using AWS as our cloud provider, we’ll use the S3 backend. We’ll create an S3 bucket solely for the purpose of sharing state among our developers. Again, if we had chosen a more complex setup (where we were keeping the state for each service separately) we could use multiple buckets or restrict access to the shared state by key using specific IAM policies. For more detail you can refer to <a href="https://codethat.today/tutorial/terraform-remote-state-for-collaboration/">https://codethat.today/tutorial/terraform-remote-state-for-collaboration/</a> and <a href="https://medium.com/@jessgreb01/how-to-terraform-locking-state-in-s3-2dc9a5665cb6">https://medium.com/@jessgreb01/how-to-terraform-locking-state-in-s3-2dc9a5665cb6</a>.</p><p>Unsurprisingly, we’ll use Terraform to setup our remote backend. To do this we’ll need to configure three things:</p><ol>
<li>Choose a cloud provider</li>
<li>Create an S3 bucket to store the state</li>
<li>Configure the remote state</li>
</ol><p>To start, we’ll set the provider. Again, for this post we’ll be using AWS, so we’ll configure that in Terraform, In the <code class="language-text">terraform</code> folder, create a new file called <code class="language-text">aws.tf</code>:</p><div class="gatsby-highlight" data-language="ruby"><pre class="language-ruby"><code class="language-ruby"><span class="token comment"># Setup the provider for this Terraform instance</span>
provider <span class="token string">"aws"</span> <span class="token punctuation">{</span>
  region  <span class="token operator">=</span> var<span class="token punctuation">.</span>region
  profile <span class="token operator">=</span> var<span class="token punctuation">.</span>profile
<span class="token punctuation">}</span></code></pre></div><p>Notice that the value for the region uses a <em>variable reference</em>. We’ve also specified the profile with a variable. If you configured <code class="language-text">awscli</code> with a default profile you don’t need to include the profile name here.</p><blockquote>
<p>Even though we configured <code class="language-text">awscli</code> with our chosen region <code class="language-text">us-east-1</code>, we still need to set the <code class="language-text">region</code> in the provider block. This should be unnecessary but because of how Terraform connects to providers we must include it again.</p>
</blockquote><p>We’ll need to create an S3 bucket that will hold the state. Because S3 bucket names are global you’ll need to choose a unique name. To make sure my bucket name is unique, I generally use my domain name (without the <code class="language-text">.com</code>) as a prefix and add <code class="language-text">-state</code>. For example: <code class="language-text">example-state</code>. Create a new variable by adding the following to <code class="language-text">variables.tf</code> (replacing <code class="language-text">example</code> with your name):</p><div class="gatsby-highlight" data-language="ruby"><pre class="language-ruby"><code class="language-ruby">variable <span class="token string">"state_bucket"</span> <span class="token punctuation">{</span>
  default <span class="token operator">=</span> <span class="token string">"example-state"</span>
<span class="token punctuation">}</span></code></pre></div><p>Next, create a new file called <code class="language-text">storage.tf</code> in the <code class="language-text">terraform</code> folder:</p><div class="gatsby-highlight" data-language="ruby"><pre class="language-ruby"><code class="language-ruby"><span class="token comment"># Create a bucket to for remotely tracking Terraform state</span>
resource <span class="token string">"aws_s3_bucket"</span> <span class="token string">"state"</span> <span class="token punctuation">{</span>
  bucket <span class="token operator">=</span> var<span class="token punctuation">.</span>state_bucket
  acl    <span class="token operator">=</span> <span class="token string">"private"</span>

  versioning <span class="token punctuation">{</span>
    enabled <span class="token operator">=</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>

  lifecycle <span class="token punctuation">{</span>
    prevent_destroy <span class="token operator">=</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div><p>We’ve enabled <code class="language-text">versioning</code> for the bucket (as well as turning on <code class="language-text">prevent_destroy</code>). Though not required, this is highly recommended. Save <code class="language-text">storage.tf</code> and run the following command (from within the <code class="language-text">terraform</code> folder):</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">terraform init</code></pre></div><blockquote>
<p>If you are using an <code class="language-text">awscli</code> profile (as noted above) you’ll need to make sure you’ve exported the <code class="language-text">AWS_PROFILE</code> environment variable. On a Mac, you can even do this as part of the command, i.e, <code class="language-text">AWS_PROFILE=example terraform init</code>.</p>
</blockquote><p>You should see:</p><div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">Initializing the backend...

Initializing provider plugins...
- Finding latest version of hashicorp/aws...
- Installing hashicorp/aws v3.24.1...
- Installed hashicorp/aws v3.24.1 (signed by HashiCorp)

Terraform has created a lock file .terraform.lock.hcl to record the provider
selections it made above. Include this file in your version control repository
so that Terraform can guarantee to make the same selections by default when
you run &quot;terraform init&quot; in the future.

Terraform has been successfully initialized!

You may now begin working with Terraform. Try running &quot;terraform plan&quot; to see
any changes that are required for your infrastructure. All Terraform commands
should now work.

If you ever set or change modules or backend configuration for Terraform,
rerun this command to reinitialize your working directory. If you forget, other
commands will detect it and remind you to do so if necessary.</code></pre></div><p>Don’t worry if your version is different. To make sure everything is correct we’ll verify the plan. Terraform will read the configuration and create a plan for the changes it needs to make. Creating the plan doesn’t make any changes to the AWS instance, it just shows the plan:</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">terraform plan</code></pre></div><p>It should show the details of the S3 bucket it will create. We could save the plan to a file and re-use it later but we don’t need to do that right now. If everything looks right, go ahead and apply it (this will actually make changes):</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">terraform apply</code></pre></div><p>Answer <code class="language-text">yes</code><label for="sd-eventually-you-may" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sd-eventually-you-may" class="margin-toggle" /><span class="sidenote">Eventually, you may want to automate your infrastructure. If you are running the commands from your continuous integration for example, typing <code>yes</code> will be problematic. You can skip the prompt by adding the <code>-auto-approve</code> flag.</span> and your S3 bucket should be created.</p><p>Notice that Terraform has created new file called <code class="language-text">terraform.tfstate</code> (and possibly <code class="language-text">terraform.tfstate.backup</code>).</p><p>Again, because Terraform is tracking the state, if we re-run <code class="language-text">terraform apply</code>, it will not make any changes to our S3 bucket on AWS. If we make a change to our configuration (like adding a policy, for example) it can apply the changes without destroying and recreating the bucket. As mentioned above, we don’t want to keep our state locally, so we’ll move it to the remote backend (the S3 bucket we just created) by configuring it in Terraform.</p><p>Create a new file<label for="sd-terraform-will-still" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sd-terraform-will-still" class="margin-toggle" /><span class="sidenote">Terraform will still work even though we're splitting our configuration across multiple files. Terraform will read all of the <code>*.tf</code> files in the current folder when it is run. The order of your declarations doesn't matter. Terraform will do its best to determine the order things should be created or applied based on the interdependencies in the declarations.</span> called <code class="language-text">state.tf</code> in the <code class="language-text">terraform</code> folder:</p><div class="gatsby-highlight" data-language="ruby"><pre class="language-ruby"><code class="language-ruby"><span class="token comment"># Indicate how state should be managed</span>
terraform <span class="token punctuation">{</span>
  backend <span class="token string">"s3"</span> <span class="token punctuation">{</span>
    region  <span class="token operator">=</span> <span class="token string">"us-east-1"</span>
    profile <span class="token operator">=</span> <span class="token string">"example"</span>
    bucket  <span class="token operator">=</span> <span class="token string">"example-state"</span>
    key     <span class="token operator">=</span> <span class="token string">"terraform"</span>
    encrypt <span class="token operator">=</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div><p>Again we’ll want to set the <code class="language-text">bucket</code> value to the name of the bucket we’ve just created (replace <code class="language-text">example-state</code> with your chosen name).</p><blockquote>
<p>Wait - why aren’t we using <code class="language-text">var.region</code>, <code class="language-text">var.profile</code>, and <code class="language-text">var.state_bucket</code> variables? Terraform reads the values for the <code class="language-text">backend</code> resource very early in its lifecycle; because of this you cannot use variable interpolations and it cannot utilize the values in the <code class="language-text">provider</code> node. All of the values need to be redeclared as shown.</p>
</blockquote><p>With this new configuration in place we can check the plan:</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">terraform plan</code></pre></div><p>You should see:</p><div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">Backend reinitialization required. Please run &quot;terraform init&quot;.
Reason: Initial configuration of the requested backend &quot;s3&quot;

The &quot;backend&quot; is the interface that Terraform uses to store state,
perform operations, etc. If this message is showing up, it means that the
Terraform configuration you&#39;re using is using a custom configuration for
the Terraform backend.

Changes to backend configurations require reinitialization. This allows
Terraform to setup the new configuration, copy existing state, etc. This is
only done during &quot;terraform init&quot;. Please run that command now then try again.

If the change reason above is incorrect, please verify your configuration
hasn&#39;t changed and try again. At this point, no changes to your existing
configuration or state have been made.


Error: Initialization required. Please see the error message above.</code></pre></div><p>Terraform has detected that we want to change the location of our state. In this case we’ll do what it suggests:</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">terraform init</code></pre></div><p>You should see:</p><div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">Initializing the backend...
Do you want to copy existing state to the new backend?
  Pre-existing state was found while migrating the previous &quot;local&quot; backend to the
  newly configured &quot;s3&quot; backend. No existing state was found in the newly
  configured &quot;s3&quot; backend. Do you want to copy this state to the new &quot;s3&quot;
  backend? Enter &quot;yes&quot; to copy and &quot;no&quot; to start with an empty state.

  Enter a value:</code></pre></div><p>Type <code class="language-text">yes</code> and press enter:</p><div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">Successfully configured the backend &quot;s3&quot;! Terraform will automatically
use this backend unless the backend configuration changes.

Initializing provider plugins...
- Reusing previous version of hashicorp/aws from the dependency lock file
- Installing hashicorp/aws v3.24.1...
- Installed hashicorp/aws v3.24.1 (signed by HashiCorp)

Terraform has been successfully initialized!

You may now begin working with Terraform. Try running &quot;terraform plan&quot; to see
any changes that are required for your infrastructure. All Terraform commands
should now work.

If you ever set or change modules or backend configuration for Terraform,
rerun this command to reinitialize your working directory. If you forget, other
commands will detect it and remind you to do so if necessary.</code></pre></div><p>If you’re working with an older version, you may see the following error:</p><div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">Initializing the backend...
Error inspecting states in the &quot;s3&quot; backend:
    AccessDenied: Access Denied
	status code: 403, request id: ABCDEF123456789, host id: ABCDEF123456789/ABCDEF123456789+ABCDEF123456789=

Prior to changing backends, Terraform inspects the source and destination
states to determine what kind of migration steps need to be taken, if any.
Terraform failed to load the states. The data in both the source and the
destination remain unmodified. Please resolve the above error and try again.</code></pre></div><p>If you see this error, upgrade Terraform or <a href="#error-setting-up-the-remote-backend">follow the instructions</a> in the appendix.</p><p>If we run <code class="language-text">terraform plan</code> again we should see that everything is up to date:</p><div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">Refreshing Terraform state in-memory prior to plan...
The refreshed state will be used to calculate this plan, but will not be
persisted to local or remote state storage.

aws_s3_bucket.state: Refreshing state... (ID: example-state)

------------------------------------------------------------------------

No changes. Infrastructure is up-to-date.

This means that Terraform did not detect any differences between your
configuration and real physical resources that exist. As a result, no
actions need to be performed.</code></pre></div><p>With the state moved to the remote backend, the local <code class="language-text">terraform.tfstate</code> and <code class="language-text">terraform.tfstate.backup</code> files are no longer needed and can be safely deleted.</p><div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">rm terraform.tfstate
rm terraform.tfstate.backup</code></pre></div><p>That’s a lot of setup; but at this point we’re ready to start building out the main resources for our application and, ideally, we won’t need to configure anything else in the AWS console directly.</p><blockquote>
<p>Note: we could go even further and introduce remote-state locking (see <a href="https://dev.to/theodesp/using-terraform-remote-state-for-collaboration-4661">https://dev.to/theodesp/using-terraform-remote-state-for-collaboration-4661</a>). For now we’ll assume that only one developer will be deploying at a time. Ultimately, we’ll want to move our infrastructure management into our continuous deployment tooling; at that point locking will need to be managed differently.</p>
</blockquote></section>
<section><h2 id="dns" style="position:relative;"><a href="#dns" aria-label="dns permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>DNS</h2><p>We’ll want to use our own domain for everything: our site, our email, and our API. Domain configuration is controlled through a domain’s nameservers. There are a number of options available for managing your DNS nameservers and entries. You could choose to use the default nameservers provided by the service where you purchased your domain (such as <a href="https://domains.google">Google Domains</a>). You could also use <a href="https://developers.cloudflare.com/terraform/">Cloudflare</a> which provides a built-in CDN, shared SSL certificates, and DOS protection (and is free for the basic plan). You can also use <a href="https://aws.amazon.com/route53/">Route53</a> which is part of AWS.</p><p>In our case, we’ll use Route53 as it is easily configurable in Terraform and makes some of our service approvals automatic. This is the first thing we’ll use that costs money. Creating a zone costs <a href="https://aws.amazon.com/route53/pricing/">$0.50 per hosted zone per month</a> and is charged immediately (it is not prorated). For larger sites with many zones responding to many queries it is possible the cost could go up; but because we’ll be pointing to other AWS services we should only need one zone and our costs shouldn’t go up..</p><blockquote>
<p>Actually, if you destroy the zone within 12 hours of creation the cost of the zone will be refunded.</p>
</blockquote><p>We’ll start with our primary zone configuration and nameservers. Within the <code class="language-text">terraform</code> directory create a new file, <code class="language-text">dns.tf</code>:</p><div class="gatsby-highlight" data-language="ruby"><pre class="language-ruby"><code class="language-ruby"><span class="token comment"># Define the primary zone for our domain</span>
resource <span class="token string">"aws_route53_zone"</span> <span class="token string">"domain_zone"</span> <span class="token punctuation">{</span>
  name <span class="token operator">=</span> var<span class="token punctuation">.</span>domain
<span class="token punctuation">}</span>

<span class="token comment"># Create the nameservers for our domain</span>
resource <span class="token string">"aws_route53_record"</span> <span class="token string">"domain_nameservers"</span> <span class="token punctuation">{</span>
  zone_id         <span class="token operator">=</span> aws_route53_zone<span class="token punctuation">.</span>domain_zone<span class="token punctuation">.</span>zone_id
  name            <span class="token operator">=</span> aws_route53_zone<span class="token punctuation">.</span>domain_zone<span class="token punctuation">.</span>name
  type            <span class="token operator">=</span> <span class="token string">"NS"</span>
  ttl             <span class="token operator">=</span> <span class="token string">"30"</span>
  allow_overwrite <span class="token operator">=</span> <span class="token boolean">true</span>

  records <span class="token operator">=</span> <span class="token punctuation">[</span>
    aws_route53_zone<span class="token punctuation">.</span>domain_zone<span class="token punctuation">.</span>name_servers<span class="token punctuation">.</span><span class="token number">0</span><span class="token punctuation">,</span>
    aws_route53_zone<span class="token punctuation">.</span>domain_zone<span class="token punctuation">.</span>name_servers<span class="token punctuation">.</span><span class="token number">1</span><span class="token punctuation">,</span>
    aws_route53_zone<span class="token punctuation">.</span>domain_zone<span class="token punctuation">.</span>name_servers<span class="token punctuation">.</span><span class="token number">2</span><span class="token punctuation">,</span>
    aws_route53_zone<span class="token punctuation">.</span>domain_zone<span class="token punctuation">.</span>name_servers<span class="token punctuation">.</span><span class="token number">3</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span></code></pre></div><p>We’ve configured the <code class="language-text">name</code> of our zone using a variable. We’ve already setup the <code class="language-text">domain</code> variable in <code class="language-text">variables.tf</code>. Your domain name should be set to the root domain name (such as <code class="language-text">example.com</code>) and should not include the subdomain. For example, do not include <code class="language-text">www</code> or the protocol <code class="language-text">https</code>.</p><p>Notice that we have set a very short <code class="language-text">ttl</code> (Time-to-live). This controls how long DNS servers (and browsers) should cache your domain after looking it up. Setting a very short time like this (30 seconds) makes it much faster to make changes without needing to wait a long time for propagation. However, it also increases the number of requests that users need to make (and that AWS needs to serve). Long-term, we’ll want to change this to <code class="language-text">300</code> or <code class="language-text">600</code> (5 minutes or 10 minutes).</p><p>We’ve also specified <code class="language-text">allow_overwrite</code>. When the nameservers are created, <a href="https://www.terraform.io/docs/providers/aws/r/route53_record.html#ns-and-soa-record-management">Terraform automatically generates</a> <code class="language-text">NS</code> and <code class="language-text">SOA</code> entries by default. We want to allow those entries to be set in our state (overwriting anything that might already be present).</p><p>With this setup, we can check the plan:</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">terraform plan</code></pre></div><p>According to the plan we’ll add a zone and setup the nameservers. Let’s apply it:</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">terraform apply</code></pre></div><p>When prompted, answer <code class="language-text">yes</code>:</p><div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">aws_s3_bucket.state: Refreshing state... [id=example-state]

An execution plan has been generated and is shown below.
Resource actions are indicated with the following symbols:
  + create

Terraform will perform the following actions:

  # aws_route53_record.domain_nameservers will be created
  + resource &quot;aws_route53_record&quot; &quot;domain_nameservers&quot; {
      + allow_overwrite = true
      + fqdn            = (known after apply)
      + id              = (known after apply)
      + name            = &quot;example.com&quot;
      + records         = (known after apply)
      + ttl             = 30
      + type            = &quot;NS&quot;
      + zone_id         = (known after apply)
    }

  # aws_route53_zone.domain_zone will be created
  + resource &quot;aws_route53_zone&quot; &quot;domain_zone&quot; {
      + comment       = &quot;Managed by Terraform&quot;
      + force_destroy = false
      + id            = (known after apply)
      + name          = &quot;example.com&quot;
      + name_servers  = (known after apply)
      + zone_id       = (known after apply)
    }

Plan: 2 to add, 0 to change, 0 to destroy.

Do you want to perform these actions?
  Terraform will perform the actions described above.
  Only &#39;yes&#39; will be accepted to approve.

  Enter a value: yes

aws_route53_zone.domain_zone: Creating...
aws_route53_zone.domain_zone: Still creating... [10s elapsed]
aws_route53_zone.domain_zone: Still creating... [20s elapsed]
aws_route53_zone.domain_zone: Still creating... [30s elapsed]
aws_route53_zone.domain_zone: Creation complete after 35s [id=REDACTED]
aws_route53_record.domain_nameservers: Creating...
aws_route53_record.domain_nameservers: Still creating... [10s elapsed]
aws_route53_record.domain_nameservers: Still creating... [20s elapsed]
aws_route53_record.domain_nameservers: Still creating... [30s elapsed]
aws_route53_record.domain_nameservers: Creation complete after 34s [id=REDACTED_example.com_NS]

Apply complete! Resources: 2 added, 0 changed, 0 destroyed.</code></pre></div><p>The primary zone and nameserver entries should be created. Now that the nameservers have been created we’ll need to fetch them. Run:</p><div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">terraform state show aws_route53_record.domain_nameservers</code></pre></div><p>In the output you should see the list of nameservers:</p><div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">...
records         = [
    &quot;ns-1283.awsdns-32.org&quot;,
    &quot;ns-1574.awsdns-04.co.uk&quot;,
    &quot;ns-492.awsdns-61.com&quot;,
    &quot;ns-862.awsdns-43.net&quot;,
]
...</code></pre></div><blockquote>
<p>These nameservers are just an example; the nameservers listed for your zone will be different.</p>
</blockquote><p>We’ll need to copy these values so that we can set the nameservers our domain registrar points to.<label for="sd-less-than-em-greater" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sd-less-than-em-greater" class="margin-toggle" /><span class="sidenote"><em>Be careful</em>: at this point our Route53 configuration is completely empty. For a new domain that's probably fine. If you've added DNS entries to your current nameservers (or if there are default entries managed by your registrar) these will no longer be set. For example, if you've setup an email alias (as described earlier) your existing DNS configuration likely has an <code>MX</code> record denoting it. We'll fix this later but if you are relying on your current setup, you should proceed cautiously.</span></p><p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1032px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/98107686ef27d45f7471ed053cb21f3f/12bff/google-domains-nameservers.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 55.00000000000001%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsSAAALEgHS3X78AAABAUlEQVQoz6VSW2rEMAz0/e/Rq5T+9AD9KiykTbp+ZONHUj8ylezdsFDKktQwyJatkTSyCPOMyzRhJvvfVdYVYiKyrvtA3w8YzgpnqTGOI5TSMMZAa9OsaZahtIZUqvp4X/0Uk1KC8N7js+8JA7pe40saWGvBfkYIYYP3hGo9nPPXN83PHa5c4XeMNZOmTFqrGsi+o0uknCmbI6KWYdOjlHr+C/f393uRibDqQpqwnnxm8KM94JiNkIfALbN2e4l+EaaUMVlXq2ORb5dHUAmBjBjom0iJkVqPMR0i4y/DxYiTjHh+s7jYABeWh8N4NCTx+r7g6SVgSUDM2C5LWfdhbfYHAINeAupar3EAAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="Add the nameserver entries to Google Domains"
        title="Add the nameserver entries to Google Domains"
        src="/static/98107686ef27d45f7471ed053cb21f3f/12bff/google-domains-nameservers.png"
        srcset="/static/98107686ef27d45f7471ed053cb21f3f/72799/google-domains-nameservers.png 320w,
/static/98107686ef27d45f7471ed053cb21f3f/6af66/google-domains-nameservers.png 640w,
/static/98107686ef27d45f7471ed053cb21f3f/12bff/google-domains-nameservers.png 1032w"
        sizes="(max-width: 1032px) 100vw, 1032px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
      />
  </a>
    </span></p><p>Once saved, you’ll need to wait for the changes to propagate through DNS. This can take up to 48 hours; however I find this usually happens much faster (sometimes as fast as 5 minutes). If you want to check what nameservers are reported for your domain run:</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"> <span class="token function">dig</span> +short NS example.com</code></pre></div><p>If the DNS has fully propagated the answer should match the nameservers listed above. You’ll need to wait for this before proceeding.</p></section>
<section><h2 id="certs" style="position:relative;"><a href="#certs" aria-label="certs permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Certs</h2><p>Once your DNS is setup to point at Route53 you’ll want to create a certificate for securing communications with your domain (SSL/TLS). To do this we will use AWS Certificate Manager (<code class="language-text">acm</code>). Luckily, <a href="https://aws.amazon.com/certificate-manager/pricing/">public certificates are free</a>:</p><blockquote>
<p>From the AWS Certificate Manager pricing page: “Public SSL/TLS certificates provisioned through AWS Certificate Manager are free. You pay only for the AWS resources you create to run your application.”</p>
</blockquote><p>Create a new file in the <code class="language-text">terraform</code> folder called <code class="language-text">cert.tf</code>:</p><div class="gatsby-highlight" data-language="ruby"><pre class="language-ruby"><code class="language-ruby"><span class="token comment"># An ACM certificate is needed to apply a custom domain name</span>
<span class="token comment"># to the API Gateway resource and cloudfront distributions</span>
resource <span class="token string">"aws_acm_certificate"</span> <span class="token string">"cert"</span> <span class="token punctuation">{</span>
  domain_name       <span class="token operator">=</span> aws_route53_zone<span class="token punctuation">.</span>domain_zone<span class="token punctuation">.</span>name
  validation_method <span class="token operator">=</span> <span class="token string">"DNS"</span>

  subject_alternative_names <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">"*.${aws_route53_zone.domain_zone.name}"</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span>

  lifecycle <span class="token punctuation">{</span>
    create_before_destroy <span class="token operator">=</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment"># AWS needs to verify that we own the domain; to prove this we will create a</span>
<span class="token comment"># DNS entry with a validation code</span>
resource <span class="token string">"aws_route53_record"</span> <span class="token string">"cert_validation_record"</span> <span class="token punctuation">{</span>
  name    <span class="token operator">=</span> tolist<span class="token punctuation">(</span>aws_acm_certificate<span class="token punctuation">.</span>cert<span class="token punctuation">.</span>domain_validation_options<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>resource_record_name
  type    <span class="token operator">=</span> tolist<span class="token punctuation">(</span>aws_acm_certificate<span class="token punctuation">.</span>cert<span class="token punctuation">.</span>domain_validation_options<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>resource_record_type
  records <span class="token operator">=</span> <span class="token punctuation">[</span>tolist<span class="token punctuation">(</span>aws_acm_certificate<span class="token punctuation">.</span>cert<span class="token punctuation">.</span>domain_validation_options<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>resource_record_value<span class="token punctuation">]</span>
  zone_id <span class="token operator">=</span> aws_route53_zone<span class="token punctuation">.</span>domain_zone<span class="token punctuation">.</span>zone_id
  ttl     <span class="token operator">=</span> <span class="token number">60</span>
<span class="token punctuation">}</span>

resource <span class="token string">"aws_acm_certificate_validation"</span> <span class="token string">"cert_validation"</span> <span class="token punctuation">{</span>
  certificate_arn         <span class="token operator">=</span> aws_acm_certificate<span class="token punctuation">.</span>cert<span class="token punctuation">.</span>arn
  validation_record_fqdns <span class="token operator">=</span> <span class="token punctuation">[</span>aws_route53_record<span class="token punctuation">.</span>cert_validation_record<span class="token punctuation">.</span>fqdn<span class="token punctuation">]</span>
<span class="token punctuation">}</span></code></pre></div><p>We’ve created three resources:</p><ul>
<li>A new <code class="language-text">acm</code> certificate for our domain name</li>
<li>A DNS record for domain ownership validation</li>
<li>A certificate validation that connects the two</li>
</ul><p>When generating a secure certificate for a domain; the certificate authority must ensure that you are the owner of the domain. To validate this, a DNS record is added to prove you are in control of the domain. We’ll use Terraform to generate the entry and AWS will validate it and generate the certificate. Luckily, because we’re using Route53 for our domain, this validation is almost instantaneous. If you are utilizing another nameserver, you’ll need to wait on propagation.</p><p>Notice that we’ve set our <code class="language-text">domain_name</code> to <code class="language-text">aws_route53_zone.domain_zone.name</code>. This is an <em>value</em> which uses the name we already entered in our <code class="language-text">domain_zone</code>. Technically the <code class="language-text">domain_zone</code> domain name has an extra <code class="language-text">.</code> at the end of the name but Terraform is smart enough to remove that. Creating interdependencies between your resources makes it easier to make changes in the future because there is less to change.</p><p>Check the plan:</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">terraform plan</code></pre></div><p>And if it looks right, apply it:</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">terraform apply</code></pre></div><p>This might take a few minutes to complete.</p></section>
<section><h2 id="email" style="position:relative;"><a href="#email" aria-label="email permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Email</h2><p>Eventually we will want to send and receive emails from our website. To do this we’ll use AWS Simple Email Service (SES). We could use <a href="https://sendgrid.com/">SendGrid</a> or <a href="https://mailchimp.com/">MailChimp</a> to do this but AWS Simple Email Service is easy to integrate with all of our services<label for="sd-checkout-less-than-a" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sd-checkout-less-than-a" class="margin-toggle" /><span class="sidenote">Checkout <a href="https://blog.mailtrap.io/amazon-ses-vs-sendgrid/">Mailtrap's Amazon SES vs Sendgrid</a> post for a thorough breakdown of the differences.</span>. Additionally, AWS Simple Email Service shouldn’t cost anything initially. According to the <a href="https://aws.amazon.com/ses/pricing/">pricing page</a>:</p><blockquote>
<p>You pay $0 for the first 62,000 emails you send each month, and $0.10 for every 1,000 emails you send after that.</p>
</blockquote><p>Although we don’t need to setup email just yet, verifying your email and increasing your usage limits can take a lot of time and may involve a lot of waiting. Because of this I like to start the process as early as I can.</p><p>For now we have three goals:</p><ul>
<li>Enable sending from a <code class="language-text">no-reply@example.com</code> email address</li>
<li>Enable SPF verification of the emails we send</li>
<li>Allow email forwarding through our Google Domain email forwards</li>
</ul><p>Create a new file in the <code class="language-text">terraform</code> folder called <code class="language-text">email.tf</code>:</p><div class="gatsby-highlight" data-language="ruby"><pre class="language-ruby"><code class="language-ruby">resource <span class="token string">"aws_ses_domain_identity"</span> <span class="token string">"domain_identity"</span> <span class="token punctuation">{</span>
  domain <span class="token operator">=</span> aws_route53_zone<span class="token punctuation">.</span>domain_zone<span class="token punctuation">.</span>name
<span class="token punctuation">}</span>

<span class="token comment"># Note: this may take up to 72 hours to verify</span>
resource <span class="token string">"aws_route53_record"</span> <span class="token string">"amazonses_verification"</span> <span class="token punctuation">{</span>
  zone_id <span class="token operator">=</span> aws_route53_zone<span class="token punctuation">.</span>domain_zone<span class="token punctuation">.</span>id
  name    <span class="token operator">=</span> <span class="token string">"_amazonses.${aws_ses_domain_identity.domain_identity.domain}"</span>
  type    <span class="token operator">=</span> <span class="token string">"TXT"</span>
  ttl     <span class="token operator">=</span> <span class="token string">"600"</span>
  records <span class="token operator">=</span> <span class="token punctuation">[</span>aws_ses_domain_identity<span class="token punctuation">.</span>domain_identity<span class="token punctuation">.</span>verification_token<span class="token punctuation">]</span>
<span class="token punctuation">}</span>

resource <span class="token string">"aws_ses_domain_mail_from"</span> <span class="token string">"domain_mail_from"</span> <span class="token punctuation">{</span>
  domain           <span class="token operator">=</span> aws_ses_domain_identity<span class="token punctuation">.</span>domain_identity<span class="token punctuation">.</span>domain
  mail_from_domain <span class="token operator">=</span> <span class="token string">"mail.${aws_ses_domain_identity.domain_identity.domain}"</span>
<span class="token punctuation">}</span>

resource <span class="token string">"aws_route53_record"</span> <span class="token string">"domain_mail_from_mx"</span> <span class="token punctuation">{</span>
  zone_id <span class="token operator">=</span> aws_route53_zone<span class="token punctuation">.</span>domain_zone<span class="token punctuation">.</span>id
  name    <span class="token operator">=</span> aws_ses_domain_mail_from<span class="token punctuation">.</span>domain_mail_from<span class="token punctuation">.</span>mail_from_domain
  type    <span class="token operator">=</span> <span class="token string">"MX"</span>
  ttl     <span class="token operator">=</span> <span class="token string">"600"</span>

  <span class="token comment"># The region must match the region in which `aws_ses_domain_identity` is created</span>
  records <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"10 feedback-smtp.${var.region}.amazonses.com"</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>

resource <span class="token string">"aws_route53_record"</span> <span class="token string">"domain_mail_from_spf"</span> <span class="token punctuation">{</span>
  zone_id <span class="token operator">=</span> aws_route53_zone<span class="token punctuation">.</span>domain_zone<span class="token punctuation">.</span>id
  name    <span class="token operator">=</span> aws_ses_domain_mail_from<span class="token punctuation">.</span>domain_mail_from<span class="token punctuation">.</span>mail_from_domain
  type    <span class="token operator">=</span> <span class="token string">"TXT"</span>
  ttl     <span class="token operator">=</span> <span class="token string">"600"</span>
  records <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"v=spf1 include:amazonses.com -all"</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>

resource <span class="token string">"aws_ses_email_identity"</span> <span class="token string">"no_reply"</span> <span class="token punctuation">{</span>
  email <span class="token operator">=</span> <span class="token string">"no-reply@${aws_ses_domain_identity.domain_identity.domain}"</span>
<span class="token punctuation">}</span>

<span class="token comment"># This enables Google's domain email forwarding for emails</span>
<span class="token comment"># https://support.google.com/domains/answer/9428703</span>
<span class="token comment"># Create this record first to avoid resending the email verification</span>
resource <span class="token string">"aws_route53_record"</span> <span class="token string">"google_mx"</span> <span class="token punctuation">{</span>
  zone_id <span class="token operator">=</span> aws_route53_zone<span class="token punctuation">.</span>domain_zone<span class="token punctuation">.</span>id
  type    <span class="token operator">=</span> <span class="token string">"MX"</span>
  ttl     <span class="token operator">=</span> <span class="token string">"30"</span>
  name    <span class="token operator">=</span> <span class="token string">""</span>

  records <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">"5 gmr-smtp-in.l.google.com"</span><span class="token punctuation">,</span>
    <span class="token string">"10 alt1.gmr-smtp-in.l.google.com"</span><span class="token punctuation">,</span>
    <span class="token string">"20 alt2.gmr-smtp-in.l.google.com"</span><span class="token punctuation">,</span>
    <span class="token string">"30 alt3.gmr-smtp-in.l.google.com"</span><span class="token punctuation">,</span>
    <span class="token string">"40 alt4.gmr-smtp-in.l.google.com"</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span></code></pre></div><p>There’s a lot going on here; let’s break it down.</p><p>The first resource we create is an <code class="language-text">aws_ses_domain_identity</code>. This identity is for our root domain and is the basis of the rest of the declarations. Also, this is the domain that will be used for our email address. Ideally this matches your main site domain. Before Amazon sends emails from this address it must be verified. Just like we saw with the certificate verification, the email verification is performed by adding another DNS record to Route53. Unlike the certificate verification, this verification can take a long time - up to 72 hours (I’ve seen it take longer than 24 hours and as little as 5 minutes).</p><p>Based on the domain identity we’ll create an <code class="language-text">aws_ses_domain_mail_from</code> resource. The mail-from domain is not directly visible to end users but is used for bounced messages and domain verification by email servers.<label for="sd-custom-mail-from" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sd-custom-mail-from" class="margin-toggle" /><span class="sidenote">Custom mail-from domains add legitimacy to your emails. For more information, see <a href="https://docs.aws.amazon.com/ses/latest/DeveloperGuide/mail-from.html">https://docs.aws.amazon.com/ses/latest/DeveloperGuide/mail-from.html</a></span> Because of this, the mail-from domain and root domain must be different; the mail-from domain is usually a subdomain. Here we’ve specified <code class="language-text">mail.</code> as the subdomain.</p><p>When sending or receiving mail, remote servers will look up the domain of the email address in DNS. It will use the records to determine how to exchange mail for the domain and whether or not to trust the email. Because of this we need to add a Mail Exchanger (<code class="language-text">MX</code>) record to Route53 for our mail-from domain. Additionally we’ll add a Sender Policy Framework (<code class="language-text">SPF</code>) record. Without this, our emails would always end up in user’s spam folders.</p><p>With the mail-from domain configured we can create an email identity for sending emails. In this case, I’ve chosen <code class="language-text">no-reply@example.com</code>. This is fairly standard if you don’t plan on handling replies, however you might want something more personal or in-line with your website’s brand. Change the <code class="language-text">name</code> however you like.</p><p>Lastly, we configure what happens to emails sent directly to our domain. Remember, we configured email forwarding at the very beginning of the post. You might have noticed when we changed our nameservers to point to Route53 that email forwarding completely broke. This is because email exchange servers no longer know where to send the emails. To fix this we need to point the exchangers back to our registrar (in my case Google Domains).</p><p>Let’s check the plan:</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">terraform plan</code></pre></div><p>And apply it:</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">terraform apply</code></pre></div><p>This should complete in a few minutes.</p><h3 id="verifications" style="position:relative;"><a href="#verifications" aria-label="verifications permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Verifications</h3><p>With the creation complete we can move on to the approvals. If you open the <a href="https://console.aws.amazon.com/ses/">Simple Email Service console</a> and click on <strong>Email Addresses</strong> in the sidebar. You’ll see that you need to confirm the email address for sending.</p><p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 210px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/b53fa30d54a321048a7b58c4df8b42b0/65ed1/ses-pending-verification.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 38.57142857142858%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsSAAALEgHS3X78AAABX0lEQVQoz32Qy2vCQBCH8//fPfg4Vig5GKTFo4cWemh7aGlBzcOgNYlm87AYk2iy++vsJnqSLnzM7LfD7DBaHMdIkgQypmmqonJx4+Tb5V0SRdG/aEEQYLPZwPM8uK4L3/cV8r7dblVcr9eQdYEfYLfbgYUMYRjeRJvP5+h2u9B1HZ1OB8PhEP1+H4PBAIZhYDweX32v18NoNFJN1Qc30OTvlmXBcRy4yyVsyi3TVM627cZRlM40FyquVqubyF6aHDOifbGWKE5pF7Qr2hejXBG1XkF1jCGJGNUxxC3Syck18BqiPCj4MQXPU4j6BHHOwYs96r0HccqU58Wv8nl5QpqVyIozDsSe8oKcPNqZOcje75F/TxTHTwPFYorSfsbxw0D+9UA8NjWUl84LZs4P7qYz6E8mJm8uJq+0FnfdNBQVTUNTXo7gFU1DkwgBcXW8ubeuqiqSAjVvKuqaE02PP9PuTFNubDkUAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="Pending verification"
        title="Pending verification"
        src="/static/b53fa30d54a321048a7b58c4df8b42b0/65ed1/ses-pending-verification.png"
        srcset="/static/b53fa30d54a321048a7b58c4df8b42b0/65ed1/ses-pending-verification.png 210w"
        sizes="(max-width: 210px) 100vw, 210px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
      />
  </a>
    </span></p><p>You should have received an email to <code class="language-text">no-reply@example.com</code>. If you haven’t received an email it might be because your email forwarding setup hasn’t propagated. Wait a few minutes and click <strong>resend</strong>. Once you’ve clicked the link in the verification email, you’re done.</p><h3 id="sandbox-mode-and-sending-limits" style="position:relative;"><a href="#sandbox-mode-and-sending-limits" aria-label="sandbox mode and sending limits permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Sandbox mode and sending limits</h3><p>At this point your account should still be in <strong>Sandbox</strong> mode (you can see this by going to <a href="https://console.aws.amazon.com/ses">https://console.aws.amazon.com/ses</a> and clicking on the <strong>Sending Statistics</strong> link in the sidebar). In this mode you can send emails only to verified email addresses. You can verify your own email address for development purposes but you need to request that the limit be increased before moving to production.</p><p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 956px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/8bc393725a2166a54a391d2c7af78e14/7b1dc/ses-sending-limit.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 17.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAAsSAAALEgHS3X78AAAAxklEQVQY032NOQvCQBCF8/8rG8FGEGvBXhAFj0JFUKNZNaJoNjceickGEnnOJhHBwuLjHTszq+xcgYXxxNqMiBgbq0Arkb1KaHaMFY/ASPe0I/d0T+DgJ7n/dMrkGGJ6kjzBLj6OhgNmRVhyOmyLHJU+Yk6CtfX1GvVSmVPMyCzflfrARnPsojFy0Z77aM08DPUAbvQCf6TgQZqrHWZFJgzCoiz1fC9niAt5pdrlqPUkJmp9E5WOgf72gTgD/PiFq/jP7Se/ATcmJ4eviwhFAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="Sandbox mode"
        title="Sandbox mode"
        src="/static/8bc393725a2166a54a391d2c7af78e14/7b1dc/ses-sending-limit.png"
        srcset="/static/8bc393725a2166a54a391d2c7af78e14/72799/ses-sending-limit.png 320w,
/static/8bc393725a2166a54a391d2c7af78e14/6af66/ses-sending-limit.png 640w,
/static/8bc393725a2166a54a391d2c7af78e14/7b1dc/ses-sending-limit.png 956w"
        sizes="(max-width: 956px) 100vw, 956px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
      />
  </a>
    </span></p><p>Click <strong>Request a Sending Limit Increase</strong>.</p><p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1013px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/7ac4dfea04878456b943767892527a32/4b2cc/ses-service-limit-increase.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 16.249999999999996%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAAAsSAAALEgHS3X78AAAAq0lEQVQI112N246DIBRF+/+/15cxdlJ78QKKFQQEcVyD7VtPsnOyk5W1T9M00XYddd180rSEsPCynkvTUz4FxaPjtx2QNnAdPePsUEohZM8wKLZtY02JECMn2ffcbvcMjAwZOrqdZ7QP/FQ15+JKkf9D5mFlkC5loaWqKsryghACYwxaG+IhTNm87zvfp/3CuGxM4Q8dd+bEO6+jO485RrPIeY91Dp/5uK78A4IZ5HQVvHhzAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="Service limit increase"
        title="Service limit increase"
        src="/static/7ac4dfea04878456b943767892527a32/4b2cc/ses-service-limit-increase.png"
        srcset="/static/7ac4dfea04878456b943767892527a32/72799/ses-service-limit-increase.png 320w,
/static/7ac4dfea04878456b943767892527a32/6af66/ses-service-limit-increase.png 640w,
/static/7ac4dfea04878456b943767892527a32/4b2cc/ses-service-limit-increase.png 1013w"
        sizes="(max-width: 1013px) 100vw, 1013px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
      />
  </a>
    </span></p><p>Choose *<em>Service limit increase</em> (it should be selected by default).</p><p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1013px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/14b13c1871ed3a98a3e6ebf8b3e86a3f/4b2cc/ses-case-classification.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 63.125%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsSAAALEgHS3X78AAABVklEQVQ4y51TCW6DMBDk/z9sEtKQcoPxBeFIYLprQoTSqqBaGnm9smevsSeEQBBccfJ9ZFmOvu/Rdd2/0BK8um6gtcbtdnPOx+PxEyNjxLgBvutJpRBcQ0ilcb/fMQEYpwnTE2z3w+DsPWsmDGNkQsIYC2Nr2HqGsZYybzFwoCfhtAr2Gzx+lOa5gybbMNECO++2aVxJC+H7WgfzqkrSQM6I4wQdDcSV+dabdcmbhJaySNIUTNy23au547hgPu8mLEk2/vkToqrA/SxEhcy0yG2PVLfIpEVhO77tBrZdspQIwwiCiPKicEhJj0maIcsLt3Mv1wPZ7OHlEiCMYpLPFTmRsC6lVFAkJQ64yAl7CPkRE35RlpxpGEWOnM9RHDsfk++RzNzDUuDjcMTheIJP0+Z+FmUJ9jP4OyqlsHd5DX05FrQ25gXWpn76FJXPNkuHBT7w/ge+AQfs85UyxuIxAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="Case classification"
        title="Case classification"
        src="/static/14b13c1871ed3a98a3e6ebf8b3e86a3f/4b2cc/ses-case-classification.png"
        srcset="/static/14b13c1871ed3a98a3e6ebf8b3e86a3f/72799/ses-case-classification.png 320w,
/static/14b13c1871ed3a98a3e6ebf8b3e86a3f/6af66/ses-case-classification.png 640w,
/static/14b13c1871ed3a98a3e6ebf8b3e86a3f/4b2cc/ses-case-classification.png 1013w"
        sizes="(max-width: 1013px) 100vw, 1013px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
      />
  </a>
    </span></p><p>Next make sure the <strong>Limit type</strong> is <code class="language-text">SES Sending Limit</code>, the <strong>Mail Type</strong> is <code class="language-text">Transactional</code> and you have entered your domain name (it is okay that your website isn’t deployed).</p><p>Amazon’s Terms and AUP are very specific about how emails, bounces, and unsubscribes are treated. The links offer helpful recommendations and are worth reading. We’re not planning on using SES for a mailing list (all of our emails are transactional and related to the service). For the next two questions I answer:</p><div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">The emails in this case are all transactional (signup, password-reset)</code></pre></div><p>Handling complaints and - more importantly - reducing the number of complaints is also important. Here is how I describe my process:</p><div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">We&#39;ll remove addresses that bounce as well as addresses of users
that have complained. But more importantly valid addresses are required
to be verified to submit content. We only ask for an account at the time
we need to; to avoid fake addresses.</code></pre></div><p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1011px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/cc753f0802190f12af2f474f4c3cec04/6bfd0/ses-request-limit.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 50%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsSAAALEgHS3X78AAABKklEQVQoz52QW0/DMAyF8/9/Hki8wIB22qDpvekl94OdrtvQtgeI9Ok4dnLiWEgpkWcZrDFw1sJa1jX+hTthH2GSh2jUhGM9oJ8Nuskk7Web4nZcCJ20UXPiktPnGtNNGpPxEL0FdlLh+S3D02uOl48DxTl2XzX21YC87JHJDu+0ZzjmXE41rvOeObQTWh0girLG5/6I2TgYH7FYn+DYRdxgmXCBc5rODrOme46+3DSoqopmZ9MMQgiIMSYNwSe896DkCu5A+UjnORZt1+G7KFCSaSFLaK2TGZv4k2p6iB9ZPeMdkBarGJQiI4maOmXzhQzZyPm1M1ZD3cft1oO11c8dOudSYjO5hnP3O7tFaG2gxhHjNCW2Gf4XwTNr246+22NQYzK8/sJf1w9P6wzZBJdf6QAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="Request limit"
        title="Request limit"
        src="/static/cc753f0802190f12af2f474f4c3cec04/6bfd0/ses-request-limit.png"
        srcset="/static/cc753f0802190f12af2f474f4c3cec04/72799/ses-request-limit.png 320w,
/static/cc753f0802190f12af2f474f4c3cec04/6af66/ses-request-limit.png 640w,
/static/cc753f0802190f12af2f474f4c3cec04/6bfd0/ses-request-limit.png 1011w"
        sizes="(max-width: 1011px) 100vw, 1011px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
      />
  </a>
    </span></p><p>To start, I’ve chosen to increase the <code class="language-text">Desired Daily Sending Quota</code> to <code class="language-text">10000</code>. This should be more than enough to get started.</p><p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1014px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/6fda7bf47bf50b0d10b68dbf9ac46a73/d7ab4/ses-case-description.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 36.5625%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsSAAALEgHS3X78AAAAr0lEQVQoz6WR4QqEIBCEe//HrKP+XKWVpmbN7YhGRBwct/ChO7vMrlj1w4CmeaGuG0zzjBACnHPw3sNlfMbdOLXcb9cVldIabduh7TopeMQYsZFtS/en/NQv2r7vaZnKWIt33yeUUoLGKOc4KuhpAgeSpAmaOfuyxu2O40gkQ04pAqcUrvlT/aqXSIaBhvgvium54VPDrzA8Da1dMS8GixHk5J2FKE+6f8JXpJ8//QGAzSVhgjbBUgAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="Case Description"
        title="Case Description"
        src="/static/6fda7bf47bf50b0d10b68dbf9ac46a73/d7ab4/ses-case-description.png"
        srcset="/static/6fda7bf47bf50b0d10b68dbf9ac46a73/72799/ses-case-description.png 320w,
/static/6fda7bf47bf50b0d10b68dbf9ac46a73/6af66/ses-case-description.png 640w,
/static/6fda7bf47bf50b0d10b68dbf9ac46a73/d7ab4/ses-case-description.png 1014w"
        sizes="(max-width: 1014px) 100vw, 1014px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
      />
  </a>
    </span></p><p>For the <strong>Use case description</strong> I normally keep it simple. We’re trying to get to production and start a beta (remember to replace <code class="language-text">example.com</code> with your domain):</p><div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">We&#39;re building out example.com and would like to move our account out of
the sandbox so we can proceed to a beta. Thanks!</code></pre></div><p>You shouldn’t need to change the contact options:</p><p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1011px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/e0828e24cfad2105b8c34b258679d559/6bfd0/ses-contact-options.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 29.375%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsSAAALEgHS3X78AAAAoklEQVQY052PyQ7CMAwF+/+fyAGJpRUUUuKmSxo7GcoBuBYsjSzZTyO7Euk5nc4cjkfa9saSFmKMf1MNw4BzHXfn6LoOVcUsYzmTf8TMqLz3NHWDiNCHsA6Vsi41JX6tUgqVk8C+vnCVEb8UJi08ovGY9RPawlc4RnbnloufqF1YxTO3KdMMX+GWyz7CcVH6lJE54WNCohKSMaq9IpSNr777E+gM1piYXstGAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="Contact Options"
        title="Contact Options"
        src="/static/e0828e24cfad2105b8c34b258679d559/6bfd0/ses-contact-options.png"
        srcset="/static/e0828e24cfad2105b8c34b258679d559/72799/ses-contact-options.png 320w,
/static/e0828e24cfad2105b8c34b258679d559/6af66/ses-contact-options.png 640w,
/static/e0828e24cfad2105b8c34b258679d559/6bfd0/ses-contact-options.png 1011w"
        sizes="(max-width: 1011px) 100vw, 1011px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
      />
  </a>
    </span></p><p>Once filled out you can click <strong>Submit</strong>. This process can take up to 72 hours (though, I’ve seen it take less than a day). Luckily, you can continue while the limit increase request is processed.</p></section>
<section><h2 id="storage" style="position:relative;"><a href="#storage" aria-label="storage permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Storage</h2><p>Storing files on Amazon Simple Storage Service (S3) is easy and reliable. We’ll use private S3 buckets for two things:</p><ul>
<li>Storing Terraform state</li>
<li>Transferring packaged lambda functions when deploying</li>
</ul><p>We’ve already setup a bucket for storing our Terraform state in <code class="language-text">storage.tf</code>.</p><p>Let’s add a new bucket for deploying. First, let’s add a variable for the name of our deploy bucket; like our state bucket, we’ll use our domain name (without the <code class="language-text">.com</code>) and the suffix <code class="language-text">-deploys</code>. Add the following to <code class="language-text">variables.tf</code>:</p><div class="gatsby-highlight" data-language="ruby"><pre class="language-ruby"><code class="language-ruby">variable <span class="token string">"deploys_bucket"</span> <span class="token punctuation">{</span>
  default <span class="token operator">=</span> <span class="token string">"example-deploys"</span>
<span class="token punctuation">}</span></code></pre></div><p>You’ll need to change this value for your site. Next, add the following to <code class="language-text">storage.tf</code>:</p><div class="gatsby-highlight" data-language="ruby"><pre class="language-ruby"><code class="language-ruby">resource <span class="token string">"aws_s3_bucket"</span> <span class="token string">"deploys"</span> <span class="token punctuation">{</span>
  bucket <span class="token operator">=</span> var<span class="token punctuation">.</span>deploys_bucket
  acl    <span class="token operator">=</span> <span class="token string">"private"</span>

  versioning <span class="token punctuation">{</span>
    enabled <span class="token operator">=</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>

  lifecycle <span class="token punctuation">{</span>
    prevent_destroy <span class="token operator">=</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div><p>The deploys bucket is declared exactly like the state bucket; it is completely private and shouldn’t be destroyed. Let’s check the Terraform plan:</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">terraform plan</code></pre></div><p>And apply it:</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">terraform apply</code></pre></div></section>
<section><h2 id="static-site" style="position:relative;"><a href="#static-site" aria-label="static site permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Static site</h2><p>When building our website we’ll use Gatsby to generate all of the static content and assets. Though there are many tools and frameworks for making a static website (including pure HTML and CSS), Gatsby offers numerous plugins, themes, and tools that will help us build something professional with relatively little effort. When deploying our website, we’ll generate a build and push all of the changes to an S3 bucket.</p><p>Before we setup Gatsby and the content for our website, let’s create the bucket. Create a new file in the <code class="language-text">terraform</code> folder called <code class="language-text">site.tf</code>:</p><div class="gatsby-highlight" data-language="ruby"><pre class="language-ruby"><code class="language-ruby">resource <span class="token string">"aws_s3_bucket"</span> <span class="token string">"site"</span> <span class="token punctuation">{</span>
  bucket <span class="token operator">=</span> var<span class="token punctuation">.</span>domain
  acl    <span class="token operator">=</span> <span class="token string">"public-read"</span>

  policy <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&lt;</span><span class="token constant">EOF</span>
<span class="token punctuation">{</span>
    <span class="token string">"Version"</span><span class="token punctuation">:</span> <span class="token string">"2012-10-17"</span><span class="token punctuation">,</span>
    <span class="token string">"Statement"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token string">"Sid"</span><span class="token punctuation">:</span> <span class="token string">"PublicReadGetObject"</span><span class="token punctuation">,</span>
            <span class="token string">"Effect"</span><span class="token punctuation">:</span> <span class="token string">"Allow"</span><span class="token punctuation">,</span>
            <span class="token string">"Principal"</span><span class="token punctuation">:</span> <span class="token string">"*"</span><span class="token punctuation">,</span>
            <span class="token string">"Action"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
                <span class="token string">"s3:GetObject"</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string">"Resource"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
                <span class="token string">"arn:aws:s3:::${var.domain}/*"</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
<span class="token constant">EOF</span>

  cors_rule <span class="token punctuation">{</span>
    allowed_headers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"*"</span><span class="token punctuation">]</span>
    allowed_methods <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"GET"</span><span class="token punctuation">]</span>
    allowed_origins <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"https://${var.domain}"</span><span class="token punctuation">]</span>
    expose_headers  <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"ETag"</span><span class="token punctuation">]</span>
    max_age_seconds <span class="token operator">=</span> <span class="token number">3000</span>
  <span class="token punctuation">}</span>

  website <span class="token punctuation">{</span>
    index_document <span class="token operator">=</span> <span class="token string">"index.html"</span>
    error_document <span class="token operator">=</span> <span class="token string">"error.html"</span>
  <span class="token punctuation">}</span>

  lifecycle <span class="token punctuation">{</span>
    prevent_destroy <span class="token operator">=</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div><p>When creating the bucket for our static website the bucket name will be the same as our domain name (including the <code class="language-text">.com</code> but without the <code class="language-text">https</code>), i.e., <code class="language-text">example.com</code>. We’ve used the <code class="language-text">domain</code> variable.</p><p>The bucket is readable to anyone on the Internet. Even though it has the same name as our domain and is accessible, we don’t expect people to actually read the content directly from our S3 bucket. It would be too slow. Because of this, we’ve configured a Cross-Origin-Resource-Sharing (<code class="language-text">CORS</code>) rule to limit access to our domain. Note: it is possible to manually construct requests that will bypass the <code class="language-text">CORS</code> rule (for example, using cURL); this rule only affects browsers. Additionally we’ve added a default <code class="language-text">index_document</code> and <code class="language-text">error_document</code>. This way if someone requests <code class="language-text">https://example.com/</code> it will automatically return the file at <code class="language-text">index.html</code> (which will work perfectly with a default Gatsby website). This is enough for us to setup our website.</p><p>Again, serving your website directly from S3 is not efficient. Instead, you’ll want to use a CDN (Content Delivery Network) to ensure that users see the fastest page loads possible. This will also act as a cache to reduce the number of reads performed directly against our S3 buckets. Fortunately, Amazon offers a CDN, called CloudFront for exactly this purpose. The first 2,000,000 requests per month are free.</p><p>Add the following to <code class="language-text">site.tf</code>:</p><div class="gatsby-highlight" data-language="ruby"><pre class="language-ruby"><code class="language-ruby">resource <span class="token string">"aws_cloudfront_distribution"</span> <span class="token string">"site_distribution"</span> <span class="token punctuation">{</span>
  origin <span class="token punctuation">{</span>
    domain_name <span class="token operator">=</span> aws_s3_bucket<span class="token punctuation">.</span>site<span class="token punctuation">.</span>website_endpoint
    origin_id   <span class="token operator">=</span> var<span class="token punctuation">.</span>domain
  <span class="token punctuation">}</span>

  enabled             <span class="token operator">=</span> <span class="token boolean">true</span>
  aliases             <span class="token operator">=</span> <span class="token punctuation">[</span>var<span class="token punctuation">.</span>domain<span class="token punctuation">]</span>
  price_class         <span class="token operator">=</span> <span class="token string">"PriceClass_100"</span>
  default_root_object <span class="token operator">=</span> <span class="token string">"index.html"</span>

  default_cache_behavior <span class="token punctuation">{</span>
    allowed_methods  <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"GET"</span><span class="token punctuation">,</span> <span class="token string">"HEAD"</span><span class="token punctuation">,</span> <span class="token string">"OPTIONS"</span><span class="token punctuation">]</span>
    cached_methods   <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"GET"</span><span class="token punctuation">,</span> <span class="token string">"HEAD"</span><span class="token punctuation">]</span>
    target_origin_id <span class="token operator">=</span> var<span class="token punctuation">.</span>domain

    forwarded_values <span class="token punctuation">{</span>
      query_string <span class="token operator">=</span> <span class="token boolean">true</span>

      cookies <span class="token punctuation">{</span>
        forward <span class="token operator">=</span> <span class="token string">"all"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    viewer_protocol_policy <span class="token operator">=</span> <span class="token string">"redirect-to-https"</span>
    min_ttl                <span class="token operator">=</span> <span class="token number">0</span>
    default_ttl            <span class="token operator">=</span> <span class="token number">300</span>
    max_ttl                <span class="token operator">=</span> <span class="token number">86400</span>
  <span class="token punctuation">}</span>

  restrictions <span class="token punctuation">{</span>
    geo_restriction <span class="token punctuation">{</span>
      restriction_type <span class="token operator">=</span> <span class="token string">"none"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  viewer_certificate <span class="token punctuation">{</span>
    acm_certificate_arn      <span class="token operator">=</span> aws_acm_certificate<span class="token punctuation">.</span>cert<span class="token punctuation">.</span>arn
    ssl_support_method       <span class="token operator">=</span> <span class="token string">"sni-only"</span>
    minimum_protocol_version <span class="token operator">=</span> <span class="token string">"TLSv1.1_2016"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div><p>This is probably the most complex declaration we’ll see. First we setup an <code class="language-text">origin</code>. When users come to our website (via our <code class="language-text">website_endpoint</code><label for="sd-you-can-choose-less" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sd-you-can-choose-less" class="margin-toggle" /><span class="sidenote">You can choose <code>bucket_domain_name</code> or <code>website_endpoint</code> for your origin. Although you'll have additional security options if you go to the bucket via <code>S3</code> you'll quickly run into problems seeing <code>NoSuchKey</code> errors on nested paths with <code>index.html</code> files. <a href="https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/distribution-web-values-specify.html#DownloadDistValuesOrigin">https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/distribution-web-values-specify.html#DownloadDistValuesOrigin</a> website_endpoint</span>) they’ll actually be going to CloudFront. CloudFront maintains a number of edge nodes (servers that are distributed throughout the world to reduce network latency). When CloudFront receives a request for a file it will first check for a local copy and, if none is found, will fetch the original from the <code class="language-text">origin</code> and cache it on the edge node. Because our content will be stored on S3, we’ve set the URL to our bucket as the <code class="language-text">origin</code>.</p><p>We set the <code class="language-text">price_class</code> to <code class="language-text">PriceClass_100</code>, the cheapest option (but also the smallest distribution). For more information, see <a href="https://aws.amazon.com/cloudfront/pricing/">https://aws.amazon.com/cloudfront/pricing/</a></p><p>We’ve set the <code class="language-text">viewer_protocol_policy</code> to <code class="language-text">redirect-to-https</code> which will force users to the secure version of our website. By default, Cloudfront doesn’t support SSL/TLS for custom domain names but we’ve already created a certificate that can be used to enable it.</p><p>We’ve also set defaults for the <code class="language-text">ttl</code> (Time-to-live).<label for="sd-the-values-for-less" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sd-the-values-for-less" class="margin-toggle" /><span class="sidenote">The values for <code>ttl</code> are defaults. It is possible to supply <code>Cache-Control max-age</code> or <code>Expires</code> headers when the origin responds for specific assets to override these defaults.</span> This controls how long (in seconds) that the edge nodes should cache the assets. If set to <code class="language-text">0</code> the edge nodes won’t cache anything and the CDN will be useless. If set too high, however, it will make it difficult to push changes to the website efficiently. We’ve set it to <code class="language-text">300</code> seconds, or five minutes.</p><p>With the CloudFront distribution configured, all that’s left is to create a DNS record pointing to it. Add the following to <code class="language-text">site.tf</code>:</p><div class="gatsby-highlight" data-language="ruby"><pre class="language-ruby"><code class="language-ruby">resource <span class="token string">"aws_route53_record"</span> <span class="token string">"site"</span> <span class="token punctuation">{</span>
  name    <span class="token operator">=</span> var<span class="token punctuation">.</span>domain
  type    <span class="token operator">=</span> <span class="token string">"A"</span>
  zone_id <span class="token operator">=</span> aws_route53_zone<span class="token punctuation">.</span>domain_zone<span class="token punctuation">.</span>zone_id

  <span class="token keyword">alias</span> <span class="token punctuation">{</span>
    name                   <span class="token operator">=</span> aws_cloudfront_distribution<span class="token punctuation">.</span>site_distribution<span class="token punctuation">.</span>domain_name
    zone_id                <span class="token operator">=</span> aws_cloudfront_distribution<span class="token punctuation">.</span>site_distribution<span class="token punctuation">.</span>hosted_zone_id
    evaluate_target_health <span class="token operator">=</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div><p>This is our primary <code class="language-text">A</code> record and points our domain directly at the CloudFront distribution. Because of the way distributions are deployed we’ve turned off <code class="language-text">evaluate_target_health</code>. With this in place, lets check the plan:</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">terraform plan</code></pre></div><p>And apply it:</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">terraform apply</code></pre></div><p>Unlike our previous configurations, changes to CloudFront distributions can be very slow. It should take approximately 30-40 minutes for the distribution to be created. This is important to remember in the future. If you make changes to a deployed distribution, those changes will also need to be deployed taking another 30-40 minutes.</p></section>
<section><h2 id="database" style="position:relative;"><a href="#database" aria-label="database permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Database</h2><p>There are numerous database options available from AWS. Amazon RDS and Aurora offer traditional relational database interfaces (including MySQL and Postgres). DynamoDB is a much more scalable document database (but with none of the relational features). There are also options that fit specific use cases (like ElastiCache and Redshift) which we don’t need right now.</p><p>The most cost-effective solution is DynamoDB.</p><blockquote>
<p>According to <a href="https://www.cloudberrylab.com/resources/blog/aws-free-tier-databases/">Cloudberry Lab</a>, “AWS provides a generous free tier for DynamoDB. You can store 25 GB per month within the free tier. Further, you can use 25 read capacity units and 25 write capacity units per month with the free tier. Fully-utilized, that would allow you to make 200 million requests to DynamoDB in a month. Even better, the DynamoDB free tier never expires — you can keep using it even after the first 12 months of your AWS account.”</p>
</blockquote><p>This should be more than enough to get started. We’ll start off by creating a table to record purchases on our website. Later, we’ll tie this together with Stripe and a lambda function.</p><p>Create a new file in the <code class="language-text">terraform</code> folder called <code class="language-text">database.tf</code>:</p><div class="gatsby-highlight" data-language="ruby"><pre class="language-ruby"><code class="language-ruby">resource <span class="token string">"aws_dynamodb_table"</span> <span class="token string">"database"</span> <span class="token punctuation">{</span>
  name           <span class="token operator">=</span> <span class="token string">"Database"</span>
  billing_mode   <span class="token operator">=</span> <span class="token string">"PROVISIONED"</span>
  read_capacity  <span class="token operator">=</span> <span class="token number">20</span>
  write_capacity <span class="token operator">=</span> <span class="token number">20</span>
  hash_key       <span class="token operator">=</span> <span class="token string">"pk"</span>
  range_key      <span class="token operator">=</span> <span class="token string">"sk"</span>

  attribute <span class="token punctuation">{</span>
    name <span class="token operator">=</span> <span class="token string">"pk"</span>
    type <span class="token operator">=</span> <span class="token string">"S"</span>
  <span class="token punctuation">}</span>

  attribute <span class="token punctuation">{</span>
    name <span class="token operator">=</span> <span class="token string">"sk"</span>
    type <span class="token operator">=</span> <span class="token string">"S"</span>
  <span class="token punctuation">}</span>

  attribute <span class="token punctuation">{</span>
    name <span class="token operator">=</span> <span class="token string">"data"</span>
    type <span class="token operator">=</span> <span class="token string">"S"</span>
  <span class="token punctuation">}</span>

  global_secondary_index <span class="token punctuation">{</span>
    name            <span class="token operator">=</span> <span class="token string">"gsi"</span>
    hash_key        <span class="token operator">=</span> <span class="token string">"sk"</span>
    range_key       <span class="token operator">=</span> <span class="token string">"data"</span>
    write_capacity  <span class="token operator">=</span> <span class="token number">5</span>
    read_capacity   <span class="token operator">=</span> <span class="token number">5</span>
    projection_type <span class="token operator">=</span> <span class="token string">"ALL"</span>
  <span class="token punctuation">}</span>

  tags <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token constant">Name</span>        <span class="token operator">=</span> <span class="token string">"Database"</span>
    <span class="token constant">Environment</span> <span class="token operator">=</span> <span class="token string">"production"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div><p>DynamoDB is a document database and is very different from normal relational databases. In this case we’ve created a single table with a provisioned set of read and write units. Using <a href="https://aws.amazon.com/dynamodb/pricing/provisioned/">provisioned capacity</a> units means we are attempting to predict our usage. Setting the <code class="language-text">read_capacity</code> to <code class="language-text">20</code> indicates that we expect a maximum of <code class="language-text">40</code> (eventually consistent) reads per second. Setting <code class="language-text">write_capacity</code> to <code class="language-text">20</code> means we expect at most <code class="language-text">20</code> writes per second. If we exceed the provisioned capacity our requests could be throttled. To avoid this you can instead use <a href="https://aws.amazon.com/dynamodb/pricing/on-demand/">on-demand capacity</a>. For more information, see <a href="https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/HowItWorks.ReadWriteCapacityMode.html">how it works</a>.</p><p>We’ve added a Global Secondary Index (<code class="language-text">GSI</code>) and set the read and write capacity to <code class="language-text">5</code> (the minimum).</p><p>Our table is very generic (we’ve even named it generically: <code class="language-text">Database</code>). We’ve declared three fields which we use for our <code class="language-text">hash_key</code> and <code class="language-text">range_key</code> and for the <code class="language-text">range_key</code> of our <code class="language-text">GSI</code>. This pattern allows you overload a single table with all of your data. This pattern is explained well at <a href="https://www.trek10.com/blog/dynamodb-single-table-relational-modeling/">https://www.trek10.com/blog/dynamodb-single-table-relational-modeling/</a> and <a href="https://www.youtube.com/watch?v=HaEPXoXVf2k">https://www.youtube.com/watch?v=HaEPXoXVf2k</a>. Because we are following a very specific pattern I have named the fields after their purpose in the pattern: <code class="language-text">pk</code> for “Primary Key”, <code class="language-text">sk</code> for “Secondary Key” and <code class="language-text">data</code> for the generic (non-indexed) contents of each document. There are many other ways to arrange your tables in DynamoDB which may reflect your website’s data more clearly, but this pattern scales very well and remains relatively inexpensive long term.</p><p>We won’t go into detail about how these work right now; but this should be enough for us to record and quickly query almost any kind of information.</p><p>Let’s check the plan:</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">terraform plan</code></pre></div><p>And apply it:</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">terraform apply</code></pre></div><p>Some helpful links:</p><ul>
<li><a href="https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/WorkingWithDynamo.html">https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/WorkingWithDynamo.html</a></li>
<li><a href="https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/Query.html">https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/Query.html</a></li>
<li><a href="https://hackernoon.com/the-upside-down-world-of-dynamodb-8170411492c0">https://hackernoon.com/the-upside-down-world-of-dynamodb-8170411492c0</a></li>
<li><a href="https://www.dynamodbguide.com/leaderboard-write-sharding">https://www.dynamodbguide.com/leaderboard-write-sharding</a></li>
<li><a href="https://www.trek10.com/blog/dynamodb-single-table-relational-modeling/">https://www.trek10.com/blog/dynamodb-single-table-relational-modeling/</a></li>
<li><a href="https://www.youtube.com/watch?v=HaEPXoXVf2k">https://www.youtube.com/watch?v=HaEPXoXVf2k</a></li>
</ul></section>
<section><h2 id="users-and-identities" style="position:relative;"><a href="#users-and-identities" aria-label="users and identities permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Users and Identities</h2><p>User identity is an important part of any website. Not only does it allow you to authenticate (<code class="language-text">AuthN</code>) and authorize (<code class="language-text">AuthZ</code>) a user, it allows users to maintain custom settings and profiles. In our case we’ll use it to record purchases made by specific users. There are many tools to manage user identity - either as part of your own application - or by using a service. For example, we could build our own authentication and authorization in JavaScript using <a href="https://www.npmjs.com/package/passport">passport</a>. We could also rely on an external service like <a href="https://auth0.com/">Auth0</a>. Because we’re using AWS, Amazon’s <a href="https://aws.amazon.com/cognito/">Cognito</a> service gives us the best of both worlds.</p><p>For our website, we want:</p><ul>
<li>User signup and login via email address and password</li>
<li>Email address verification</li>
<li>Two-factor authentication via email and SMS</li>
<li>Rate limiting and lockout</li>
<li>Password resets</li>
<li>Authenticated API requests</li>
</ul><p>Cognito will give us all of this. Cognito is made up of two primary pieces: <em>Identity Pools</em> and <em>User Pools</em>. You can find a very good explanation of the difference on Serverless Stack: <a href="https://serverless-stack.com/chapters/cognito-user-pool-vs-identity-pool.html">https://serverless-stack.com/chapters/cognito-user-pool-vs-identity-pool.html</a>. We’ll be using both. We’ll create users with email addresses and passwords in the User Pool and control their access with a shared identity in an Identity Pool. We want to use a shared identity for our permissions and access because we may have different user sources in the future (including our own email and password, Facebook, GitHub, SAML, etc.).</p><h3 id="user-pool-configuration" style="position:relative;"><a href="#user-pool-configuration" aria-label="user pool configuration permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>User pool configuration</h3><p>Let’s start by creating our User Pool, which we will call (very generically) “Users”. In the <code class="language-text">terraform</code> folder create <code class="language-text">users.tf</code> and add:</p><div class="gatsby-highlight" data-language="ruby"><pre class="language-ruby"><code class="language-ruby">resource <span class="token string">"aws_cognito_user_pool"</span> <span class="token string">"users"</span> <span class="token punctuation">{</span>
  name <span class="token operator">=</span> <span class="token string">"Users"</span>

  password_policy <span class="token punctuation">{</span>
    minimum_length                   <span class="token operator">=</span> <span class="token number">8</span>
    require_lowercase                <span class="token operator">=</span> <span class="token boolean">false</span>
    require_numbers                  <span class="token operator">=</span> <span class="token boolean">true</span>
    require_symbols                  <span class="token operator">=</span> <span class="token boolean">false</span>
    require_uppercase                <span class="token operator">=</span> <span class="token boolean">true</span>
    temporary_password_validity_days <span class="token operator">=</span> <span class="token number">7</span>
  <span class="token punctuation">}</span>

  schema <span class="token punctuation">{</span>
    name                     <span class="token operator">=</span> <span class="token string">"email"</span>
    attribute_data_type      <span class="token operator">=</span> <span class="token string">"String"</span>
    required                 <span class="token operator">=</span> <span class="token boolean">true</span>
    developer_only_attribute <span class="token operator">=</span> <span class="token boolean">false</span>
    mutable                  <span class="token operator">=</span> <span class="token boolean">false</span>

    <span class="token comment"># Note: attribute constraints are required or the user pool will be recreated</span>
    string_attribute_constraints <span class="token punctuation">{</span>
      min_length <span class="token operator">=</span> <span class="token number">1</span>
      max_length <span class="token operator">=</span> <span class="token number">1024</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  username_attributes      <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"email"</span><span class="token punctuation">]</span>
  auto_verified_attributes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"email"</span><span class="token punctuation">]</span>

  email_verification_subject <span class="token operator">=</span> <span class="token string">"Device Verification Code"</span>
  email_verification_message <span class="token operator">=</span> <span class="token string">"Please use the following code {####}"</span>

  verification_message_template <span class="token punctuation">{</span>
    default_email_option <span class="token operator">=</span> <span class="token string">"CONFIRM_WITH_CODE"</span>
  <span class="token punctuation">}</span>

  <span class="token comment"># Note: you have to wait for the email to be verified and check your sending limits</span>
  email_configuration <span class="token punctuation">{</span>
    source_arn             <span class="token operator">=</span> aws_ses_email_identity<span class="token punctuation">.</span>no_reply<span class="token punctuation">.</span>arn
    reply_to_email_address <span class="token operator">=</span> aws_ses_email_identity<span class="token punctuation">.</span>no_reply<span class="token punctuation">.</span>email
    email_sending_account  <span class="token operator">=</span> <span class="token string">"DEVELOPER"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div><p>There are a lot of choices when creating a User Pool (see <a href="https://www.terraform.io/docs/providers/aws/r/cognito_user_pool.html">https://www.terraform.io/docs/providers/aws/r/cognito_user_pool.html</a>). Here we have focused on the basics to get started. We’ve created a pool called <code class="language-text">Users</code> and set a very basic password policy. You might want to include more restrictions. We’ve only defined one attribute for our users: <code class="language-text">email</code> and we’ve made it required. There are a number of standard attributes available including name, birthdate, and more:</p><p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 530px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/27aac4cf84aacb7bf19ec79dfc95dd93/b6a9b/cognito-user-pool-attributes.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 46.25%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsSAAALEgHS3X78AAABPElEQVQoz3WR2XLCMAxF+f+Pa8lCCEnYAlnJxh4YZtQeUTMp0z44ji3pSPd6lOa5WI4j09lMDqeTuJ6n57pt5dL3crpcdPHfHQ4at11XkiwTZzLRM3Umd8QnnM8lSTO9+LQs+RiPtfh8vb6ABrpNU4kWC2n3ewWTm5elHM/nJ7C/37UbE3HhB4EW0NUAzX693aRuWkEVcVSt4lgXDYiP+MTbrezqWguDKJKsKKTpul8wAyyrSjZJIvvjUYH8A6OeXYFcVnWjxXgyC0OV9i6ZXAqJARzbtqpZbzayWK2k2O2eQBKqplEfPN9XT5nyLw+rbyAWIXkynSrs/ngI1r0kMyGdKUIGDf7z0EimOWpYPIrJUSBdSGQCgPi4XK/Vk3cPjWQzIVKHOQpEHq9MAE/wwiQMk18T/5yBMulQyRdKuaWgbrNMywAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="Standard user pool attributes"
        title="Standard user pool attributes"
        src="/static/27aac4cf84aacb7bf19ec79dfc95dd93/b6a9b/cognito-user-pool-attributes.png"
        srcset="/static/27aac4cf84aacb7bf19ec79dfc95dd93/72799/cognito-user-pool-attributes.png 320w,
/static/27aac4cf84aacb7bf19ec79dfc95dd93/b6a9b/cognito-user-pool-attributes.png 530w"
        sizes="(max-width: 530px) 100vw, 530px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
      />
  </a>
    </span></p><p>In this case we’ve marked the email address as <code class="language-text">required</code> and set a minimum and maximum length. If you don’t set the constraints, Terraform will re-create the User Pool every time you apply the configuration which would be bad.</p><p>We want the email address to be verified (this dramatically reduces the amount of fake users). To do this, we’ll have Cognito send a confirmation email with a code. We’ll send it from the <code class="language-text">no-reply</code> address we created earlier<label for="sd-there-are-several" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sd-there-are-several" class="margin-toggle" /><span class="sidenote">There are several ways to verify an account. We've chosen to use email and SES because it supports the highest sending rate at the lowest cost (we get 10,000 free emails per month). You could let Cognito itself send the emails but the maximum sending rate is very low and there is little customization. You could also choose to send SMS verifications through SNS. SNS allows you to send 100 free text messages per month to U.S. numbers, after that the cost is charged per send.</span>.</p><p>With the pool configuration created, we’ll also want to register a client for interacting with the pool from our website. Add the following to <code class="language-text">users.tf</code>:</p><div class="gatsby-highlight" data-language="ruby"><pre class="language-ruby"><code class="language-ruby">resource <span class="token string">"aws_cognito_user_pool_client"</span> <span class="token string">"users_client"</span> <span class="token punctuation">{</span>
  name <span class="token operator">=</span> <span class="token string">"users"</span>

  user_pool_id <span class="token operator">=</span> aws_cognito_user_pool<span class="token punctuation">.</span>users<span class="token punctuation">.</span>id

  generate_secret <span class="token operator">=</span> <span class="token boolean">false</span>

  explicit_auth_flows <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">"USER_PASSWORD_AUTH"</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span></code></pre></div><p>We won’t need a secret for the website. If you were creating a server-to-server or mobile application you would want to create another client and generate a secret.</p><p>By default, our website will need to communicate with the default Cognito domain <code class="language-text">https://cognito-idp.us-east-1.amazonaws.com/</code>.<label for="sd-creating-a-custom" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sd-creating-a-custom" class="margin-toggle" /><span class="sidenote">Creating a custom user pool domain requires changes to a cloudfront distribution which takes time to propagate. If you want to skip this to speed things along it will not be visible to users (unless they use a developer console on your website).</span> We can create a custom domain for our User Pool. Add the following to <code class="language-text">users.tf</code>:</p><div class="gatsby-highlight" data-language="ruby"><pre class="language-ruby"><code class="language-ruby">resource <span class="token string">"aws_cognito_user_pool_domain"</span> <span class="token string">"users_domain"</span> <span class="token punctuation">{</span>
  domain          <span class="token operator">=</span> <span class="token string">"auth.${var.domain}"</span>
  certificate_arn <span class="token operator">=</span> aws_acm_certificate<span class="token punctuation">.</span>cert<span class="token punctuation">.</span>arn
  user_pool_id    <span class="token operator">=</span> aws_cognito_user_pool<span class="token punctuation">.</span>users<span class="token punctuation">.</span>id
<span class="token punctuation">}</span>

resource <span class="token string">"aws_route53_record"</span> <span class="token string">"auth"</span> <span class="token punctuation">{</span>
  name    <span class="token operator">=</span> aws_cognito_user_pool_domain<span class="token punctuation">.</span>users_domain<span class="token punctuation">.</span>domain
  type    <span class="token operator">=</span> <span class="token string">"A"</span>
  zone_id <span class="token operator">=</span> aws_route53_zone<span class="token punctuation">.</span>domain_zone<span class="token punctuation">.</span>zone_id

  <span class="token keyword">alias</span> <span class="token punctuation">{</span>
    evaluate_target_health <span class="token operator">=</span> <span class="token boolean">false</span>
    name                   <span class="token operator">=</span> aws_cognito_user_pool_domain<span class="token punctuation">.</span>users_domain<span class="token punctuation">.</span>cloudfront_distribution_arn
    zone_id                <span class="token operator">=</span> <span class="token string">"Z2FDTNDATAQYW2"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div><blockquote>
<p>Note: custom auth domains is used for the built-in hosted auth pages; because of existing <code class="language-text">CORS</code> policies, I haven’t been able to use a custom domain to back my website authentication.</p>
</blockquote><p>Here we’ve created a domain and secured it using the certificate we generated earlier. We’ve also generated an alias in Route53 for the zone <code class="language-text">Z2FDTNDATAQYW2</code>. This is the zone id of Cloudfront itself and it is standard to use it in this way. One caveat: the certificate attached to the domain must be created in the <code class="language-text">us-east-1</code> region. If you’ve created the certificate in another region, it won’t be usable.</p><p>Let’s check the plan:</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">terraform plan</code></pre></div><p>And apply it:</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">terraform apply</code></pre></div><p>The first time you apply the plan it will need to configure the distribution for the custom domain. This takes 30-40 minutes to propagate.</p><h3 id="identity-pool-configuration" style="position:relative;"><a href="#identity-pool-configuration" aria-label="identity pool configuration permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Identity pool configuration</h3><p>With the User Pool created, we can move on to the Identity Pool. In the <code class="language-text">terraform</code> folder, create a new file called <code class="language-text">identities.tf</code>:</p><div class="gatsby-highlight" data-language="ruby"><pre class="language-ruby"><code class="language-ruby">resource <span class="token string">"aws_cognito_identity_pool"</span> <span class="token string">"identities"</span> <span class="token punctuation">{</span>
  identity_pool_name               <span class="token operator">=</span> <span class="token string">"Identities"</span>
  allow_unauthenticated_identities <span class="token operator">=</span> <span class="token boolean">false</span>

  cognito_identity_providers <span class="token punctuation">{</span>
    client_id               <span class="token operator">=</span> aws_cognito_user_pool_client<span class="token punctuation">.</span>users_client<span class="token punctuation">.</span>id
    server_side_token_check <span class="token operator">=</span> <span class="token boolean">true</span>
    provider_name <span class="token operator">=</span> <span class="token string">"cognito-idp.${var.region}.amazonaws.com/${aws_cognito_user_pool.users.id}"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div><p>We’ve created an Identity Pool with a single provider: the User Pool we just created. Note that the provider name includes the region and the User Pool <code class="language-text">id</code>. If you’ve created your User Pool in a different region, you’ll need to modify the provider name to point to it. This is all we need to create the Identity Provider but we haven’t set any access restrictions or permissions yet. To do that, we’ll need to create <code class="language-text">IAM</code> roles for authenticated and unauthenticated users and attach policies to those roles. Add the following to <code class="language-text">identities.tf</code>:</p><div class="gatsby-highlight" data-language="ruby"><pre class="language-ruby"><code class="language-ruby">resource <span class="token string">"aws_iam_role"</span> <span class="token string">"cognito_authenticated"</span> <span class="token punctuation">{</span>
  name <span class="token operator">=</span> <span class="token string">"cognito_authenticated"</span>

  <span class="token comment"># This represents the Trust Relationships for the role</span>
  assume_role_policy <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&lt;</span><span class="token constant">EOF</span>
<span class="token punctuation">{</span>
  <span class="token string">"Version"</span><span class="token punctuation">:</span> <span class="token string">"2012-10-17"</span><span class="token punctuation">,</span>
  <span class="token string">"Statement"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token string">"Effect"</span><span class="token punctuation">:</span> <span class="token string">"Allow"</span><span class="token punctuation">,</span>
      <span class="token string">"Principal"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">"Federated"</span><span class="token punctuation">:</span> <span class="token string">"cognito-identity.amazonaws.com"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">"Action"</span><span class="token punctuation">:</span> <span class="token string">"sts:AssumeRoleWithWebIdentity"</span><span class="token punctuation">,</span>
      <span class="token string">"Condition"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">"StringEquals"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
          <span class="token string">"cognito-identity.amazonaws.com:aud"</span><span class="token punctuation">:</span> <span class="token string">"${aws_cognito_identity_pool.identities.id}"</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">"ForAnyValue:StringLike"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
          <span class="token string">"cognito-identity.amazonaws.com:amr"</span><span class="token punctuation">:</span> <span class="token string">"authenticated"</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
<span class="token constant">EOF</span>
<span class="token punctuation">}</span>

resource <span class="token string">"aws_iam_role_policy"</span> <span class="token string">"cognito_authenticated_role_policy"</span> <span class="token punctuation">{</span>
  name <span class="token operator">=</span> <span class="token string">"cognito_authenticated_role_policy"</span>
  role <span class="token operator">=</span> aws_iam_role<span class="token punctuation">.</span>cognito_authenticated<span class="token punctuation">.</span>id

  policy <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&lt;</span><span class="token constant">EOF</span>
<span class="token punctuation">{</span>
    <span class="token string">"Version"</span><span class="token punctuation">:</span> <span class="token string">"2012-10-17"</span><span class="token punctuation">,</span>
    <span class="token string">"Statement"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token string">"Effect"</span><span class="token punctuation">:</span> <span class="token string">"Allow"</span><span class="token punctuation">,</span>
            <span class="token string">"Action"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
                <span class="token string">"mobileanalytics:PutEvents"</span><span class="token punctuation">,</span>
                <span class="token string">"cognito-sync:*"</span><span class="token punctuation">,</span>
                <span class="token string">"cognito-identity:*"</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string">"Resource"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
                <span class="token string">"*"</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
<span class="token constant">EOF</span>
<span class="token punctuation">}</span>

resource <span class="token string">"aws_iam_role"</span> <span class="token string">"cognito_unauthenticated"</span> <span class="token punctuation">{</span>
  name <span class="token operator">=</span> <span class="token string">"cognito_unauthenticated"</span>

  <span class="token comment"># This represents the Trust Relationships for the role</span>
  assume_role_policy <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&lt;</span><span class="token constant">EOF</span>
<span class="token punctuation">{</span>
  <span class="token string">"Version"</span><span class="token punctuation">:</span> <span class="token string">"2012-10-17"</span><span class="token punctuation">,</span>
  <span class="token string">"Statement"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token string">"Effect"</span><span class="token punctuation">:</span> <span class="token string">"Allow"</span><span class="token punctuation">,</span>
      <span class="token string">"Principal"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">"Federated"</span><span class="token punctuation">:</span> <span class="token string">"cognito-identity.amazonaws.com"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">"Action"</span><span class="token punctuation">:</span> <span class="token string">"sts:AssumeRoleWithWebIdentity"</span><span class="token punctuation">,</span>
      <span class="token string">"Condition"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">"StringEquals"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
          <span class="token string">"cognito-identity.amazonaws.com:aud"</span><span class="token punctuation">:</span> <span class="token string">"${aws_cognito_identity_pool.identities.id}"</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">"ForAnyValue:StringLike"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
          <span class="token string">"cognito-identity.amazonaws.com:amr"</span><span class="token punctuation">:</span> <span class="token string">"unauthenticated"</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
<span class="token constant">EOF</span>
<span class="token punctuation">}</span>

resource <span class="token string">"aws_iam_role_policy"</span> <span class="token string">"cognito_unauthenticated_role_policy"</span> <span class="token punctuation">{</span>
  name <span class="token operator">=</span> <span class="token string">"cognito_unauthenticated_role_policy"</span>
  role <span class="token operator">=</span> aws_iam_role<span class="token punctuation">.</span>cognito_unauthenticated<span class="token punctuation">.</span>id

  policy <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&lt;</span><span class="token constant">EOF</span>
<span class="token punctuation">{</span>
    <span class="token string">"Version"</span><span class="token punctuation">:</span> <span class="token string">"2012-10-17"</span><span class="token punctuation">,</span>
    <span class="token string">"Statement"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token string">"Effect"</span><span class="token punctuation">:</span> <span class="token string">"Allow"</span><span class="token punctuation">,</span>
            <span class="token string">"Action"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
                <span class="token string">"mobileanalytics:PutEvents"</span><span class="token punctuation">,</span>
                <span class="token string">"cognito-sync:*"</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string">"Resource"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
                <span class="token string">"*"</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
<span class="token constant">EOF</span>
<span class="token punctuation">}</span>

resource <span class="token string">"aws_cognito_identity_pool_roles_attachment"</span> <span class="token string">"identities_roles"</span> <span class="token punctuation">{</span>
  identity_pool_id <span class="token operator">=</span> aws_cognito_identity_pool<span class="token punctuation">.</span>identities<span class="token punctuation">.</span>id

  roles <span class="token operator">=</span> <span class="token punctuation">{</span>
    authenticated   <span class="token operator">=</span> aws_iam_role<span class="token punctuation">.</span>cognito_authenticated<span class="token punctuation">.</span>arn
    unauthenticated <span class="token operator">=</span> aws_iam_role<span class="token punctuation">.</span>cognito_unauthenticated<span class="token punctuation">.</span>arn
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div><p>These roles and associated policies will be the basis for user authorization in all of our services. At the moment they don’t grant any specific permissions but we’ll update them as we create more resources. For now, we can apply them as-is.</p><p>Let’s check the plan:</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">terraform plan</code></pre></div><p>And apply it:</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">terraform apply</code></pre></div></section>
<section><h2 id="api" style="position:relative;"><a href="#api" aria-label="api permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>API</h2><p>We’ll be supporting payments, reading and writing from our DynamoDB database and performing authenticated actions. By default, this is very difficult to do from a static website. Because of this we’ll need to create an API for our website: this will be a set of actions that are only executed on the server. Amazon Web Services allow you to create many different kinds of server side APIs including: Elastic Cloud (<code class="language-text">EC2</code>) and Elastic Container Service (<code class="language-text">ECS</code>), Kubernetes (using AWS Elastic Kubernetes Service, <code class="language-text">EKS</code> and Fargate), AWS Lambda and more.</p><p>AWS Lambda allows you to create serverless functions - which are massively scalable. Lambda supports a number of different server-side programming languages, but we’ll be using JavaScript (and, eventually TypeScript) to keep things consistent. Unfortunately, you can’t call an AWS Lambda function directly from a website; instead you must route the request through AWS API Gateway. Lambda functions have a custom invocation context and output that must be mapped to HTTP to be used by websites.</p><p>We’ll need to:</p><ul>
<li>Create a basic serverless function</li>
<li>Use Terraform to upload and configure the function</li>
<li>Create an API Gateway that proxies to the function</li>
<li>Configure error responses for API Gateway</li>
<li>Creating a deployment and custom domain</li>
<li>Configure permissions for Lambda, API Gateway, and DynamoDB</li>
</ul><h3 id="create-a-basic-serverless-function" style="position:relative;"><a href="#create-a-basic-serverless-function" aria-label="create a basic serverless function permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Create a basic serverless function</h3><p>AWS Lambda serverless applications, at their essence, are simple functions that receive <code class="language-text">event</code>, <code class="language-text">context</code> and <code class="language-text">callback</code> parameters. No matter how complex the application is, it must flow through a function like this. For now, we’ll create a very simple handler function: it will log the event and the context and return them. We won’t use the <code class="language-text">callback</code> function at all. In the <code class="language-text">terraform</code> folder create a new file called <code class="language-text">api.js</code>:</p><div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js">exports<span class="token punctuation">.</span><span class="token function-variable function">handler</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">,</span> context</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Event: '</span> <span class="token operator">+</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Context: '</span> <span class="token operator">+</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">)</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    statusCode<span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
    body<span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      event<span class="token operator">:</span> event<span class="token punctuation">,</span>
      context<span class="token operator">:</span> context<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div><p>To upload this function we’ll need to zip it:</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">zip</span> -r api.zip api.js</code></pre></div><blockquote>
<p>Note: while this is a very basic function which only echoes back the context and event; it can be very dangerous. You wouldn’t want a function like this to exist for a production website as it could leak critical server-side information. Eventually, we’ll replace this with a much more in-depth function built using Express.</p>
</blockquote><h3 id="use-terraform-to-upload-and-configure-the-function" style="position:relative;"><a href="#use-terraform-to-upload-and-configure-the-function" aria-label="use terraform to upload and configure the function permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Use Terraform to upload and configure the function</h3><p>Now that we’ve created the function (and compressed it) we can begin writing the Terraform configuration. In the <code class="language-text">terraform</code> folder create <code class="language-text">api.tf</code>:</p><div class="gatsby-highlight" data-language="ruby"><pre class="language-ruby"><code class="language-ruby">resource <span class="token string">"aws_lambda_function"</span> <span class="token string">"site_lambda_function"</span> <span class="token punctuation">{</span>
  function_name <span class="token operator">=</span> <span class="token string">"site_lambda_function"</span>

  filename         <span class="token operator">=</span> <span class="token string">"api.zip"</span>
  source_code_hash <span class="token operator">=</span> filebase64sha256<span class="token punctuation">(</span><span class="token string">"api.zip"</span><span class="token punctuation">)</span>

  <span class="token comment"># "api" is the filename within the zip file (api.js) and "handler"</span>
  <span class="token comment"># is the name of the property under which the handler function was</span>
  <span class="token comment"># exported in that file.</span>
  handler <span class="token operator">=</span> <span class="token string">"api.handler"</span>

  runtime     <span class="token operator">=</span> <span class="token string">"nodejs10.x"</span>
  timeout     <span class="token operator">=</span> <span class="token number">60</span>
  memory_size <span class="token operator">=</span> <span class="token number">512</span>

  environment <span class="token punctuation">{</span>
    variables <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token constant">VERSION</span> <span class="token operator">=</span> <span class="token string">"v1"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  role <span class="token operator">=</span> aws_iam_role<span class="token punctuation">.</span>site_lambda_function_role<span class="token punctuation">.</span>arn
<span class="token punctuation">}</span>

resource <span class="token string">"aws_iam_role"</span> <span class="token string">"site_lambda_function_role"</span> <span class="token punctuation">{</span>
  name <span class="token operator">=</span> <span class="token string">"site_lambda_function_role"</span>

  assume_role_policy <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&lt;</span><span class="token constant">EOF</span>
<span class="token punctuation">{</span>
  <span class="token string">"Version"</span><span class="token punctuation">:</span> <span class="token string">"2012-10-17"</span><span class="token punctuation">,</span>
  <span class="token string">"Statement"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token string">"Action"</span><span class="token punctuation">:</span> <span class="token string">"sts:AssumeRole"</span><span class="token punctuation">,</span>
      <span class="token string">"Principal"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">"Service"</span><span class="token punctuation">:</span> <span class="token string">"lambda.amazonaws.com"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">"Effect"</span><span class="token punctuation">:</span> <span class="token string">"Allow"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
<span class="token constant">EOF</span>
<span class="token punctuation">}</span></code></pre></div><p>We’ve declared a single Lambda function and attached an <code class="language-text">IAM</code> role to it. We’ll add permissions to this role soon. When we apply the Terraform configuration it will upload the <code class="language-text">api.zip</code> we created previously. When we invoke the function, it will use the Node version 10 runtime and will timeout after 60 seconds (though it should really only take a few milliseconds to run). We’ve included a custom environment variable called <code class="language-text">VERSION</code> as an example (it isn’t required).</p><p>Let’s check the plan:</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">terraform plan</code></pre></div><p>And apply it:</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">terraform apply</code></pre></div><p>With this in place we can invoke the function from our terminal (make sure to replace <code class="language-text">example</code> with your profile name):</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">aws lambda invoke <span class="token punctuation">\</span>
    --profile example <span class="token punctuation">\</span>
    --function-name<span class="token operator">=</span>site_lambda_function <span class="token punctuation">\</span>
    --invocation-type<span class="token operator">=</span>RequestResponse <span class="token punctuation">\</span>
    response.json</code></pre></div><p>Running this should create a new <code class="language-text">response.json</code> file which will have show the logged context. There won’t be an <code class="language-text">event</code> object until we connect it to the API Gateway. Delete <code class="language-text">response.json</code>:</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">rm</span> response.json</code></pre></div><h3 id="create-an-api-gateway-that-proxies-to-the-function" style="position:relative;"><a href="#create-an-api-gateway-that-proxies-to-the-function" aria-label="create an api gateway that proxies to the function permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Create an API Gateway that proxies to the function</h3><p>With the function created and uploaded we need to configure the API Gateway. Add the following to <code class="language-text">api.tf</code>:</p><div class="gatsby-highlight" data-language="ruby"><pre class="language-ruby"><code class="language-ruby">resource <span class="token string">"aws_api_gateway_rest_api"</span> <span class="token string">"site_api"</span> <span class="token punctuation">{</span>
  name <span class="token operator">=</span> <span class="token string">"site_api"</span>
<span class="token punctuation">}</span>

resource <span class="token string">"aws_api_gateway_resource"</span> <span class="token string">"site_api_resource"</span> <span class="token punctuation">{</span>
  rest_api_id <span class="token operator">=</span> aws_api_gateway_rest_api<span class="token punctuation">.</span>site_api<span class="token punctuation">.</span>id
  parent_id   <span class="token operator">=</span> aws_api_gateway_rest_api<span class="token punctuation">.</span>site_api<span class="token punctuation">.</span>root_resource_id

  <span class="token comment"># Proxy all invocations, regardless of the path</span>
  path_part   <span class="token operator">=</span> <span class="token string">"{proxy+}"</span>
<span class="token punctuation">}</span>

resource <span class="token string">"aws_api_gateway_method"</span> <span class="token string">"site_api_method"</span> <span class="token punctuation">{</span>
  rest_api_id   <span class="token operator">=</span> aws_api_gateway_rest_api<span class="token punctuation">.</span>site_api<span class="token punctuation">.</span>id
  resource_id   <span class="token operator">=</span> aws_api_gateway_resource<span class="token punctuation">.</span>site_api_resource<span class="token punctuation">.</span>id

  <span class="token comment"># Proxy all HTTP methods including POST, GET, DELETE, etc.</span>
  http_method   <span class="token operator">=</span> <span class="token string">"ANY"</span>

  <span class="token comment"># Authorize invocations through IAM, if you want your API to</span>
  <span class="token comment"># work for anonymous users (not signed in), then set this value</span>
  <span class="token comment"># to NONE (the default)</span>
  authorization <span class="token operator">=</span> <span class="token string">"AWS_IAM"</span>
<span class="token punctuation">}</span>

resource <span class="token string">"aws_api_gateway_integration"</span> <span class="token string">"site_api_integration"</span> <span class="token punctuation">{</span>
  rest_api_id <span class="token operator">=</span> aws_api_gateway_rest_api<span class="token punctuation">.</span>site_api<span class="token punctuation">.</span>id
  resource_id <span class="token operator">=</span> aws_api_gateway_resource<span class="token punctuation">.</span>site_api_resource<span class="token punctuation">.</span>id

  http_method             <span class="token operator">=</span> <span class="token string">"ANY"</span>

  <span class="token comment"># Integration between API Gateway and Lambda always uses POST, this is not related to http_method</span>
  integration_http_method <span class="token operator">=</span> <span class="token string">"POST"</span>
  type                    <span class="token operator">=</span> <span class="token string">"AWS_PROXY"</span>
  uri                     <span class="token operator">=</span> aws_lambda_function<span class="token punctuation">.</span>site_lambda_function<span class="token punctuation">.</span>invoke_arn

  depends_on <span class="token operator">=</span> <span class="token punctuation">[</span>aws_api_gateway_method<span class="token punctuation">.</span>site_api_method<span class="token punctuation">]</span>
<span class="token punctuation">}</span></code></pre></div><p>This creates an API Gateway called <code class="language-text">site_api</code>. We’ve configured it as a proxy to the Lambda function we created. The <code class="language-text">path_part</code> is <code class="language-text">{proxy+}</code> which means that we’ll pass all invocations to the function regardless of the path part of the URL. Notice that the <code class="language-text">http_method</code> we’ve configured is <code class="language-text">ANY</code>. Because of this, when a user issues any HTTP request to the gateway (such as <code class="language-text">POST</code>, <code class="language-text">GET</code>, <code class="language-text">DELETE</code>, etc.) we’ll pass it on to the function. We’ve also included a <code class="language-text">depends_on</code> value to explicitly call out our resource dependencies.<label for="sd-terraform-does-an" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sd-terraform-does-an" class="margin-toggle" /><span class="sidenote">Terraform does an extremely good job of figuring out the interdependencies between resource declarations - but it isn't perfect (there are many situations where dependencies are not deterministic). Without the <code>depends_on</code> hint it might try to generate resources out of order and get an error. Usually if you get these kinds of errors you can just re-run the <code>apply</code> command.</span></p><p>This type of proxy setup is the most flexible but the least efficient. If you want to handle only specific HTTP methods for specific paths, applying that configuration in the API Gateway will result in faster response times and fewer Lambda invocations (especially in the case of errors). Additionally, it is possible to have different Lambda functions for different routes. Here, we’re proxying all routes to a single function. In large applications this can become problematic as the function you need to upload grows.</p><p>For our use cases the efficiency gains are very small so we’ve opted for more flexibility.</p><p>Notice that we have set the <code class="language-text">authorization</code> to <code class="language-text">AWS_IAM</code>. This assumes that the API will only work for signed in users (users that were created through AWS Cognito, which we will setup below). API Gateway will reject anonymous requests (potentially saving you money) and will pass the authenticated requests to Lambda with the user’s information. For your site, you may want to allow anonymous API requests (if you are fetching a list of featured items or a default home page feed for example). In that case change the value to <code class="language-text">NONE</code>.</p><p>We’ve configured how API Gateway handles and proxies requests (inputs) to Lambda but we also need to handle outputs from Lambda and send responses. Add the following to <code class="language-text">api.tf</code>:</p><div class="gatsby-highlight" data-language="ruby"><pre class="language-ruby"><code class="language-ruby">resource <span class="token string">"aws_api_gateway_method_response"</span> <span class="token string">"site_api_method_response"</span> <span class="token punctuation">{</span>
  rest_api_id <span class="token operator">=</span> aws_api_gateway_rest_api<span class="token punctuation">.</span>site_api<span class="token punctuation">.</span>id
  resource_id <span class="token operator">=</span> aws_api_gateway_resource<span class="token punctuation">.</span>site_api_resource<span class="token punctuation">.</span>id
  http_method <span class="token operator">=</span> <span class="token string">"ANY"</span>
  status_code <span class="token operator">=</span> <span class="token string">"200"</span>

  <span class="token comment"># Note: your API responses must include 'Access-Control-Allow-Origin' as a header</span>
  response_parameters <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">"method.response.header.Access-Control-Allow-Origin"</span> <span class="token operator">=</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>

  depends_on <span class="token operator">=</span> <span class="token punctuation">[</span>aws_api_gateway_method<span class="token punctuation">.</span>site_api_method<span class="token punctuation">]</span>
<span class="token punctuation">}</span></code></pre></div><p>Here we are allowing the header <code class="language-text">Access-Control-Allow-Origin</code> to be sent in the response. This header is important for Cross-Origin-Resource-Sharing (<code class="language-text">CORS</code>). Without it our website couldn’t send requests and view responses from our API.</p><p>Unfortunately, <code class="language-text">CORS</code> support is a little more complex. When determining if a server allows Cross-Origin-Resource-Sharing for a given domain, the browser will send an <code class="language-text">OPTIONS</code> query to the server before sending the actual request (<code class="language-text">POST</code>, <code class="language-text">GET</code>, etc.). We could pass these <code class="language-text">OPTIONS</code> requests through to Lambda but we would need to write handler functions for them and it would essentially double the number of invocations. Instead we’ll create a <code class="language-text">MOCK</code> integration in API Gateway itself. To create the integration we’ll need to configure requests handlers and responses. Add the following to <code class="language-text">api.tf</code>:</p><div class="gatsby-highlight" data-language="ruby"><pre class="language-ruby"><code class="language-ruby"><span class="token comment"># The options integration and method is to support OPTIONS queries.</span>
<span class="token comment"># The queries allow you to respond to CORS requests to determine expected</span>
<span class="token comment"># and allowed headers directly in API Gateway</span>
resource <span class="token string">"aws_api_gateway_method"</span> <span class="token string">"site_api_options_method"</span> <span class="token punctuation">{</span>
  rest_api_id <span class="token operator">=</span> aws_api_gateway_rest_api<span class="token punctuation">.</span>site_api<span class="token punctuation">.</span>id
  resource_id <span class="token operator">=</span> aws_api_gateway_resource<span class="token punctuation">.</span>site_api_resource<span class="token punctuation">.</span>id

  http_method   <span class="token operator">=</span> <span class="token string">"OPTIONS"</span>
  authorization <span class="token operator">=</span> <span class="token string">"NONE"</span>
<span class="token punctuation">}</span>

resource <span class="token string">"aws_api_gateway_integration"</span> <span class="token string">"site_api_options_integration"</span> <span class="token punctuation">{</span>
  rest_api_id <span class="token operator">=</span> aws_api_gateway_rest_api<span class="token punctuation">.</span>site_api<span class="token punctuation">.</span>id
  resource_id <span class="token operator">=</span> aws_api_gateway_resource<span class="token punctuation">.</span>site_api_resource<span class="token punctuation">.</span>id

  http_method          <span class="token operator">=</span> <span class="token string">"OPTIONS"</span>
  type                 <span class="token operator">=</span> <span class="token string">"MOCK"</span>
  passthrough_behavior <span class="token operator">=</span> <span class="token string">"WHEN_NO_MATCH"</span>

  request_templates <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">"application/json"</span> <span class="token operator">=</span> <span class="token string">"{statusCode:200}"</span>
  <span class="token punctuation">}</span>

  depends_on <span class="token operator">=</span> <span class="token punctuation">[</span>aws_api_gateway_method<span class="token punctuation">.</span>site_api_options_method<span class="token punctuation">]</span>
<span class="token punctuation">}</span>

resource <span class="token string">"aws_api_gateway_method_response"</span> <span class="token string">"site_api_options_method_response"</span> <span class="token punctuation">{</span>
  rest_api_id <span class="token operator">=</span> aws_api_gateway_rest_api<span class="token punctuation">.</span>site_api<span class="token punctuation">.</span>id
  resource_id <span class="token operator">=</span> aws_api_gateway_resource<span class="token punctuation">.</span>site_api_resource<span class="token punctuation">.</span>id

  http_method <span class="token operator">=</span> <span class="token string">"OPTIONS"</span>
  status_code <span class="token operator">=</span> <span class="token string">"200"</span>

  response_parameters <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">"method.response.header.Access-Control-Allow-Headers"</span> <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token string">"method.response.header.Access-Control-Allow-Methods"</span> <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token string">"method.response.header.Access-Control-Allow-Origin"</span>  <span class="token operator">=</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

resource <span class="token string">"aws_api_gateway_integration_response"</span> <span class="token string">"site_api_options_integration_response"</span> <span class="token punctuation">{</span>
  rest_api_id <span class="token operator">=</span> aws_api_gateway_rest_api<span class="token punctuation">.</span>site_api<span class="token punctuation">.</span>id
  resource_id <span class="token operator">=</span> aws_api_gateway_resource<span class="token punctuation">.</span>site_api_resource<span class="token punctuation">.</span>id

  http_method <span class="token operator">=</span> <span class="token string">"OPTIONS"</span>
  status_code <span class="token operator">=</span> <span class="token string">"200"</span>

  <span class="token comment"># Note: You could specify an exact origin for Access-Control-Allow-Origin</span>
  response_parameters <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">"method.response.header.Access-Control-Allow-Headers"</span> <span class="token operator">=</span> <span class="token string">"'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token,X-Amz-User-Agent'"</span>
    <span class="token string">"method.response.header.Access-Control-Allow-Methods"</span> <span class="token operator">=</span> <span class="token string">"'GET,POST,PUT,DELETE,HEAD,OPTIONS'"</span>
    <span class="token string">"method.response.header.Access-Control-Allow-Origin"</span>  <span class="token operator">=</span> <span class="token string">"'*'"</span>
  <span class="token punctuation">}</span>

  response_templates <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">"application/json"</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&lt;</span><span class="token constant">EOF</span>
<span class="token comment">#set($origin = $input.params("Origin"))</span>
<span class="token comment">#if($origin == "") #set($origin = $input.params("origin")) #end</span>
<span class="token comment">#if($origin.matches(".*")) #set($context.responseOverride.header.Access-Control-Allow-Origin = $origin) #end</span>
<span class="token constant">EOF</span>
  <span class="token punctuation">}</span>

  depends_on <span class="token operator">=</span> <span class="token punctuation">[</span>aws_api_gateway_method<span class="token punctuation">.</span>site_api_options_method<span class="token punctuation">]</span>
<span class="token punctuation">}</span></code></pre></div><p>Though the setup is confusing, the result is much faster<label for="sd-we-ve-already" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sd-we-ve-already" class="margin-toggle" /><span class="sidenote">We've already configured API Gateway to handle requests <em>at the edge</em>. Our Gateway configuration will be distributed to servers located around the world. When users send requests they will be sent to the nearest server (because of GeoDNS). If we can handle the request and response entirely on that server we'll save a roundtrip to the servers in our default region. A roundtrip between Singapore and Washington is approximately 31000 kilometers. At the theoretical maximum (the speed of light) this would take 100ms. In reality (with network switches, latency, and packet loss) it actually takes around 270ms on average. A quarter-second delay is small but noticeable and with multiple requests can add up quickly. Handling <code>OPTIONS</code> requests entirely in API Gateway eliminates the roundtrip altogether.</span> and much cheaper. We won’t go into much detail as this is mostly (very confusing) boilerplate. Importantly, this configuration accepts requests from any domain (<code class="language-text">*</code>) - it is not limited to only our domain. In many production cases you wouldn’t want random websites to make requests to your API. To make this more secure, you could replace <code class="language-text">*</code> with your domain (or list of domains) instead.</p><h3 id="configure-error-responses-for-api-gateway" style="position:relative;"><a href="#configure-error-responses-for-api-gateway" aria-label="configure error responses for api gateway permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Configure error responses for API Gateway</h3><p>We configured our API to handle requests and responses from our Lambda. But what happens if our function returns an error? In certain error cases the response comes directly from API Gateway itself. These errors can be very hard to debug when making a cross-origin request. To make things easier to understand we’ll configure the default errors for API Gateway itself. Add the following to <code class="language-text">api.tf</code>:</p><div class="gatsby-highlight" data-language="ruby"><pre class="language-ruby"><code class="language-ruby"><span class="token comment"># Errors are hard to interpret because of CORS, this provides default responses</span>
<span class="token comment"># https://docs.aws.amazon.com/apigateway/latest/developerguide/supported-gateway-response-types.html</span>
resource <span class="token string">"aws_api_gateway_gateway_response"</span> <span class="token string">"default_4xx"</span> <span class="token punctuation">{</span>
  rest_api_id   <span class="token operator">=</span> aws_api_gateway_rest_api<span class="token punctuation">.</span>site_api<span class="token punctuation">.</span>id
  response_type <span class="token operator">=</span> <span class="token string">"DEFAULT_4XX"</span>

  response_templates <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">"application/json"</span> <span class="token operator">=</span> <span class="token string">"{'message':$context.error.messageString}"</span>
  <span class="token punctuation">}</span>

  response_parameters <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">"gatewayresponse.header.Access-Control-Allow-Headers"</span> <span class="token operator">=</span> <span class="token string">"'*'"</span>
    <span class="token string">"gatewayresponse.header.Access-Control-Allow-Origin"</span>  <span class="token operator">=</span> <span class="token string">"'*'"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

resource <span class="token string">"aws_api_gateway_gateway_response"</span> <span class="token string">"default_5xx"</span> <span class="token punctuation">{</span>
  rest_api_id   <span class="token operator">=</span> aws_api_gateway_rest_api<span class="token punctuation">.</span>site_api<span class="token punctuation">.</span>id
  response_type <span class="token operator">=</span> <span class="token string">"DEFAULT_5XX"</span>

  response_templates <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">"application/json"</span> <span class="token operator">=</span> <span class="token string">"{'message':$context.error.messageString}"</span>
  <span class="token punctuation">}</span>

  response_parameters <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">"gatewayresponse.header.Access-Control-Allow-Headers"</span> <span class="token operator">=</span> <span class="token string">"'*'"</span>
    <span class="token string">"gatewayresponse.header.Access-Control-Allow-Origin"</span>  <span class="token operator">=</span> <span class="token string">"'*'"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div><h3 id="creating-a-deployment-and-custom-domain" style="position:relative;"><a href="#creating-a-deployment-and-custom-domain" aria-label="creating a deployment and custom domain permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Creating a deployment and custom domain</h3><p>Our API is configured, we’ve created multiple integrations, but we need to do a little more configuration to make it accessible - we need to create a deployment <em>stage</em> so that our API is available on the Internet. Add the following to <code class="language-text">api.tf</code>:</p><div class="gatsby-highlight" data-language="ruby"><pre class="language-ruby"><code class="language-ruby">resource <span class="token string">"aws_api_gateway_deployment"</span> <span class="token string">"site_api_deployment"</span> <span class="token punctuation">{</span>
  rest_api_id <span class="token operator">=</span> aws_api_gateway_rest_api<span class="token punctuation">.</span>site_api<span class="token punctuation">.</span>id
  stage_name  <span class="token operator">=</span> <span class="token string">"production"</span>

  depends_on <span class="token operator">=</span> <span class="token punctuation">[</span>
    aws_api_gateway_rest_api<span class="token punctuation">.</span>site_api<span class="token punctuation">,</span>
    aws_api_gateway_integration<span class="token punctuation">.</span>site_api_integration<span class="token punctuation">,</span>
    aws_api_gateway_resource<span class="token punctuation">.</span>site_api_resource<span class="token punctuation">,</span>
    aws_api_gateway_method<span class="token punctuation">.</span>site_api_method<span class="token punctuation">,</span>
    aws_api_gateway_method_response<span class="token punctuation">.</span>site_api_method_response<span class="token punctuation">,</span>
    aws_api_gateway_method<span class="token punctuation">.</span>site_api_options_method<span class="token punctuation">,</span>
    aws_api_gateway_integration<span class="token punctuation">.</span>site_api_options_integration<span class="token punctuation">,</span>
    aws_api_gateway_method_response<span class="token punctuation">.</span>site_api_options_method_response<span class="token punctuation">,</span>
    aws_api_gateway_integration_response<span class="token punctuation">.</span>site_api_options_integration_response<span class="token punctuation">,</span>
    aws_api_gateway_gateway_response<span class="token punctuation">.</span>default_4xx<span class="token punctuation">,</span>
    aws_api_gateway_gateway_response<span class="token punctuation">.</span>default_5xx
  <span class="token punctuation">]</span>

  <span class="token comment"># Eventually we'll want to add a trigger for redeployment</span>

  lifecycle <span class="token punctuation">{</span>
    create_before_destroy <span class="token operator">=</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div><p>We’ve set <code class="language-text">production</code> as our stage name. In theory, you could have multiple stages (possibly pointing to different Lambda functions) for <code class="language-text">staging</code>, <code class="language-text">development</code>, etc. Alternatively, you could use stages to deploy multiple versions of your API simultaneously (again, each pointing to a different Lambda function). We’ve left a note about adding a redeployment trigger later (which we’ll do below).</p><p>By default, Amazon generates a unique domain for our API. Even though it isn’t directly visible to users (unless they are using the developer console), it’s ugly. Luckily, we can specify a custom domain name that points to a particular deployment stage. Add the following to <code class="language-text">api.tf</code>:</p><div class="gatsby-highlight" data-language="ruby"><pre class="language-ruby"><code class="language-ruby">resource <span class="token string">"aws_api_gateway_domain_name"</span> <span class="token string">"site_api_domain_name"</span> <span class="token punctuation">{</span>
  certificate_arn <span class="token operator">=</span> aws_acm_certificate_validation<span class="token punctuation">.</span>cert_validation<span class="token punctuation">.</span>certificate_arn
  domain_name     <span class="token operator">=</span> <span class="token string">"api.${var.domain}"</span>
<span class="token punctuation">}</span>

resource <span class="token string">"aws_api_gateway_base_path_mapping"</span> <span class="token string">"site_api_domain_mapping"</span> <span class="token punctuation">{</span>
  api_id      <span class="token operator">=</span> aws_api_gateway_rest_api<span class="token punctuation">.</span>site_api<span class="token punctuation">.</span>id
  stage_name  <span class="token operator">=</span> aws_api_gateway_deployment<span class="token punctuation">.</span>site_api_deployment<span class="token punctuation">.</span>stage_name
  domain_name <span class="token operator">=</span> aws_api_gateway_domain_name<span class="token punctuation">.</span>site_api_domain_name<span class="token punctuation">.</span>domain_name
<span class="token punctuation">}</span>

resource <span class="token string">"aws_route53_record"</span> <span class="token string">"api"</span> <span class="token punctuation">{</span>
  name    <span class="token operator">=</span> aws_api_gateway_domain_name<span class="token punctuation">.</span>site_api_domain_name<span class="token punctuation">.</span>domain_name
  type    <span class="token operator">=</span> <span class="token string">"A"</span>
  zone_id <span class="token operator">=</span> aws_route53_zone<span class="token punctuation">.</span>domain_zone<span class="token punctuation">.</span>id

  <span class="token keyword">alias</span> <span class="token punctuation">{</span>
    name                   <span class="token operator">=</span> aws_api_gateway_domain_name<span class="token punctuation">.</span>site_api_domain_name<span class="token punctuation">.</span>cloudfront_domain_name
    zone_id                <span class="token operator">=</span> aws_api_gateway_domain_name<span class="token punctuation">.</span>site_api_domain_name<span class="token punctuation">.</span>cloudfront_zone_id
    evaluate_target_health <span class="token operator">=</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div><p>We could choose any domain name but we’ve specified a subdomain: <code class="language-text">api</code>. This let’s us use our generated certificate to secure it. Just as we saw earlier, the API and certificate must be created in the same region (in our case, <code class="language-text">us-east-1</code>). We’ve mapped the domain to our deployment stage and added a Route53 declaration. Again, our API is deployed through Cloudfront (Amazon’s CDN) so that it can respond to requests <em>at the edge</em>. Because of this, we’ve setup our DNS record as an alias to the Cloudfront domain name and zone.</p><h3 id="configure-permissions-for-lambda-api-gateway-and-dynamodb" style="position:relative;"><a href="#configure-permissions-for-lambda-api-gateway-and-dynamodb" aria-label="configure permissions for lambda api gateway and dynamodb permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Configure permissions for Lambda, API Gateway, and DynamoDB</h3><p>By default our newly created API doesn’t have permissions to invoke our Lambda function (even though we’ve connected them). Add the following to <code class="language-text">api.tf</code>:</p><div class="gatsby-highlight" data-language="ruby"><pre class="language-ruby"><code class="language-ruby">resource <span class="token string">"aws_lambda_permission"</span> <span class="token string">"api_gateway_lambda_permission"</span> <span class="token punctuation">{</span>
  statement_id  <span class="token operator">=</span> <span class="token string">"AllowAPIGatewayInvoke"</span>
  principal     <span class="token operator">=</span> <span class="token string">"apigateway.amazonaws.com"</span>
  action        <span class="token operator">=</span> <span class="token string">"lambda:InvokeFunction"</span>
  function_name <span class="token operator">=</span> aws_lambda_function<span class="token punctuation">.</span>site_lambda_function<span class="token punctuation">.</span>arn

  <span class="token comment"># Grant access from any method on any resource within the API Gateway (`/*/*`)</span>
  source_arn <span class="token operator">=</span> <span class="token string">"${aws_api_gateway_deployment.site_api_deployment.execution_arn}/*/*"</span>
<span class="token punctuation">}</span></code></pre></div><p>Similarly, our Lambda function cannot interact with our DynamoDB table. Add the following to <code class="language-text">api.tf</code>:</p><div class="gatsby-highlight" data-language="ruby"><pre class="language-ruby"><code class="language-ruby">resource <span class="token string">"aws_iam_policy"</span> <span class="token string">"lambda_dynamodb_policy"</span> <span class="token punctuation">{</span>
  name <span class="token operator">=</span> <span class="token string">"lambda_dynamodb_policy"</span>
  path <span class="token operator">=</span> <span class="token string">"/"</span>

  policy <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&lt;</span><span class="token constant">EOF</span>
<span class="token punctuation">{</span>
  <span class="token string">"Version"</span><span class="token punctuation">:</span> <span class="token string">"2012-10-17"</span><span class="token punctuation">,</span>
  <span class="token string">"Statement"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token string">"Action"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token string">"dynamodb:DescribeTable"</span><span class="token punctuation">,</span>
        <span class="token string">"dynamodb:Query"</span><span class="token punctuation">,</span>
        <span class="token string">"dynamodb:Scan"</span><span class="token punctuation">,</span>
        <span class="token string">"dynamodb:GetItem"</span><span class="token punctuation">,</span>
        <span class="token string">"dynamodb:PutItem"</span><span class="token punctuation">,</span>
        <span class="token string">"dynamodb:UpdateItem"</span><span class="token punctuation">,</span>
        <span class="token string">"dynamodb:DeleteItem"</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token string">"Resource"</span><span class="token punctuation">:</span> <span class="token string">"arn:aws:dynamodb:${var.region}:*:*"</span><span class="token punctuation">,</span>
      <span class="token string">"Effect"</span><span class="token punctuation">:</span> <span class="token string">"Allow"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
<span class="token constant">EOF</span>
<span class="token punctuation">}</span>

resource <span class="token string">"aws_iam_role_policy_attachment"</span> <span class="token string">"site_lambda_function_dynamodb_policy_attachment"</span> <span class="token punctuation">{</span>
  role       <span class="token operator">=</span> aws_iam_role<span class="token punctuation">.</span>site_lambda_function_role<span class="token punctuation">.</span>name
  policy_arn <span class="token operator">=</span> aws_iam_policy<span class="token punctuation">.</span>lambda_dynamodb_policy<span class="token punctuation">.</span>arn
<span class="token punctuation">}</span></code></pre></div><p>First we create a generic DynamoDB policy to allow access; then we attach that policy to the Lambda role we created earlier. Notice that our policy’s <code class="language-text">Resource</code> is locked to DynamoDB resources created in our default region (<code class="language-text">${var.region}</code>). If you’ve created your database in another region you’ll need to change the policy accordingly. Alternatively, you could change <code class="language-text">${var.region}</code> to <code class="language-text">*</code> to allow access to DynamoDB tables created in any region.</p><p>We’ll also want to be able to send emails from our Lambda, add the following to <code class="language-text">api.tf</code>:</p><div class="gatsby-highlight" data-language="ruby"><pre class="language-ruby"><code class="language-ruby">resource <span class="token string">"aws_iam_policy"</span> <span class="token string">"lambda_ses_policy"</span> <span class="token punctuation">{</span>
  name <span class="token operator">=</span> <span class="token string">"lambda_ses_policy"</span>
  path <span class="token operator">=</span> <span class="token string">"/"</span>

  policy <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&lt;</span><span class="token constant">EOF</span>
<span class="token punctuation">{</span>
  <span class="token string">"Version"</span><span class="token punctuation">:</span> <span class="token string">"2012-10-17"</span><span class="token punctuation">,</span>
  <span class="token string">"Statement"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token string">"Action"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token string">"ses:SendEmail"</span><span class="token punctuation">,</span>
        <span class="token string">"ses:SendRawEmail"</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token string">"Resource"</span><span class="token punctuation">:</span> <span class="token string">"*"</span><span class="token punctuation">,</span>
      <span class="token string">"Effect"</span><span class="token punctuation">:</span> <span class="token string">"Allow"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
<span class="token constant">EOF</span>
<span class="token punctuation">}</span>

resource <span class="token string">"aws_iam_role_policy_attachment"</span> <span class="token string">"site_lambda_function_ses_policy_attachment"</span> <span class="token punctuation">{</span>
  role       <span class="token operator">=</span> aws_iam_role<span class="token punctuation">.</span>site_lambda_function_role<span class="token punctuation">.</span>name
  policy_arn <span class="token operator">=</span> aws_iam_policy<span class="token punctuation">.</span>lambda_ses_policy<span class="token punctuation">.</span>arn
<span class="token punctuation">}</span></code></pre></div><p>For more information see <a href="https://aws.amazon.com/premiumsupport/knowledge-center/lambda-send-email-ses/">https://aws.amazon.com/premiumsupport/knowledge-center/lambda-send-email-ses/</a>.</p><p>We’re finally ready to push our configuration. Let’s check the plan:</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">terraform plan</code></pre></div><p>And apply it:</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">terraform apply</code></pre></div><p>With this our API and Lambda configuration should be fully usable.</p><p>Before we move on, let’s add one more thing: redeployment. Within <code class="language-text">api.tf</code> find the <code class="language-text">site_api_deployment</code> definition and add a redeployment trigger:</p><div class="gatsby-highlight" data-language="ruby"><pre class="language-ruby"><code class="language-ruby">resource <span class="token string">"aws_api_gateway_deployment"</span> <span class="token string">"site_api_deployment"</span> <span class="token punctuation">{</span>
  rest_api_id <span class="token operator">=</span> aws_api_gateway_rest_api<span class="token punctuation">.</span>site_api<span class="token punctuation">.</span>id
  stage_name  <span class="token operator">=</span> <span class="token string">"production"</span>

  depends_on <span class="token operator">=</span> <span class="token punctuation">[</span>
    aws_api_gateway_rest_api<span class="token punctuation">.</span>site_api<span class="token punctuation">,</span>
    aws_api_gateway_integration<span class="token punctuation">.</span>site_api_integration<span class="token punctuation">,</span>
    aws_api_gateway_resource<span class="token punctuation">.</span>site_api_resource<span class="token punctuation">,</span>
    aws_api_gateway_method<span class="token punctuation">.</span>site_api_method<span class="token punctuation">,</span>
    aws_api_gateway_method_response<span class="token punctuation">.</span>site_api_method_response<span class="token punctuation">,</span>
    aws_api_gateway_method<span class="token punctuation">.</span>site_api_options_method<span class="token punctuation">,</span>
    aws_api_gateway_integration<span class="token punctuation">.</span>site_api_options_integration<span class="token punctuation">,</span>
    aws_api_gateway_method_response<span class="token punctuation">.</span>site_api_options_method_response<span class="token punctuation">,</span>
    aws_api_gateway_integration_response<span class="token punctuation">.</span>site_api_options_integration_response<span class="token punctuation">,</span>
    aws_api_gateway_gateway_response<span class="token punctuation">.</span>default_4xx<span class="token punctuation">,</span>
    aws_api_gateway_gateway_response<span class="token punctuation">.</span>default_5xx
  <span class="token punctuation">]</span>

  triggers <span class="token operator">=</span> <span class="token punctuation">{</span>
    redeployment <span class="token operator">=</span> sha1<span class="token punctuation">(</span>join<span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">,</span> list<span class="token punctuation">(</span>
      jsonencode<span class="token punctuation">(</span>aws_api_gateway_rest_api<span class="token punctuation">.</span>site_api<span class="token punctuation">)</span><span class="token punctuation">,</span>
      jsonencode<span class="token punctuation">(</span>aws_api_gateway_integration<span class="token punctuation">.</span>site_api_integration<span class="token punctuation">)</span><span class="token punctuation">,</span>
      jsonencode<span class="token punctuation">(</span>aws_api_gateway_resource<span class="token punctuation">.</span>site_api_resource<span class="token punctuation">)</span><span class="token punctuation">,</span>
      jsonencode<span class="token punctuation">(</span>aws_api_gateway_method<span class="token punctuation">.</span>site_api_method<span class="token punctuation">)</span><span class="token punctuation">,</span>
      jsonencode<span class="token punctuation">(</span>aws_api_gateway_method_response<span class="token punctuation">.</span>site_api_method_response<span class="token punctuation">)</span><span class="token punctuation">,</span>
      jsonencode<span class="token punctuation">(</span>aws_api_gateway_method<span class="token punctuation">.</span>site_api_options_method<span class="token punctuation">)</span><span class="token punctuation">,</span>
      jsonencode<span class="token punctuation">(</span>aws_api_gateway_integration<span class="token punctuation">.</span>site_api_options_integration<span class="token punctuation">)</span><span class="token punctuation">,</span>
      jsonencode<span class="token punctuation">(</span>aws_api_gateway_method_response<span class="token punctuation">.</span>site_api_options_method_response<span class="token punctuation">)</span><span class="token punctuation">,</span>
      jsonencode<span class="token punctuation">(</span>aws_api_gateway_integration_response<span class="token punctuation">.</span>site_api_options_integration_response<span class="token punctuation">)</span><span class="token punctuation">,</span>
      jsonencode<span class="token punctuation">(</span>aws_api_gateway_gateway_response<span class="token punctuation">.</span>default_4xx<span class="token punctuation">)</span><span class="token punctuation">,</span>
      jsonencode<span class="token punctuation">(</span>aws_api_gateway_gateway_response<span class="token punctuation">.</span>default_5xx<span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  lifecycle <span class="token punctuation">{</span>
    create_before_destroy <span class="token operator">=</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div><p>We need to configure a redeployment trigger to make sure our API is redeployed when there is a change to any part of the setup. This is required even though Terraform is managing the changes because any updates will not be pushed to our production stage until they are <em>deployed</em>. Adding this trigger before the first deployment causes an error; so it must be added after you have run <code class="language-text">terraform apply</code> for the initial deployment.</p><p>Some helpful links:</p><ul>
<li><a href="https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-create-api-as-simple-proxy-for-lambda.html">https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-create-api-as-simple-proxy-for-lambda.html</a></li>
<li><a href="https://seanmcgary.com/posts/how-to-deploy-an-aws-lambda-with-terraform/">https://seanmcgary.com/posts/how-to-deploy-an-aws-lambda-with-terraform/</a></li>
</ul></section>
<section><h2 id="authenticated-api-access-with-cognito" style="position:relative;"><a href="#authenticated-api-access-with-cognito" aria-label="authenticated api access with cognito permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Authenticated API access with Cognito</h2><p>We’ve setup user authentication and identities, an API, serverless functions, and more. It would be great if we could leverage our Cognito authentication within our API. We’ve already setup our proxy to pass Amazon specific authorization parameters through the API Gateway to our Lambda function. We can do more, though. If we modify our authenticated user policy, API Gateway will automatically preload our Cognito user identity and pass it to our function in the <code class="language-text">context</code> parameter.</p><p>Having API Gateway preload our authenticated user may seem like a small thing; but this is the centerpiece of our entire authentication and authorization strategy. In fact, it is the singular motivation for writing this post, as it is poorly documented and extremely easy to misconfigure.</p><p>We’ll need modify the <code class="language-text">cognito_authenticated_role_policy</code> we created in <code class="language-text">identities.tf</code>. Luckily, because we are using Terraform, we can make the change and when we run <code class="language-text">terraform apply</code> it will detect the differences and only apply the necessary updates. This is the magic of Terraform and tools like it. Open <code class="language-text">identities.tf</code> and change the <code class="language-text">cognito_authenticated_role_policy</code> declaration:</p><div class="gatsby-highlight" data-language="ruby"><pre class="language-ruby"><code class="language-ruby">resource <span class="token string">"aws_iam_role_policy"</span> <span class="token string">"cognito_authenticated_role_policy"</span> <span class="token punctuation">{</span>
  name <span class="token operator">=</span> <span class="token string">"cognito_authenticated_role_policy"</span>
  role <span class="token operator">=</span> aws_iam_role<span class="token punctuation">.</span>cognito_authenticated<span class="token punctuation">.</span>id

  policy <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&lt;</span><span class="token constant">EOF</span>
<span class="token punctuation">{</span>
    <span class="token string">"Version"</span><span class="token punctuation">:</span> <span class="token string">"2012-10-17"</span><span class="token punctuation">,</span>
    <span class="token string">"Statement"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token string">"Effect"</span><span class="token punctuation">:</span> <span class="token string">"Allow"</span><span class="token punctuation">,</span>
            <span class="token string">"Action"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
                <span class="token string">"mobileanalytics:PutEvents"</span><span class="token punctuation">,</span>
                <span class="token string">"cognito-sync:*"</span><span class="token punctuation">,</span>
                <span class="token string">"cognito-identity:*"</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string">"Resource"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
                <span class="token string">"*"</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            <span class="token string">"Effect"</span><span class="token punctuation">:</span> <span class="token string">"Allow"</span><span class="token punctuation">,</span>
            <span class="token string">"Action"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
                <span class="token string">"execute-api:Invoke"</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string">"Resource"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
                <span class="token string">"arn:aws:execute-api:*:*:${aws_api_gateway_rest_api.site_api.id}/*/*/*"</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
<span class="token constant">EOF</span>
<span class="token punctuation">}</span></code></pre></div><p>Make sure you save the changes and then check the plan:</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">terraform plan</code></pre></div><p>The output should indicate one pending action and show the updated policy:</p><div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">An execution plan has been generated and is shown below.
Resource actions are indicated with the following symbols:
  ~ update in-place

Terraform will perform the following actions:

  # aws_iam_role_policy.cognito_authenticated_role_policy will be updated in-place
  ~ resource &quot;aws_iam_role_policy&quot; &quot;cognito_authenticated_role_policy&quot; {
        id     = &quot;cognito_authenticated:cognito_authenticated_role_policy&quot;
        name   = &quot;cognito_authenticated_role_policy&quot;
      ~ policy = jsonencode(
          ~ {
              ~ Statement = [
                    {
                        Action   = [
                            &quot;mobileanalytics:PutEvents&quot;,
                            &quot;cognito-sync:*&quot;,
                            &quot;cognito-identity:*&quot;,
                        ]
                        Effect   = &quot;Allow&quot;
                        Resource = [
                            &quot;*&quot;,
                        ]
                    },
                  + {
                      + Action   = [
                          + &quot;execute-api:Invoke&quot;,
                        ]
                      + Effect   = &quot;Allow&quot;
                      + Resource = [
                          + &quot;arn:aws:execute-api:*:*:REDACTED/*/*/*&quot;,
                        ]
                    },
                ]
                Version   = &quot;2012-10-17&quot;
            }
        )
        role   = &quot;cognito_authenticated&quot;
    }

Plan: 0 to add, 1 to change, 0 to destroy.</code></pre></div><p>This is exactly what we want. Let’s apply the configuration:</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">terraform apply</code></pre></div></section>
<section><h2 id="logging" style="position:relative;"><a href="#logging" aria-label="logging permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Logging</h2><blockquote>
<p>This section is optional</p>
</blockquote><p>When you’re developing your website or trying to debug user problems, logging can be essential. The logs we created earlier (calls to <code class="language-text">console.log</code>) in our Lambda function are entirely ephemeral. We could watch the logs; view them in the console, or store them for later retrieval.<label for="sd-storing-logs-isn-t" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sd-storing-logs-isn-t" class="margin-toggle" /><span class="sidenote">Storing logs isn't only about cost. In many cases how you log information, and what information you log may have significant security and privacy implications. It is important to make sure you are not violating <a href="https://gdpr.eu/">GDPR</a>, <a href="https://oag.ca.gov/privacy/ccpa">California's Consumer Privacy Act</a>, or your own privacy policy before creating and storing logs.</span> AWS CloudWatch allows you to store up to 5GB of logs per month completely free. If the data you are logging is small this can go a long way (for example, if all of your logs were 480 bytes on average, you could generate approximately 10 million logs). If your site grows rapidly or the size of your log messages is too large, the costs could grow quickly.</p><p>In the <code class="language-text">terraform</code> folder create a new file called <code class="language-text">logging.tf</code>:</p><div class="gatsby-highlight" data-language="ruby"><pre class="language-ruby"><code class="language-ruby">resource <span class="token string">"aws_cloudwatch_log_group"</span> <span class="token string">"site_log_group"</span> <span class="token punctuation">{</span>
  name              <span class="token operator">=</span> <span class="token string">"Site"</span>
  retention_in_days <span class="token operator">=</span> <span class="token number">5</span>
<span class="token punctuation">}</span>

resource <span class="token string">"aws_iam_policy"</span> <span class="token string">"site_log_policy"</span> <span class="token punctuation">{</span>
  name <span class="token operator">=</span> <span class="token string">"site_log_policy"</span>
  path <span class="token operator">=</span> <span class="token string">"/"</span>

  policy <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&lt;</span><span class="token constant">EOF</span>
<span class="token punctuation">{</span>
  <span class="token string">"Version"</span><span class="token punctuation">:</span> <span class="token string">"2012-10-17"</span><span class="token punctuation">,</span>
  <span class="token string">"Statement"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token string">"Action"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token string">"logs:CreateLogGroup"</span><span class="token punctuation">,</span>
        <span class="token string">"logs:CreateLogStream"</span><span class="token punctuation">,</span>
        <span class="token string">"logs:PutLogEvents"</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token string">"Resource"</span><span class="token punctuation">:</span> <span class="token string">"arn:aws:logs:${var.region}:*:*"</span><span class="token punctuation">,</span>
      <span class="token string">"Effect"</span><span class="token punctuation">:</span> <span class="token string">"Allow"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
<span class="token constant">EOF</span>
<span class="token punctuation">}</span>

resource <span class="token string">"aws_iam_role_policy_attachment"</span> <span class="token string">"site_lambda_function_log_policy_attachment"</span> <span class="token punctuation">{</span>
  role       <span class="token operator">=</span> aws_iam_role<span class="token punctuation">.</span>site_lambda_function_role<span class="token punctuation">.</span>name
  policy_arn <span class="token operator">=</span> aws_iam_policy<span class="token punctuation">.</span>site_log_policy<span class="token punctuation">.</span>arn
<span class="token punctuation">}</span></code></pre></div><p>We’ve declared a new log group called <code class="language-text">Site</code>. The retention is very low (<code class="language-text">5</code> days) to increase our capacity without increasing our cost. However, this means older logs will be automatically deleted. You might want to choose a longer (or even shorter) retention period based on the use cases of your website. We also declared a policy to allow log creation and attached it to our Lambda role. This will allow logs generated by our function to automatically persist to CloudWatch.</p><p>Let’s check the plan:</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">terraform plan</code></pre></div><p>And apply it:</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">terraform apply</code></pre></div><p>Once you’ve applied the configuration you can log into the <a href="https://console.aws.amazon.com/cloudwatch/">AWS console to view the logs</a>.</p></section>
<section><h2 id="outputs" style="position:relative;"><a href="#outputs" aria-label="outputs permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Outputs</h2><blockquote>
<p>This section is optional</p>
</blockquote><p>Often, you’ll need to know specific identifiers, URLs, and parameters that are attached to the resources created by Terraform. It’s possible find these by reading the output of the various <code class="language-text">terraform apply</code> commands or by showing the state for a resource:</p><div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">terraform state show aws_route53_record.domain_nameservers</code></pre></div><p>Alternatively, you could log into the AWS console and find the necessary information there.</p><p>Terraform offers a third way: declaring outputs.In the <code class="language-text">terraform</code> directory, create a new file called <code class="language-text">outputs.tf</code>:</p><div class="gatsby-highlight" data-language="ruby"><pre class="language-ruby"><code class="language-ruby">output <span class="token string">"user_pool_id"</span> <span class="token punctuation">{</span>
  value <span class="token operator">=</span> aws_cognito_user_pool<span class="token punctuation">.</span>users<span class="token punctuation">.</span>id
<span class="token punctuation">}</span>

output <span class="token string">"user_pool_web_client_id"</span> <span class="token punctuation">{</span>
  value <span class="token operator">=</span> aws_cognito_user_pool_client<span class="token punctuation">.</span>users_client<span class="token punctuation">.</span>id
<span class="token punctuation">}</span>

output <span class="token string">"identity_pool_id"</span> <span class="token punctuation">{</span>
  value <span class="token operator">=</span> aws_cognito_identity_pool<span class="token punctuation">.</span>identities<span class="token punctuation">.</span>id
<span class="token punctuation">}</span></code></pre></div><p>Here we’ve added three outputs (which will be very useful when we connect our website to our API). The values for these outputs will be printed at the end of each <code class="language-text">terraform apply</code> that we run. However, if you only want to see these outputs and don’t need to apply any configuration changes, just run:</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">terraform output</code></pre></div><h1 id="were-done" style="position:relative;"><a href="#were-done" aria-label="were done permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>We’re done</h1><p>With this setup we can make an incredible number of sites. Each site using this setup is only costing us $0.50 per month. For most use cases the cost should remain fixed up to 10,000 users - and when it does increase it will grow as the scale grows. In most cases we don’t need to worry about going viral - we’ve built everything here to be able to handle a large number of requests and users. Additionally we’ve pushed as much as possible to the edge to make our site fast and responsive. We’ve even considered what will happen when multiple developers are working on the site.</p><p>But even after all of this setup we don’t really have a website or a real API. How can we say that we’re done? Building an API that runs on AWS Lamda and is integrated with our infrastructure has its own set of challenges. Building and deploying a static website that integrates with the API (and all of our infrastructure) does as well.</p><ul>
<li>Coming soon: <em>Using Express to build an API on AWS</em></li>
<li>Coming soon: <em>Using Gatsby to build a site AWS</em></li>
</ul><h1 id="bonus-user-registration-and-login-callbacks" style="position:relative;"><a href="#bonus-user-registration-and-login-callbacks" aria-label="bonus user registration and login callbacks permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Bonus: User registration and login callbacks</h1><p>It’s possible to supercharge Cognito by connecting it to custom Lambda functions. You can respond to <a href="https://www.terraform.io/docs/providers/aws/r/cognito_user_pool.html#lambda-configuration">several event triggers</a> such as:</p><ul>
<li><code class="language-text">create_auth_challenge</code> - The ARN of the lambda creating an authentication challenge.</li>
<li><code class="language-text">custom_message</code> - A custom Message AWS Lambda trigger.</li>
<li><code class="language-text">define_auth_challenge</code> - Defines the authentication challenge.</li>
<li><code class="language-text">post_authentication</code> - A post-authentication AWS Lambda trigger.</li>
<li><code class="language-text">post_confirmation</code> - A post-confirmation AWS Lambda trigger.</li>
<li><code class="language-text">pre_authentication</code> - A pre-authentication AWS Lambda trigger.</li>
<li><code class="language-text">pre_sign_up</code> - A pre-registration AWS Lambda trigger.</li>
<li><code class="language-text">pre_token_generation</code> - Allow to customize identity token claims before token generation.</li>
<li><code class="language-text">user_migration</code> - The user migration Lambda config type.</li>
<li><code class="language-text">verify_auth_challenge_response</code> - Verifies the authentication challenge response.</li>
</ul><p>These are set within the User Pool configuration in <code class="language-text">users.tf</code>. They can all point to the same Lambda function or different ones; they can even point to our existing lambda function. By default, Cognito cannot invoke AWS Lambda functions; you’ll need to add the following to <code class="language-text">api.tf</code>:</p><div class="gatsby-highlight" data-language="ruby"><pre class="language-ruby"><code class="language-ruby">resource <span class="token string">"aws_lambda_permission"</span> <span class="token string">"cognito"</span> <span class="token punctuation">{</span>
  principal     <span class="token operator">=</span> <span class="token string">"cognito-idp.amazonaws.com"</span>
  action        <span class="token operator">=</span> <span class="token string">"lambda:InvokeFunction"</span>
  function_name <span class="token operator">=</span> aws_lambda_function<span class="token punctuation">.</span>site_lambda_function<span class="token punctuation">.</span>arn

  <span class="token comment"># Grant access from the cognito users pool for internal cognito registration callbacks</span>
  source_arn <span class="token operator">=</span> aws_cognito_user_pool<span class="token punctuation">.</span>users<span class="token punctuation">.</span>arn
<span class="token punctuation">}</span></code></pre></div><h1 id="appendix" style="position:relative;"><a href="#appendix" aria-label="appendix permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Appendix</h1></section>
<section><h2 id="error-setting-up-the-remote-backend" style="position:relative;"><a href="#error-setting-up-the-remote-backend" aria-label="error setting up the remote backend permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Error setting up the remote backend</h2><p>Sometimes when setting up the state bucket the permissions are too restrictive. You may see an error:</p><div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">Initializing the backend...
Error inspecting states in the &quot;s3&quot; backend:
    AccessDenied: Access Denied
	status code: 403, request id: ABCDEF123456789, host id: ABCDEF123456789/ABCDEF123456789+ABCDEF123456789=

Prior to changing backends, Terraform inspects the source and destination
states to determine what kind of migration steps need to be taken, if any.
Terraform failed to load the states. The data in both the source and the
destination remain unmodified. Please resolve the above error and try again.</code></pre></div><p>Why did we get a permission error? We just created the bucket; shouldn’t we be able to see the contents? Actually, we shouldn’t. We set the access control (<code class="language-text">acl</code>) of the bucket to <code class="language-text">private</code> and haven’t told AWS that we should be able to see the private resources. In modern versions of Terraform this access is automatically available.</p><p>There are several ways to grant access to our user, including using Terraform itself. For state management, however I prefer to grant access through the <a href="https://console.aws.amazon.com/iam">IAM console</a>. Controlling state access through roles allows us to grant access to the state of each resource for specific groups of users.</p><p>Click on the <strong>Policies</strong> link on the sidebar then click <strong>Create policy</strong>:</p><p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 127px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/46d0177cbaf626cf8ae2ffc4e391e7fa/a9af1/iam-create-policy.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 33.07086614173229%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsSAAALEgHS3X78AAABx0lEQVQoz32Mz0uTcRzHn5M6q8M8tFuEFSax/IFU/4IHb12iYD8ipUbRjE5Glss5tWwltRIKOggaUQRNt6lTcS7UlQ6Fsln7Ps80hSDKSiVXr77Pswq6dHjx/sXno2x8/8HntU2+rGf5upE1VGd1/V+/+p9eR/+xmf2JUn1jHqsvQ0Wrxj5vhnKpFa0qlVLLfSplkso2zdh19N7aorHfl9v1XNWuUXJFw/NUoOy9MMOORhWrV1Dd+Y4Sj2BXkyo7QWmzfNiS87ub0hJh+ENXVaraBHs8GsWXhLxJY2kQnLj3CsXaMEHRuTnOdqfoeJLE/2yeh+OC3niGnjHBUPI9neE0R7pS9I5rdAQX6Ess8vi5xuWeJHeHVA42z2Kun+Pk/VmUYvcI5jMJDlyM47oTp8YX42j7AO7bg9j9o5wOjHLYG+ZYIEnjgxi268PU3orhuDmG0x/l2qMEO89PsMU1hSPwAqXUHcZcF5UMYrIF2Xp8gEJnhDxbCJM9RL6tH5MjgqUuRKE9SIEjTIG9n3y5bXOG2F7bh+VUVPYRXF2TKG+XPjL5eonp1DIzCys5/e3/InPizTLTRv6zyZxaMfqXkin548Onb/wCNNWZ8+KqWgQAAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="Create policy button"
        title="Create policy button"
        src="/static/46d0177cbaf626cf8ae2ffc4e391e7fa/a9af1/iam-create-policy.png"
        srcset="/static/46d0177cbaf626cf8ae2ffc4e391e7fa/a9af1/iam-create-policy.png 127w"
        sizes="(max-width: 127px) 100vw, 127px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
      />
  </a>
    </span></p><p>Next, click on the <strong>JSON</strong> tab and enter the following (changing <code class="language-text">example-state</code> to the name
of the S3 bucket created previously):</p><div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">{
  &quot;Version&quot;: &quot;2012-10-17&quot;,
  &quot;Statement&quot;: [
    {
      &quot;Effect&quot;: &quot;Allow&quot;,
      &quot;Action&quot;: &quot;s3:ListBucket&quot;,
      &quot;Resource&quot;: &quot;arn:aws:s3:::example-state&quot;
    },
    {
      &quot;Effect&quot;: &quot;Allow&quot;,
      &quot;Action&quot;: [&quot;s3:GetObject&quot;, &quot;s3:PutObject&quot;],
      &quot;Resource&quot;: &quot;arn:aws:s3:::example-state/*&quot;
    }
  ]
}</code></pre></div><p>This policy is very permissive and grants access to all files in the state bucket. This is fine for now; we can add more specific controls later if we want more granular access. Click <strong>Review Policy</strong> and name the policy <code class="language-text">terraform_state_access_policy</code>. Then clicked <strong>Create Policy</strong>.</p><p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1235px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/49b3c408818fa52a85d17cd01cd0265d/7e11a/iam-create-state-policy.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 53.75%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsSAAALEgHS3X78AAABXklEQVQoz5VSy3KDMAzk/7+j935Fj82llzQzTQkkgeFVwsO8bLZeEdMc0nTqmcVClqXVWl7XdajrGk3TwBiDeZ7vAr/4CcNzzNh8lvDatkVVVRiGAbeLIeYaLDAL5geJ1aDhkSHZEUWlEKUl4vyCtGxQqUlQdxpNb9AORgo9Wh4/bLUsS9Q2KdG2Cq1SULaYUp2wJ0v9QBLXuieGDdRarxpyF1x95o9EtxCGNJiQ7VNTRXYWfd+jt+zo57kr6mx9U9D9rwmpYZZlSJJUXp0SFHkue5IkOJ1OOB6PCMMQ5/NZQF8QBDgcDmLHcby0LGNhVxTFeN/tJODDD7B528IPQmRpiqIo5BLPaOe2WGr9+/0evu+LXRRfC0M3KOOkMU2TYBhGXOrlkdg61ziO63g5rRn7M2hWQ9f7vUFeS10vr6+56raASTlSHC2P2lF0d/E/YJLadpGkGZ5fEzy9RPgGJF5Z8twGqgQAAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="Create state policy"
        title="Create state policy"
        src="/static/49b3c408818fa52a85d17cd01cd0265d/7e11a/iam-create-state-policy.png"
        srcset="/static/49b3c408818fa52a85d17cd01cd0265d/72799/iam-create-state-policy.png 320w,
/static/49b3c408818fa52a85d17cd01cd0265d/6af66/iam-create-state-policy.png 640w,
/static/49b3c408818fa52a85d17cd01cd0265d/7e11a/iam-create-state-policy.png 1235w"
        sizes="(max-width: 1235px) 100vw, 1235px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
      />
  </a>
    </span></p><p>After creating the policy, you’ll need to attach it to the programmatic user you created earlier. Find the user in the Users section and click <strong>Add Permissions</strong> and select the new policy:</p><p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1280px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/a8ccaa6d9b32c6d746709e518b5fa22f/0931d/iam-add-permissions.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 30%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsSAAALEgHS3X78AAAA/klEQVQY042Q227DIBBE/f+f1Q/oW9VWVWwnMb6AwRfAYLA9BRI/NQ8d6WhZaZkdbSalxDRNmOcZxhgopeC9xysdx/GHPRD1SSRGZZFRStE0DWLVWifmsCQuGmcFqRfY1cFv20vDE7/t2PcDWTQTQsBai2VZUNc1GGMwi8bbl8D7pcdPq9BODv9R1rQUbUfhnYNbV6zBeEtpdiizhoQW2jgY6x4zT+JZ/LPGPgYaBoHsSjp8fOfIixKkboJ5Bx4SczGkM8TEJ+SE1CjLKypCwr8Ct9sdlzxPZGxc0HCJop1Q9Qqxp6NOxDebTOCsD/pA1QncW46ajWmOSws+W/wC+ZzMsbsEV/sAAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="Add permissions"
        title="Add permissions"
        src="/static/a8ccaa6d9b32c6d746709e518b5fa22f/21b4d/iam-add-permissions.png"
        srcset="/static/a8ccaa6d9b32c6d746709e518b5fa22f/72799/iam-add-permissions.png 320w,
/static/a8ccaa6d9b32c6d746709e518b5fa22f/6af66/iam-add-permissions.png 640w,
/static/a8ccaa6d9b32c6d746709e518b5fa22f/21b4d/iam-add-permissions.png 1280w,
/static/a8ccaa6d9b32c6d746709e518b5fa22f/0931d/iam-add-permissions.png 1373w"
        sizes="(max-width: 1280px) 100vw, 1280px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
      />
  </a>
    </span></p><p>Click <strong>Next: Review</strong> and then <strong>Add permissions</strong>.</p><p>With those permissions in place we can try running the initialization again:</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">terraform init</code></pre></div><p>Terraform should recognize that we are changing the backend and offer to copy our state; at the prompt type <code class="language-text">yes</code>:</p><div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">Initializing the backend...
Do you want to copy existing state to the new backend?
  Pre-existing state was found while migrating the previous &quot;local&quot; backend to the
  newly configured &quot;s3&quot; backend. No existing state was found in the newly
  configured &quot;s3&quot; backend. Do you want to copy this state to the new &quot;s3&quot;
  backend? Enter &quot;yes&quot; to copy and &quot;no&quot; to start with an empty state.

  Enter a value: yes


Successfully configured the backend &quot;s3&quot;! Terraform will automatically
use this backend unless the backend configuration changes.

Initializing provider plugins...

The following providers do not have any version constraints in configuration,
so the latest version was installed.

To prevent automatic upgrades to new major versions that may contain breaking
changes, it is recommended to add version = &quot;...&quot; constraints to the
corresponding provider blocks in configuration, with the constraint strings
suggested below.

* provider.aws: version = &quot;~&gt; 2.42&quot;

Terraform has been successfully initialized!

You may now begin working with Terraform. Try running &quot;terraform plan&quot; to see
any changes that are required for your infrastructure. All Terraform commands
should now work.

If you ever set or change modules or backend configuration for Terraform,
rerun this command to reinitialize your working directory. If you forget, other
commands will detect it and remind you to do so if necessary.</code></pre></div></section></div><hr/><h2>Comments</h2><div class="sc-ifAKCX ddlDEo github"><div><p>Thanks for reading ❤️ – comment by replying to the <a href="https://github.com/jeffrafter/jeffrafter.github.io/issues/16">issue for this post</a>.<!-- --> <!-- -->There’s no comments yet; you could be the first.<br/></p></div><div class="sc-gzVnrw bOnSNx"><a href="https://github.com/jeffrafter/jeffrafter.github.io/issues/16#new_comment_field" target="_blank" rel="noreferrer noopener" class="button btn">Add a comment →</a></div></div><hr/><h2>There’s more to read</h2><div><p><em>Looking for more long-form posts? Here ya go...</em></p></div><ul class="sc-htoDjs gXLbcD"><li><a rel="prev" href="/unity-and-github/">← <!-- -->Working with Unity and GitHub</a></li><li><a rel="next" href="/express-and-aws/">Exploring - Using Express and Amazon Web Services<!-- --> →</a></li></ul></div></article></main><footer class="sc-bwzfXH aCPwf footer">© <!-- -->2025<!-- -->,<!-- --> <a href="https://jeffrafter.com">jeffrafter.com</a>. Built with<!-- --> <a href="https://www.gatsbyjs.org">Gatsby</a></footer></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script>
  
  
  if(true) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  }
  if (typeof ga === "function") {
    ga('create', 'UA-61511214-2', 'auto', {});
      
      
      
      
      
      }</script><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/terraform-and-aws/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-51d0929071629bddce45.js"],"component---src-pages-404-tsx":["/component---src-pages-404-tsx-c709285770c005682b82.js"],"component---src-pages-about-tsx":["/component---src-pages-about-tsx-62b9eaa39bf8729ce54a.js"],"component---src-pages-index-tsx":["/component---src-pages-index-tsx-8c0fa96d2b2e2db049f0.js"],"component---src-pages-measure-tsx":["/component---src-pages-measure-tsx-f9b00c06792bc626e6da.js"],"component---src-pages-tags-tsx":["/component---src-pages-tags-tsx-7578574f5e2dead3e222.js"],"component---src-templates-post-tsx":["/component---src-templates-post-tsx-7133ab7322325c379163.js"],"component---src-templates-tag-tsx":["/component---src-templates-tag-tsx-b66b8eb25d0cb13a4d3b.js"]};/*]]>*/</script><script src="/component---src-templates-post-tsx-7133ab7322325c379163.js" async=""></script><script src="/109cf451cc5d7f6d2abc8e688d09142e78350594-53a6b222a8910dfb5d1b.js" async=""></script><script src="/commons-6458b952aa116f5f11f8.js" async=""></script><script src="/app-51d0929071629bddce45.js" async=""></script><script src="/styles-24c541b6ac347bae38f1.js" async=""></script><script src="/framework-95b680cb3190aa9bfe59.js" async=""></script><script src="/webpack-runtime-e2dd2bd4ceef3b18c316.js" async=""></script></body></html>